{"pages":[{"title":"å…³äºæˆ‘","text":"è¿™é‡Œæ˜¯donâ€™t want just so soçš„zhaommmmomo å¤§å››Javaæ¸£ğŸ•ï¼Œå‡†å¤‡å­¦C++ è‡ªé©±èƒ½åŠ›å¼ºï¼Œç»å¸¸å»äº†è§£æœ€æ–°çš„æŠ€æœ¯å’Œå‚åŠ ä¸­é—´ä»¶æ¯”èµ›ğŸ¤“ å–œæ¬¢æ€§èƒ½ä¼˜åŒ–ã€åˆ†å¸ƒå¼ç›¸å…³ï¼Œæƒ³åšåŸºç¡€æ¶æ„ğŸ±â€ğŸ çˆ±å¥½é€»è¾‘æ¨ç†ï¼ˆå‰§æœ¬æ€ğŸ“•ã€ç‹¼äººæ€ğŸºã€å¯†å®¤é€ƒè„±ğŸƒâ€â™‚ï¸ï¼‰ æœŸå¾…VRï¼ï¼ï¼âœ¨","link":"/about/index.html"},{"title":"zhaommmmomoä¸ªäººç®€å†","text":"è”ç³»æ–¹å¼ Emailï¼šzmm@zhaommmmomo.cn WeChatï¼šzhaommmmomo ä¸ªäººä¿¡æ¯ å±±ä¸œå·¥å•†å­¦é™¢ Â· è½¯ä»¶å·¥ç¨‹ Â· æœ¬ç§‘ ï¼ˆ2018 ~ 2022ï¼‰ æŠ€æœ¯åšå®¢ï¼šzhaommmmomo.cn Githubï¼šgithub.com/zhaommmmomo æœŸæœ›èŒä½ï¼šJavaå¼€å‘ã€ä¸­é—´ä»¶å¼€å‘ æœŸæœ›åŸå¸‚ï¼šæ·±åœ³ å…³äºæˆ‘ è‡ªé©±èƒ½åŠ›è¾ƒå¼ºï¼Œèƒ½ä¸»åŠ¨å»å­¦ä¹ æ–°çš„æŠ€æœ¯å¹¶è½åœ°å®ç°ã€‚ä¾‹å¦‚ï¼šé€šè¿‡LSMæ ‘å®ç°ä¸€ä¸ªKVå­˜å‚¨å¼•æ“ã€é€šè¿‡Raftç®—æ³•å®ç°ä¸€ä¸ªé›†ç¾¤å…±è¯†æœåŠ¡ä»¥åŠå…¶ä»–ä¸€äº›ç®—æ³•æˆ–æ•°æ®ç»“æ„çš„å®ç°ï¼ˆSkipList / 2pc / 3pc / LRUï¼‰ æŒæ¡Javaï¼ˆJUCï¼‰ï¼Œå…·å¤‡è‰¯å¥½çš„ç¼–ç¨‹è§„èŒƒï¼Œå¹¶é˜…è¯»è¿‡éƒ¨åˆ†Javaæºç ã€‚äº†è§£C / Python èƒ½ç†Ÿç»ƒä½¿ç”¨Vertx / SSM / SpringBoot / Redis / MySQL / LevelDBç­‰Javaå¼€å‘ç›¸å…³æŠ€æœ¯æ ˆï¼Œçœ‹è¿‡Springéƒ¨åˆ†æºç ï¼Œäº†è§£SpringCloud / gRpc / Ignite / RabbitMQ / Nginxç­‰ äº†è§£Linux Kernerï¼ˆç½‘ç»œç›¸å…³ï¼‰ï¼Œé˜…è¯»è¿‡å…¶TCPä¸‰æ¬¡æ¡æ‰‹å’Œç½‘ç»œåŒ…æ”¶å‘çš„å®ç° ç†Ÿæ‚‰è®¡ç®—æœºç½‘ç»œ / æ“ä½œç³»ç»Ÿ / æ•°æ®ç»“æ„ä¸ç®—æ³• / è®¾è®¡æ¨¡å¼ / è®¡ç®—æœºç»„æˆåŸç†ç­‰csåŸºç¡€çŸ¥è¯†ã€‚äº†è§£è¿‡TCPçš„BBRæ‹¥å¡æ§åˆ¶ç®—æ³•ã€‚ äº†è§£åˆ†å¸ƒå¼ç³»ç»Ÿ / ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ– / å¾®æœåŠ¡ç›¸å…³å†…å®¹å¹¶èƒ½ç†Ÿç»ƒä½¿ç”¨Jmeter / wrk / Postman / Jprofilerç­‰å·¥å…· å‚åŠ è¿‡å¤šæ¬¡ä¸­é—´ä»¶å¼€å‘æ¯”èµ›ï¼ˆé˜¿é‡Œï¼‰å¹¶ä¸”æ’åéƒ½åœ¨å‰1% é¡¹ç›®ç»éªŒ2021.07 ~ 2021.09 åˆ†å¸ƒå¼èŠå¤©å®¤ ä¸ªäºº å·¥ä½œæˆæœï¼š ç³»ç»Ÿéƒ¨ç½²åœ¨ä¸‰å°ECSæœåŠ¡å™¨ä¸Šï¼Œéœ€è¦å°†å„ä¸ªèŠ‚ç‚¹è”ç³»èµ·æ¥ï¼Œå¸¸è§çš„æœåŠ¡å‘ç°æœºåˆ¶ä¸è¶³ä»¥æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ï¼Œæœ€åé€šè¿‡åœ¨Igniteä¸Šæ‰©å±•è‡ªå®šä¹‰æœåŠ¡å‘ç°æœºåˆ¶æ¥è§£å†³è¯¥é—®é¢˜ å½“ç”¨æˆ·å‘é€ä¸€æ¡æ¶ˆæ¯çš„æ—¶å€™ï¼Œä¼šå‡ºç°é›†ç¾¤æ¶ˆæ¯åŒæ­¥ä»¥åŠæ¶ˆæ¯ä¸€è‡´æ€§é—®é¢˜ï¼Œå½“æ—¶è€ƒè™‘äº†4ä¸ªæ–¹æ¡ˆï¼šRedisã€Hazelastã€Igniteä»¥åŠè‡ªå·±å®ç°åˆ†å¸ƒå¼ç¼“å­˜ã€‚æœ€åä»ç³»ç»Ÿæ€§èƒ½ä»¥åŠå®ç°å¤æ‚ç¨‹åº¦ç­‰æ–¹é¢è€ƒè™‘ï¼Œä½¿ç”¨äº†Igniteçš„æ–¹æ¡ˆæ¥è§£å†³æ­¤é—®é¢˜ã€‚ ç³»ç»Ÿåœ¨è¿›è¡Œæ€§èƒ½æµ‹è¯•çš„æ—¶å€™å‘ç°å‡ºç°è¿æ¥è¶…æ—¶çš„æƒ…å†µï¼Œåˆ†ææ˜¯æŒä¹…åŒ–ç£ç›˜IOå¯¼è‡´çš„ï¼Œé€šè¿‡ä¿®æ”¹å­˜å‚¨æ–¹å¼ä¸ºLevelDBä»¥åŠå°†ç³»ç»Ÿå…¨èŠ‚ç‚¹æ¶ˆæ¯åŒæ­¥è¿”å›æ”¹ä¸ºå¤šæ•°èŠ‚ç‚¹æ¶ˆæ¯åŒæ­¥è¿”å›è§£å†³äº†æ­¤é—®é¢˜ã€‚ 2021.03 ~ 2021.05 ç§’æ€ç³»ç»Ÿ ä¸ªäºº å·¥ä½œæˆæœï¼š ç”¨æˆ·æ¯æ¬¡è®¿é—®ç§’æ€å•†å“åŠ è½½è¿‡ç¨‹ä¼šå¾ˆæ…¢ï¼Œé€šè¿‡å¼•å…¥ç¼“å­˜æŠ€æœ¯ï¼Œæé«˜äº†ç”¨æˆ·è®¿é—®æ—¶ç•Œé¢åŠ è½½çš„é€Ÿåº¦ã€‚ ç”±äºæ¯æ¬¡ç§’æ€æ“ä½œç³»ç»Ÿéƒ½ä¼šç»å†å¾ˆé•¿çš„æ—¶é—´ï¼Œé€šè¿‡ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†ï¼Œä½¿ç”¨æˆ·ä½“éªŒå˜å¾—æ›´å¥½ åœ¨ç§’æ€å¼€å§‹çš„æ—¶å€™ï¼Œç”¨æˆ·é¢‘ç¹çš„ç‚¹å‡»è´­ä¹°æŒ‰é’®ï¼Œé€ æˆå¤§é‡çš„è¯·æ±‚ï¼Œæˆ‘é€šè¿‡å°†å‰ç«¯è´­ä¹°æŒ‰é’®ç‚¹å‡»åç½®ç°ä»¥åŠåç«¯é™åˆ¶ç›¸åŒipæ¯ç§’çš„è®¿é—®æ¬¡æ•°ï¼Œå¤§é‡çš„å‡å°‘äº†ç³»ç»Ÿçš„å‹åŠ›ã€‚ 2020.12 ~ 2021.01 æœé¢˜åº“ ç»„é•¿ å·¥ä½œå†…å®¹ï¼š è´Ÿè´£æ•´ä½“ç³»ç»Ÿçš„è®¾è®¡ è´Ÿè´£çˆ¬å–å¹¶å¤„ç†ä¸åŒç½‘ç«™ä¸Šçš„é¢˜åº“ è´Ÿè´£ç³»ç»Ÿæ ¸å¿ƒæœç´¢æ¨¡å— å·¥ä½œæˆæœï¼š é€šè¿‡è¿›è¡Œæ•°æ®é¢„å¤„ç†ç­‰æ‰‹æ®µï¼Œå°†ä¸åŒç½‘ç«™ä¸Šçˆ¬å–åˆ°çš„æ•°æ®æ ¼å¼è¿›è¡Œç»Ÿä¸€ï¼Œ ä½¿å¾—ç³»ç»Ÿé¢˜åº“æ•°é‡è¾¾åˆ°æ•°åä¸‡æ¡ é€šè¿‡å¼•å…¥ESæœç´¢å¼•æ“ï¼Œä½¿å¾—ç³»ç»Ÿåœ¨æ•°åä¸‡æ¡æ•°æ®ä¸­æŸ¥è¯¢çš„é€Ÿåº¦ä¸ºæ¯«ç§’çº§ã€‚","link":"/resume/index.html"},{"title":"ä¹¦æ¶","text":"ç½‘ç›˜é“¾æ¥çš„å¯†ç éƒ½æ˜¯0000 Reading ç†è§£äº†å†è°ˆç½‘ç»œæ€§èƒ½ ä¸‰ä½“ Linuxé«˜æ€§èƒ½ç¼–ç¨‹ Redisè®¾è®¡ä¸å®ç° Effective Javaï¼ˆç¬¬ä¸‰ç‰ˆï¼‰ å‡¤å‡°æ¶æ„ Good Designing Data-Intensive Applications æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº Javaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ åˆ†å¸ƒå¼ç³»ç»Ÿæ¦‚å¿µä¸è®¾è®¡ï¼ˆç¬¬äº”ç‰ˆï¼‰ æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ æ·±å…¥ç†è§£åˆ†å¸ƒå¼ç¼“å­˜ å‰‘æŒ‡offer ä¸­å°æ¶æ„ä¸å®ç° ç¼–ç¨‹ä¹‹ç¾ Readed Netty in action Javaæ€§èƒ½ä¼˜åŒ–æƒå¨æŒ‡å— TCP / IPè¯¦è§£ è®¾è®¡æ¨¡å¼å°±è¯¥è¿™æ ·å­¦ Spring5æ ¸å¿ƒåŸç†ä¸30ä¸ªç±»æ‰‹å†™å®æˆ˜ SpringCloudã€Nginxé«˜å¹¶å‘ç¼–ç¨‹ æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–å™¨çš„è‰ºæœ¯ ç¨‹åºå‘˜çš„ä¸‰é—¨è¯¾ ä»Paxosåˆ°Zookeeper åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µ","link":"/books/index.html"},{"title":"è®ºæ–‡","text":"LSM-Tree SkipList raftä¸­æ–‡ç‰ˆ / raftè‹±æ–‡ç‰ˆ WiscKey Chucky From WiscKey to Bourbon BBR Dostoevsky-LSM SlimDB SLM-DB Practical Hash Functions","link":"/paper/index.html"}],"posts":[{"title":"ArrayListåº•å±‚é€»è¾‘ä¸å®ç°","text":"é‡ç‚¹æ‰©å®¹è§„åˆ™ï¼šåº•å±‚æ˜¯System.arraycopy()è¿™ä¸ªæ–¹æ³• æ¯æ¬¡æ‰©å®¹éƒ½æ˜¯å°†æ–°å®¹é‡è®¾ç½®ä¸º1.5 * æ—§å®¹é‡ æ–°å®¹é‡å¦‚æœå°äºéœ€è¦çš„å®¹é‡ï¼Œå°†æ–°å®¹é‡è®¾ç½®ä¸ºéœ€è¦çš„å®¹é‡ æ–°å®¹é‡å¦‚æœå¤§äºå¯ä»¥åˆ†é…çš„æœ€å¤§å®¹é‡ï¼ˆæ•´å‹æœ€å¤§å€¼ - 8ï¼‰ï¼Œæ–°å®¹é‡è®¾ç½®ä¸ºï¼ˆéœ€è¦çš„å®¹é‡å°äºæœ€å¤§åˆ†é…å®¹é‡ï¼‰éœ€è¦çš„å®¹é‡æˆ–è€…è®¾ç½®ä¸ºï¼ˆéœ€è¦çš„å®¹é‡å¤§äºæœ€å¤§åˆ†é…å®¹é‡ï¼‰æ•´å‹æœ€å¤§å€¼ æ‡’åŠ è½½æœºåˆ¶ï¼šArrayListåˆå§‹åŒ–çš„æ—¶å€™å¹¶æ²¡æœ‰ç›´æ¥ç»™æ•°ç»„åˆ†é…å®¹é‡ï¼Œè€Œæ˜¯ä½¿ç”¨çš„ä¸€ä¸ªç©ºæ•°ç»„è¿›è¡Œèµ‹å€¼ï¼Œåªæœ‰å½“ç¬¬ä¸€æ¬¡å¢åŠ çš„æ—¶å€™æ‰ä¼šçœŸæ­£çš„ç»™æ•°ç»„è¿›è¡Œå®¹é‡åˆ†é…ã€‚è¿™æ ·æ˜¯ä¸ºäº†é˜²æ­¢ç”¨æˆ·åˆå§‹åŒ–åæ²¡æœ‰è¿›è¡Œä½¿ç”¨å¯¼è‡´å†…å­˜çš„æµªè´¹ã€‚ï¼ˆåªæœ‰ç”¨æˆ·è°ƒç”¨æ— å‚æ„é€ æ–¹æ³•çš„æ—¶å€™æ‰æ˜¯æ‡’åŠ è½½ï¼Œå…¶ä»–ä¸¤ä¸ªæ„é€ å‡½æ•°æ˜¯åˆ†é…çš„å¦å¤–ä¸€ä¸ªç©ºæ•°ç»„ï¼‰ å±æ€§1234567891011121314// é»˜è®¤åˆå§‹å®¹é‡private static final int DEFAULT_CAPACITY = 10;// ç”¨æ¥è¡¨ç¤ºå½“ç”¨æˆ·è¾“å…¥åˆå§‹å®¹é‡ä¸º0æ—¶çš„æ•°ç»„private static final Object[] EMPTY_ELEMENTDATA = {};// ç”¨æ¥è¡¨ç¤ºæ˜¯æ‡’åŠ è½½çš„æ•°ç»„ï¼Œä¸EMPTY_ELEMENTDATAåšåŒºåˆ†private static final Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = {};// ç”¨æ¥å­˜å‚¨å…ƒç´ transient Object[] elementData;// ç”¨æ¥è®°å½•å·²ç»å­˜å‚¨äº†çš„å…ƒç´ æ•°é‡private int size; æ„é€ æ–¹æ³•æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç»å¸¸ç”¨çš„List&lt;Integer&gt; arr = new ArrayList&lt;&gt;()ï¼Œå¹¶æ²¡æœ‰ä¸€å¼€å§‹ç»™æˆ‘ä»¬åˆå§‹åŒ–ä¸ºé»˜è®¤çš„10å®¹é‡ï¼Œè€Œæ˜¯å…ˆèµ‹å€¼çš„æ˜¯ä¸€ä¸ªç©ºæ•°ç»„ã€‚è¿™é‡Œå…¶å®å°±æ˜¯æ‡’åŠ è½½çš„å¼€å§‹ï¼Œ 123456789101112131415161718192021public ArrayList() { // ä½¿ç”¨çš„æ˜¯æ‡’åŠ è½½çš„ç©ºæ•°ç»„ this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;}public ArrayList(int initialCapacity) { ...... if (initialCapacity == 0) { // ä½¿ç”¨çš„æ˜¯éæ‡’åŠ è½½çš„ç©ºæ•°ç»„ this.elementData = EMPTY_ELEMENTDATA; } ......}public ArrayList(Collection&lt;? extends E&gt; c) { ...... if (size == 0) // ä½¿ç”¨çš„æ˜¯éæ‡’åŠ è½½çš„ç©ºæ•°ç»„ elementData = EMPTY_ELEMENTDATA; }} é‡è¦æ–¹æ³•add()123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354public boolean add(E e) { // ç”¨æ¥ç¡®å®šæ˜¯å¦éœ€è¦æ‰©å®¹ ensureCapacityInternal(size + 1); elementData[size++] = e; return true;}private void ensureCapacityInternal(int minCapacity) { ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));}/** * å®ç°æ‡’åŠ è½½çš„æ–¹æ³• */private static int calculateCapacity(Object[] elementData, int minCapacity) { // åˆ¤æ–­å½“å‰æ•°ç»„æ˜¯å¦æ˜¯æ‡’åŠ è½½çš„æ•°ç»„ if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) { // å¦‚æœæ˜¯çš„è¯è¿”å›max(é»˜è®¤åˆå§‹å®¹é‡ï¼Œéœ€è¦çš„å®¹é‡) return Math.max(DEFAULT_CAPACITY, minCapacity); } // å¦‚æœä¸æ˜¯ç›´æ¥è¿”å›éœ€è¦çš„å®¹é‡ return minCapacity;}private void ensureExplicitCapacity(int minCapacity) { // ç”¨äºè®°å½•æ“ä½œæ•°é‡ modCount++; // å¦‚æœéœ€è¦çš„å®¹é‡å°äºæ•°ç»„å®¹é‡ï¼Œè¿›è¡Œæ‰©å®¹ if (minCapacity - elementData.length &gt; 0) grow(minCapacity);}/** * æ‰©å®¹å‡½æ•° * æ¯æ¬¡åœ¨åŸæ¥åŸºç¡€ä¸Šä¸€åŠä¸€åŠçš„æ‰©å®¹ã€‚ * å¦‚æœæ–°å®¹é‡è¿˜æ˜¯å°äºéœ€è¦çš„å®¹é‡ï¼Œå°†æ–°å®¹é‡è®¾ä¸ºéœ€è¦çš„å®¹é‡ * å¦‚æœæ–°å®¹é‡å¤§äºæœ€å¤§åˆ†é…çš„å®¹é‡ï¼š * 1. éœ€è¦çš„å®¹é‡ä¹Ÿå¤§äºã€‚å°†æ–°å®¹é‡è®¾ç½®ä¸ºæ•´å‹çš„æœ€å¤§å€¼ * 2. éœ€è¦çš„å®¹é‡å°äºï¼Œå°†æ–°å®¹é‡ç›´æ¥è®¾ç½®ä¸ºéœ€è¦çš„å®¹é‡ */private void grow(int minCapacity) { int oldCapacity = elementData.length; // åœ¨è€å®¹é‡çš„åŸºç¡€ä¸Šå¢åŠ ä¸€åŠ int newCapacity = oldCapacity + (oldCapacity &gt;&gt; 1); if (newCapacity - minCapacity &lt; 0) newCapacity = minCapacity; if (newCapacity - MAX_ARRAY_SIZE &gt; 0) // è¿™é‡Œå°±æ˜¯åˆ¤æ–­éœ€è¦çš„å®¹é‡æ˜¯å¦å¤§äºå¯åˆ†é…å®¹é‡ // å¦‚æœå¤§äºå°±å°†æ–°å®¹é‡è®¾ç½®ä¸ºæ•´å‹çš„æœ€å¤§å€¼ // å¦‚æœå°äºå°±å°†æ–°å®¹é‡è®¾ç½®ä¸ºéœ€è¦çš„å®¹é‡ newCapacity = hugeCapacity(minCapacity); elementData = Arrays.copyOf(elementData, newCapacity);} ç®€æ˜“å®ç°123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139/** * @author zmm * @date 2021/11/11 15:12 */public class ArrList&lt;E&gt;{ /** * é»˜è®¤å®¹é‡å¤§å° */ private static final int DEFAULT_CAPACITY = 10; /** * è¦åˆ†é…çš„æœ€å¤§æ•°ç»„å¤§å° */ private static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8; /** * ç©ºçš„æ•°ç»„é›†åˆï¼Œç”¨äºæ‡’åŠ è½½ */ private static final Object[] EMPTY_ELEMENT_DATA = {}; /** * ç”¨æ¥è®°å½•å·²ç»å­˜æ”¾äº†çš„æ•°æ®ä¸ªæ•° */ private int size; /** * ç”¨æ¥å­˜æ”¾æ•°æ® */ private Object[] elementData; public ArrList() { // æ³¨æ„ï¼šè¿™é‡Œæ˜¯ç»™æ•°ç»„èµ‹å€¼çš„ç©ºæ•°ç»„ this.elementData = EMPTY_ELEMENT_DATA; } public ArrList(int initCapacity) { // è¿™é‡Œç›´æ¥å°±ç»™æ•°ç»„è¿›è¡Œäº†åˆå§‹åŒ– if (initCapacity &lt; 0){ throw new IllegalArgumentException(&quot;Illegal Capacity&quot;); } else if (initCapacity == 0){ this.elementData = EMPTY_ELEMENT_DATA; } else { this.elementData = new Object[initCapacity]; } } /** * æ·»åŠ ä¸€ä¸ªæ–°å…ƒç´  * @param e æ–°å…ƒç´  */ public void add(E e) { lazyLoad(); size++; if (size &gt; elementData.length) { grow(); } elementData[size] = e; } /** * åœ¨æŒ‡å®šä¸‹æ ‡å¤„æ·»åŠ å…ƒç´  * @param index ä¸‹æ ‡ * @param element å…ƒç´  */ public void add(int index, E element) { if (index &lt; 0 || index &gt; elementData.length) { throw new IllegalArgumentException(&quot;Illegal index&quot;); } lazyLoad(); size++; if (size &gt; elementData.length) { grow(); } // å°†åŸæ•°ç»„ä¸‹æ ‡åœ¨indexåŠä»¥åçš„æ‰€æœ‰å…ƒç´ å¤åˆ¶åˆ°ä»¥index + 1å¼€å§‹çš„ä¸‹æ ‡å¤„ System.arraycopy(elementData, index, elementData, index + 1, size - index - 1); elementData[index] = element; } /** * è·å–æŒ‡å®šä¸‹æ ‡å¤„çš„å…ƒç´  * @param index ä¸‹æ ‡ * @return æŒ‡å®šä¸‹æ ‡å¤„çš„å…ƒç´  */ @SuppressWarnings(&quot;unchecked&quot;) public E get(int index) { if (index &lt; 0 || index &gt; size){ throw new IllegalArgumentException(&quot;Illegal index&quot;); } return (E) elementData[index]; } /** * ä¿®æ”¹æŒ‡å®šä¸‹æ ‡å¤„çš„å…ƒç´  * @param index ä¸‹æ ‡ * @param element æ–°å…ƒç´  */ public void set(int index, E element) { if (index &lt; 0 || index &gt; size){ throw new IllegalArgumentException(&quot;Illegal index&quot;); } elementData[index] = element; } /** * æ‡’åŠ è½½æœºåˆ¶ * å½“è°ƒç”¨ç¬¬ä¸€æ¬¡æ·»åŠ çš„æ—¶å€™æ‰å¯¹æ•°ç»„è¿›è¡Œåˆå§‹åŒ–æ“ä½œ * å¦‚æœå½“ç±»åŠ è½½åç›´æ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œè€Œç”¨æˆ·æœªä½¿ç”¨ * è¿™æ ·å°±ä¼šå¯¼è‡´é¢å¤–çš„å†…å­˜æµªè´¹ * æ‰€ä»¥è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåˆšåˆå§‹åŒ–ArrayListï¼Œæ˜¾ç¤ºçš„å®¹é‡ä¸º0 * æ·»åŠ åå°±å˜æˆäº†10 */ private void lazyLoad() { if (size == 0){ this.elementData = new Object[DEFAULT_CAPACITY]; } } /** * æ‰©å®¹å‡½æ•° * æ¯æ¬¡åœ¨åŸæ¥åŸºç¡€ä¸Šä¸€åŠä¸€åŠçš„æ‰©å®¹ã€‚ * å¦‚æœæ–°å®¹é‡è¿˜æ˜¯å°äºéœ€è¦çš„å®¹é‡ï¼Œå°†æ–°å®¹é‡è®¾ä¸ºéœ€è¦çš„å®¹é‡ * å¦‚æœæ–°å®¹é‡å¤§äºæœ€å¤§åˆ†é…çš„å®¹é‡ï¼š * 1. éœ€è¦çš„å®¹é‡ä¹Ÿå¤§äºã€‚å°†æ–°å®¹é‡è®¾ç½®ä¸ºæ•´å‹çš„æœ€å¤§å€¼ * 2. éœ€è¦çš„å®¹é‡å°äºï¼Œå°†æ–°å®¹é‡ç›´æ¥è®¾ç½®ä¸ºéœ€è¦çš„å®¹é‡ */ private void grow() { int oldSize = elementData.length; int newSize = oldSize + (oldSize &gt;&gt; 1); if (newSize - size &lt; 0) { newSize = size; } if (newSize &gt; MAX_ARRAY_SIZE){ newSize = size &gt; MAX_ARRAY_SIZE ? Integer.MAX_VALUE : MAX_ARRAY_SIZE; } elementData = Arrays.copyOf(elementData, newSize); }}","link":"/2021/09/11/ArrayList%E5%BA%95%E5%B1%82%E9%80%BB%E8%BE%91%E4%B8%8E%E5%AE%9E%E7%8E%B0/"},{"title":"Icarusä¸»é¢˜çš„ä¸€äº›å¸¸ç”¨é…ç½®","text":"å¸¸è§çš„ä¸€äº›é…ç½®è§_config.icarus.ymlï¼Œè‹±æ–‡ä¸å·®éƒ½èƒ½çœ‹æ‡‚ï¼Œæˆ–è€…å»çœ‹icarusæ–‡æ¡£ã€‚æœ¬æ–‡ä¸»è¦å°±æ˜¯ä¸€äº›ç½‘ä¸Šå¾ˆå°‘çš„é…ç½®ã€‚ Icarus: 4.0.0 æ–‡ç« é¡µé¢ä¸¤æ å¸ƒå±€åœ¨_config.icarus.ymlç›®å½•ä¸‹ï¼Œåˆ›å»º_config.post.ymlæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å†…å®¹ä¸_config.icarus.ymlæ–‡ä»¶ä¸€æ ·ï¼Œç”¨äºå•ç‹¬åŠ è½½postç•Œé¢å¸ƒå±€ã€‚æ³¨æ„ï¼ŒåŒæ éœ€è¦å°†widgetså†…å®¹çš„positionéƒ½è®¾ç½®ä¸ºåŒä¸€è¾¹ã€‚ 12345678910111213141516171819202122232425262728# å•ç‹¬æ–‡ç« ç•Œé¢å¸ƒå±€widgets: # ä¸ªäººä¿¡æ¯ - position: left type: profile author: zhaommmmomo author_title: fahaxiki! location: Yantai,China avatar: /img/logo.jpg avatar_rounded: false follow_link: 'https://zhaommmmomo.cn' social_links: Github: icon: fab fa-github url: 'https://github.com/zhaommmmomo' # æ–‡ç« ç›®å½• - position: left type: toc # ç›®å½•åºå· index: true# ä¾§è¾¹æ æ˜¯å¦å›ºå®šsidebar: left: sticky: false right: sticky: false å¢åŠ ä¸¤æ å¸ƒå±€ä¸‹æ–‡ç« çš„å®½åº¦12345678910111213141516171819202122232425262728# layout/layout.jsxmodule.exports = class extends Component { render() { ...... &lt;Head site={site} config={config} helper={helper} page={page} /&gt; # &lt;body class={`is-${columnCount}-column`}&gt; ä¿®æ”¹ä¸ºä¸‹é¢ä¸€è¡Œ &lt;body class={`is-3-column`}&gt; ...... # 'is-8-tablet is-8-desktop is-8-widescreen': columnCount === 2 # ä¿®æ”¹ä¸ºä¸‹é¢ä¸€è¡Œ 'is-8-tablet is-8-desktop is-9-widescreen': columnCount === 2, 'is-8-tablet is-8-desktop is-6-widescreen': columnCount === 3 })} dangerouslySetInnerHTML={{ __html: body }}&gt;&lt;/div&gt; ...... }};# layout/common/widgets.jsxfunction getColumnSizeClass(columnCount) { switch (columnCount) { case 2: # return 'is-4-tablet is-4-desktop is-4-widescreen'; # ä¿®æ”¹ä¸ºä¸‹é¢ä¸€è¡Œ return 'is-4-tablet is-4-desktop is-3-widescreen'; case 3: return 'is-4-tablet is-4-desktop is-3-widescreen'; }} 123456789101112# include/style/responsive.styl+widescreen() # å¢åŠ  .is-3-column .container max-width: $widescreen - $gap width: $widescreen - $gap+fullhd() # å¢åŠ  .is-3-column .container max-width: $fullhd - 2 * $gap width: $fullhd - 2 * $gap å¼€å¯æ–‡ç« ç›®å½• åœ¨_config.ymlä¸­æ·»åŠ toc: true åœ¨_config.icarus.ymlæˆ–è€…_config.post.ymlä¸­æ·»åŠ  1234567widgets: # æ–‡ç« ç›®å½• - position: left type: toc # ç›®å½•åºå· index: true åªå›ºå®šç›®å½•123456# source/js/main.jsconst $toc = $('#toc');if ($toc.length &gt; 0) { $toc.addClass('column-left is-sticky'); # æ·»åŠ  ......} 1234# include/style/widget.styl æ·»åŠ ä¸‹é¢#toc max-height: calc(100vh - 22px) overflow-y: scroll","link":"/2021/09/14/Icarus%E4%B8%BB%E9%A2%98%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/"},{"title":"Javaä¸­çš„Thread","text":"å‰è¨€æƒ³å¿…å„ä½éƒ½å¯¹çº¿ç¨‹è¿™ä¸ªè¯ä¸é™Œç”Ÿï¼Œæˆ‘ä»¬éƒ½çŸ¥é“Javaä¸­å¯ä»¥é€šè¿‡Threadã€Rannableã€Callableå’Œçº¿ç¨‹æ± æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ã€‚ä½†æ˜¯ä¸€ä¸ªçº¿ç¨‹çš„åˆ›å»ºã€è¿è¡Œåˆ°ç»“æŸåˆ°åº•æ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„è¿‡ç¨‹å‘¢ï¼Ÿæˆ‘ä»¬ä»¥ä¸€æ®µä»£ç ä¸ºå…¥å£ç‚¹æ¥çœ‹çœ‹Javaåˆ°åº•æ˜¯å¦‚ä½•å¼„çš„çº¿ç¨‹ã€‚ 12345public static void main(String[] args) { new Thread(() -&gt; { System.out.println(&quot;run...&quot;); }).start();} æºç åŸºæœ¬å±æ€§1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677// çº¿ç¨‹åprivate volatile String name;// ä¼˜å…ˆçº§private int priority;// æ²¡æœ‰ç”¨åˆ°ã€‚å¯èƒ½åœ¨è™šæ‹Ÿæœºè°ƒç”¨çš„æ—¶å€™ä¼šæœ‰ç”¨ã€‚private Thread threadQ;private long eetop;// æ˜¯å¦å•æ­¥æ‰§è¡Œæ­¤çº¿ç¨‹private boolean single_step;// æ˜¯å¦æ˜¯å®ˆæŠ¤çº¿ç¨‹private boolean daemon = false;// JVMçŠ¶æ€private boolean stillborn = false;// runæ–¹æ³•å®ç°private Runnable target;// å½“å‰çº¿ç¨‹çš„çº¿ç¨‹ç»„private ThreadGroup group;// è¿™ä¸ªçº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨private ClassLoader contextClassLoader;// çº¿ç¨‹ç»§æ‰¿çš„ä¸Šä¸‹æ–‡private AccessControlContext inheritedAccessControlContext;// ç”¨äºç¼–å·çº¿ç¨‹åï¼Œå•è°ƒé€’å¢private static int threadInitNumber;// ä¸å½“å‰çº¿ç¨‹ç›¸å…³çš„ThreadLocalå€¼ThreadLocal.ThreadLocalMap threadLocals = null;// å½“å‰çº¿ç¨‹ç»§æ‰¿çš„ThreadLocalå€¼ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;// çº¿ç¨‹çš„æ ˆå¤§å°private long stackSize;// åœ¨æœ¬æœºçº¿ç¨‹ç»ˆæ­¢åæŒç»­å­˜åœ¨çš„ JVM ç§æœ‰çŠ¶æ€ã€‚private long nativeParkEventPointer;// çº¿ç¨‹Idprivate long tid;// ç”¨äºç”Ÿæˆçº¿ç¨‹Idprivate static long threadSeqNumber;// çº¿ç¨‹çŠ¶æ€private volatile int threadStatus = 0;// æ²¡æœ‰ç”¨åˆ°ã€‚å¯èƒ½åœ¨è™šæ‹Ÿæœºè°ƒç”¨çš„æ—¶å€™ä¼šæœ‰ç”¨ã€‚volatile Object parkBlocker;// ä¸­æ–­æ ‡å¿—private volatile Interruptible blocker;// ä¸­æ–­æ—¶é”ä½çš„å¯¹è±¡private final Object blockerLock = new Object();// æœ€å°ä¼˜å…ˆçº§public final static int MIN_PRIORITY = 1;// é»˜è®¤ä¼˜å…ˆçº§public final static int NORM_PRIORITY = 5;// æœ€å¤§ä¼˜å…ˆçº§public final static int MAX_PRIORITY = 10;/** * çº¿ç¨‹çŠ¶æ€ */public enum State { NEW, RUNNABLE, BLOCKED, WAITING, TIMED_WAITING, TERMINATED;} å¼€å§‹åˆ°ç»“æŸé™æ€ä»£ç å—12345private static native void registerNatives();static { // æ–¹ä¾¿è°ƒç”¨æœ¬åœ°æ–¹æ³•å— registerNatives();} init()ä¸»è¦å°±æ˜¯åˆå§‹åŒ–çº¿ç¨‹çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼ˆçº¿ç¨‹åã€æ ˆå¤§å°ã€çº¿ç¨‹ç»„ã€çˆ¶çº¿ç¨‹ã€ä¼˜å…ˆçº§ã€ä¸Šä¸‹æ–‡ä¿¡æ¯ç­‰ï¼‰å’Œå®‰å…¨æ£€æµ‹ã€‚ æ³¨æ„ï¼šè¿™é‡Œå¹¶æ²¡æœ‰å°†çº¿ç¨‹æ·»åŠ åˆ°çº¿ç¨‹ç»„é‡Œé¢ï¼Œåªæ˜¯å¢åŠ çº¿ç¨‹ç»„ä¸­æœªå¯åŠ¨çº¿ç¨‹çš„è®¡æ•°ã€‚addUnstarted() 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394public Thread(Runnable target) { // param1: çº¿ç¨‹ç»„ // param2: Runnable // param3: çº¿ç¨‹åï¼ˆä»0å¼€å§‹é€’å¢ï¼‰ // param4: åˆ†é…çš„æ ˆå¤§å°ï¼ˆåˆå§‹ä¸º0ï¼‰ init(null, target, &quot;Thread-&quot; + nextThreadNum(), 0);}private static synchronized int nextThreadNum() { // ä»0å¼€å§‹é€’å¢ return threadInitNumber++;}private void init(ThreadGroup g, Runnable target, String name, long stackSize) { init(g, target, name, stackSize, null, true);}/** * çº¿ç¨‹çš„åˆå§‹åŒ–æ–¹æ³• * ä¸»è¦å°±æ˜¯åˆå§‹åŒ–çº¿ç¨‹çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼ˆçº¿ç¨‹åã€æ ˆå¤§å°ã€çº¿ç¨‹ç»„ã€çˆ¶çº¿ç¨‹ã€ä¼˜å…ˆçº§ç­‰ï¼‰ * @param g çº¿ç¨‹ç»„ï¼Œä¸€èˆ¬ä¸ºnullï¼Œé™¤éæœ‰ä¼ å…¥ã€‚ * @param target Runnable * @param name çº¿ç¨‹åã€‚ä»0å¼€å§‹ï¼Œå•è°ƒé€’å¢ * @param stackSize æ–°çº¿ç¨‹æ‰€éœ€çš„å †æ ˆå¤§å°ï¼Œæˆ–ä¸ºé›¶è¡¨ç¤ºå°†å¿½ç•¥æ­¤å‚æ•°ã€‚ * @param acc ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚å¦‚æœä¸ºnullï¼Œå°±è·å–å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ * @param inheritThreadLocals æ˜¯å¦ä»æ„é€ çº¿ç¨‹ç»§æ‰¿å¯ç»§æ‰¿çº¿ç¨‹å±€éƒ¨çš„åˆå§‹å€¼*/private void init(ThreadGroup g, Runnable target, String name, long stackSize, AccessControlContext acc, boolean inheritThreadLocals) { if (name == null) { throw new NullPointerException(&quot;name cannot be null&quot;); } this.name = name; // è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ Thread parent = currentThread(); // å®‰å…¨éªŒè¯ SecurityManager security = System.getSecurityManager(); if (g == null) { if (security != null) { g = security.getThreadGroup(); } if (g == null) { // å°±ç®—çº¿ç¨‹ç»„ä¸ºnullä¹Ÿä¼šè®¾ç½®ä¸ºçˆ¶çº¿ç¨‹çš„çº¿ç¨‹ç»„ g = parent.getThreadGroup(); } } // å®‰å…¨æ£€æŸ¥ g.checkAccess(); if (security != null) { if (isCCLOverridden(getClass())) { security.checkPermission(SUBCLASS_IMPLEMENTATION_PERMISSION); } } // å¢åŠ çº¿ç¨‹ç»„ä¸­æœªå¯åŠ¨çº¿ç¨‹çš„è®¡æ•°ã€‚æœªå¯åŠ¨çš„çº¿ç¨‹ä¸ä¼šæ·»åŠ åˆ°çº¿ç¨‹ç»„ä¸­ï¼Œ // ä»¥ä¾¿åœ¨å®ƒä»¬ä»æœªå¯åŠ¨æ—¶å¯ä»¥æ”¶é›†å®ƒä»¬ï¼Œä½†å¿…é¡»å¯¹å…¶è¿›è¡Œè®¡æ•°ï¼Œ // ä»¥ä¾¿å…¶ä¸­åŒ…å«æœªå¯åŠ¨çº¿ç¨‹çš„å®ˆæŠ¤çº¿ç¨‹ç»„ä¸ä¼šè¢«é”€æ¯ã€‚ g.addUnstarted(); this.group = g; // ä¼šæ ¹æ®çˆ¶çº¿ç¨‹æ˜¯å¦æ˜¯å®ˆæŠ¤çº¿ç¨‹æ¥è®¾ç½®è¯¥çº¿ç¨‹æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹ this.daemon = parent.isDaemon(); // æ ¹æ®çˆ¶çº¿ç¨‹çš„ä¼˜å…ˆçº§æ¥è®¾ç½®è¯¥çº¿ç¨‹çš„ä¼˜å…ˆçº§ this.priority = parent.getPriority(); // è®¾ç½®ç±»åŠ è½½å™¨ if (security == null || isCCLOverridden(parent.getClass())) this.contextClassLoader = parent.getContextClassLoader(); else this.contextClassLoader = parent.contextClassLoader; // æ˜¯å¦é‡‡ç”¨å½“å‰ä¸Šä¸‹æ–‡ä¿¡æ¯ this.inheritedAccessControlContext = acc != null ? acc : AccessController.getContext(); this.target = target; // è®¾ç½®ä¼˜å…ˆçº§ setPriority(priority); // å±€éƒ¨å˜é‡ if (inheritThreadLocals &amp;&amp; parent.inheritableThreadLocals != null) this.inheritableThreadLocals = ThreadLocal.createInheritedMap(parent.inheritableThreadLocals); // æ ˆå¤§å° this.stackSize = stackSize; /* Set thread ID */ // è®¾ç½®çº¿ç¨‹Idã€‚ä»0å¼€å§‹å•è°ƒé€’å¢ tid = nextThreadID();} start()é¦–å…ˆä¼šåˆ¤æ–­è¯¥çº¿ç¨‹çŠ¶æ€æ˜¯å¦æ˜¯NEWï¼Œæ˜¯çš„è¯å°±å°†è¯¥çº¿ç¨‹æ·»åŠ åˆ°çº¿ç¨‹ç»„é‡Œé¢ï¼ˆå› ä¸ºåœ¨init()æ–¹æ³•é‡Œé¢åªæ˜¯å¢åŠ äº†è®¡æ•°ï¼Œå¹¶æœªæ·»åŠ åˆ°çº¿ç¨‹ç»„é‡Œé¢ï¼‰ï¼Œç„¶åè°ƒç”¨Nativeæ–¹æ³•start0()ã€‚ 123456789101112131415161718192021222324252627282930313233public synchronized void start() { // 0 å¯¹åº” NEW if (threadStatus != 0) throw new IllegalThreadStateException(); // å°†çº¿ç¨‹æ·»åŠ åˆ°çº¿ç¨‹ç»„ä¸­ group.add(this); boolean started = false; try { // è°ƒç”¨nativeæ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¼šä¿®æ”¹çº¿ç¨‹çš„çŠ¶æ€ä¸ºRunning start0(); // åœ¨start0()æ–¹æ³•æ‰§è¡Œå®Œæˆä¹‹åï¼Œä»£è¡¨çº¿ç¨‹å·²ç»è¦å¼€å§‹è¿è¡Œäº† // ä¼šç›´æ¥æ‰§è¡Œrun()æ–¹æ³•ï¼Œè€Œä¸»çº¿ç¨‹å¯èƒ½è¿˜åœ¨æ‰§è¡Œstarted = true started = true; } finally { try { if (!started) { // å¼€å¯å¤±è´¥ group.threadStartFailed(this); } } catch (Throwable ignore) { } }}public void run() { if (target != null) { target.run(); }} exit()è¢«ç³»ç»Ÿæ–¹æ³•è°ƒç”¨ã€‚å°†è¯¥çº¿ç¨‹ä»çº¿ç¨‹ç»„ä¸­åˆ é™¤ï¼Œå¦‚æœçº¿ç¨‹ç»„æ˜¯å®ˆæŠ¤çº¿ç¨‹ç»„å¹¶ä¸”æ²¡æœ‰æ´»åŠ¨çº¿ç¨‹å¹¶ä¸”æ²¡æœ‰æœªå¯åŠ¨çš„çº¿ç¨‹å¹¶ä¸”æ²¡æœ‰å­çº¿ç¨‹ç»„ï¼Œå°±å°†è¯¥çº¿ç¨‹ç»„è¿›è¡Œé”€æ¯ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738/** * é€€å‡ºæ–¹æ³•ã€‚æ˜¯è¢«ç³»ç»Ÿè°ƒç”¨çš„ã€‚ */private void exit() { if (group != null) { // å°†è¯¥çº¿ç¨‹ä»çº¿ç¨‹ç»„ä¸­åˆ é™¤ // å¦‚æœè¯¥çº¿ç¨‹ç»„æ˜¯å®ˆæŠ¤çº¿ç¨‹ç»„å¹¶ä¸”æ´»åŠ¨çº¿ç¨‹æ•°ä¸º0 // å¹¶ä¸”æœªå¯åŠ¨çš„çº¿ç¨‹ä¸º0å¹¶ä¸”æ²¡æœ‰å­çº¿ç¨‹ç»„ï¼Œé”€æ¯è¯¥çº¿ç¨‹ç»„ group.threadTerminated(this); group = null; } target = null; threadLocals = null; inheritableThreadLocals = null; inheritedAccessControlContext = null; blocker = null; uncaughtExceptionHandler = null;}void threadTerminated(Thread t) { synchronized (this) { // å°†æŒ‡å®šçº¿ç¨‹ä»çº¿ç¨‹ç»„ä¸­åˆ é™¤ã€‚å°±æ˜¯ä»çº¿ç¨‹æ•°ç»„é‡Œé¢åˆ é™¤è¯¥çº¿ç¨‹ remove(t); // å¦‚æœçº¿ç¨‹ç»„ä¸­æ´»åŠ¨çº¿ç¨‹æ•°ä¸º0ï¼Œå”¤é†’æ‰€æœ‰çº¿ç¨‹ if (nthreads == 0) { notifyAll(); } // å¦‚æœæ˜¯å®ˆæŠ¤çº¿ç¨‹ç»„å¹¶ä¸”æ´»åŠ¨çº¿ç¨‹æ•°ä¸º0å¹¶ä¸”æœªå¯åŠ¨çš„çº¿ç¨‹ä¸º0å¹¶ä¸”æ²¡æœ‰å­çº¿ç¨‹ if (daemon &amp;&amp; (nthreads == 0) &amp;&amp; (nUnstartedThreads == 0) &amp;&amp; (ngroups == 0)) { // é”€æ¯è¯¥çº¿ç¨‹ç»„ destroy(); } }} ThreadçŠ¶æ€ThreadçŠ¶æ€çš„å˜åŒ–éƒ½æ˜¯é€šè¿‡ä¸€äº›nativeæ–¹æ³•è¿›è¡Œæ”¹å˜çš„ã€‚ getState()123456789101112131415161718192021222324public State getState() { // æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨çš„æ˜¯è™šæ‹Ÿæœºé‡Œé¢çš„æ–¹æ³• return sun.misc.VM.toThreadState(threadStatus);}// class: sun.misc.VM;/** * é€šè¿‡&amp;è¿ç®—ç¬¦æ¥è®¡ç®—çº¿ç¨‹çš„çŠ¶æ€ã€‚ */public static State toThreadState(int var0) { if ((var0 &amp; 4) != 0) { return State.RUNNABLE; } else if ((var0 &amp; 1024) != 0) { return State.BLOCKED; } else if ((var0 &amp; 16) != 0) { return State.WAITING; } else if ((var0 &amp; 32) != 0) { return State.TIMED_WAITING; } else if ((var0 &amp; 2) != 0) { return State.TERMINATED; } else { return (var0 &amp; 1) == 0 ? State.NEW : State.RUNNABLE; }}","link":"/2021/08/01/Java%E4%B8%AD%E7%9A%84Thread/"},{"title":"Javaä¸­çš„Threadã€Rannableå’ŒCallable","text":"","link":"/2021/08/03/Java%E4%B8%AD%E7%9A%84Thread%E3%80%81Rannable%E5%92%8CCallable/"},{"title":"Linuxä¸­TCPä¸‰æ¬¡æ¡æ‰‹çš„å®ç°","text":"å‰è¨€ç½‘ä¸Šä¸‰æ¬¡æ¡æ‰‹å…«è‚¡æ–‡ä¸€å¤§å †ï¼Œæˆ‘â€œä¸ºäº†é¢è¯•â€ä¹Ÿå»çœ‹äº†çœ‹ï¼Œåˆšå¥½é‚£æ—¶å€™æ¥è§¦Linuxæ¯”è¾ƒå¤šï¼Œçªç„¶æƒ³åˆ°TCPä¸‰æ¬¡æ¡æ‰‹åœ¨Linuxå†…æ ¸ä¸­æ˜¯å¦‚ä½•å»å®ç°çš„å‘¢ï¼Ÿæ˜¯ä¸æ˜¯ä¼šæœ‰ä¸åŒï¼Ÿç„¶åæˆ‘å°±å¼€å§‹äº†æ¼«é•¿çš„ç™¾åº¦ï¼ˆps: æˆ‘æ¯”è¾ƒèœï¼Œè¿˜ä¸èƒ½æ‹¿ç€Linuxä¸Šåƒä¸ªæºç æ–‡ä»¶å»æ€¼ï¼‰ã€æºç ä¹‹è·¯ã€‚ç»ˆäºå¼„æ¸…äº†Linuxä¸­TCPä¸‰æ¬¡æ¡æ‰‹çš„å¤§è‡´è¿‡ç¨‹ã€‚ TCPä¸‰æ¬¡æ¡æ‰‹æˆ‘é‚£è¾¹éƒ½çŸ¥é“TCPå»ºç«‹è¿æ¥å‰éƒ½éœ€è¦å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªSYNåŒ…ï¼ŒæœåŠ¡ç«¯å“åº”ä¸€ä¸ªSYN + ACKåŒ…ï¼Œå®¢æˆ·ç«¯å“åº”ä¸€ä¸ªACKåŒ…ï¼Œè¿™æ˜¯ä¸‰æ¬¡æ¡æ‰‹çš„åŸºæœ¬æµç¨‹ã€‚ ä½†å¦‚æœè®©æˆ‘ä»¬å»å®ç°ä¸‰æ¬¡æ¡æ‰‹ï¼Œåº”è¯¥æ€ä¹ˆå»è®¾è®¡å‘¢ï¼Ÿ Linuxä¸­çš„å®ç°æˆ‘ä»¬ä»¥ç½‘ç»œç¼–ç¨‹ä¸­çš„ç›¸åº”å‡½æ•°ä¸ºåˆ‡å…¥ç‚¹ Linuxä¸­ä¸‰æ¬¡æ¡æ‰‹çš„ä¸»è¦å‡½æ•°æœ‰socket()ã€bind()ã€listen()ã€connect()ã€recv()ã€accept() socket()socket åœ¨å†…æ ¸é‡Œå¹¶ä¸æ˜¯ä¸€ä¸ªå†…æ ¸å¯¹è±¡ã€‚è€Œæ˜¯åŒ…å« fileã€socketã€sock ç­‰å¤šä¸ªç›¸å…³å†…æ ¸å¯¹è±¡æ„æˆï¼Œæ¯ä¸ªå†…æ ¸å¯¹è±¡è¿˜å®šä¹‰äº† ops æ“ä½œå‡½æ•°é›†åˆã€‚ 12// è¿”å›çš„æ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦fdfd = socket(AF_INET,SOCK_STREAM, 0); bind()è°ƒç”¨bind()å‡½æ•°ç»‘å®šç«¯å£ï¼Œä¼šä½¿connect()æ—¶é€‰æ‹©ç«¯å£æ–¹å¼æ— æ•ˆã€‚ä¸æ¨èåœ¨å®¢æˆ·ç«¯ä¸­ä½¿ç”¨bind()ï¼Œè¿™ä¼šæ‰“ä¹±connectçš„ç«¯å£é€‰æ‹©è¿‡ç¨‹ã€‚ï¼ˆä½†æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¼šbind()ï¼Œæ¯”å¦‚è¯´åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯è¿›è¡Œåå•†ä½¿ç”¨ä»€ä¹ˆç«¯å£æ¥è°ƒç”¨ï¼‰ æµç¨‹ï¼š åˆ¤æ–­ç”¨æˆ·ä¼ å…¥çš„ç«¯å£æ˜¯å¦å°äº1024 è°ƒç”¨inet_csk_get_portæ¥åˆ¤æ–­ä¼ å…¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼Œå¦‚æœè¢«å ç”¨å°±è¿”å›EADDRINUSEã€‚è¿™ä¸ªæ–¹æ³•ä¸ä¼šåˆ° ESTABLISH çš„å“ˆå¸Œè¡¨è¿›è¡Œå¯ç”¨æ£€æµ‹ï¼Œåªåœ¨ bind çŠ¶æ€çš„ socket é‡ŒæŸ¥ã€‚æ‰€ä»¥é»˜è®¤æƒ…å†µä¸‹ï¼Œåªè¦ç«¯å£ç”¨è¿‡ä¸€æ¬¡å°±ä¸ä¼šå†æ¬¡ä½¿ç”¨ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135// file: net/ipv4/af_inet.cint inet_bind(struct socket *sock, struct sockaddr *uaddr, int addr_len){ struct sockaddr_in *addr = (struct sockaddr_in *)uaddr; struct sock *sk = sock-&gt;sk; struct inet_sock *inet = inet_sk(sk); unsigned short snum; int chk_addr_ret; int err; if (sk-&gt;sk_prot-&gt;bind) { // å¦‚æœè¿™ä¸ªsocketæœ‰ä»–è‡ªå·±çš„bind()å‡½æ•°ï¼Œå°±ä½¿ç”¨è¿™ä¸ªbind()å‡½æ•° err = sk-&gt;sk_prot-&gt;bind(sk, uaddr, addr_len); goto out; } // ...... // ç”¨æˆ·ä¼ å…¥çš„ç«¯å£å· snum = ntohs(addr-&gt;sin_port); err = -EACCES; // ä¼ å…¥çš„ç«¯å£å·ä¸å…è®¸å°äº1024 if (snum &amp;&amp; snum &lt; PROT_SOCK &amp;&amp; !capable(CAP_NET_BIND_SERVICE)) goto out; //...... // å°è¯•ç¡®å®šç«¯å£å· // å®é™…è°ƒç”¨çš„æ˜¯inet_csk_get_portï¼Œç”¨æ¥å°è¯•ç¡®å®šç«¯å£å·æ˜¯å¦è¢«å ç”¨ // å¦‚æœè¢«å ç”¨å°±è¿”å›EADDRINUSEï¼Œç„¶åå°±ä¼šæ˜¾ç¤º&quot;Address already in use&quot;(ç«¯å£è¢«å ç”¨) if (sk-&gt;sk_prot-&gt;get_port(sk, snum)) { inet-&gt;inet_saddr = inet-&gt;inet_rcv_saddr = 0; err = -EADDRINUSE; goto out_release_sock; } // ......}// file: net/ipv4/inet_connection_sock.c/** * è·å–å¯¹ç»™å®šsockçš„æœ¬åœ°ç«¯å£çš„å¼•ç”¨ï¼Œ * å¦‚æœsnumä¸ºé›¶ï¼Œåˆ™è¡¨ç¤ºé€‰æ‹©ä»»ä½•å¯ç”¨çš„æœ¬åœ°ç«¯å£ã€‚ */int inet_csk_get_port(struct sock *sk, unsigned short snum){ struct inet_hashinfo *hashinfo = sk-&gt;sk_prot-&gt;h.hashinfo; struct inet_bind_hashbucket *head; struct hlist_node *node; struct inet_bind_bucket *tb; int ret, attempts = 5; struct net *net = sock_net(sk); int smallest_size = -1, smallest_rover; local_bh_disable(); // å¦‚æœä¼ å…¥çš„snumä¸ä¸º0 if (!snum) { int remaining, rover, low, high;again: // è·å–æœ¬åœ°æŒ‡å®šçš„ç«¯å£èŒƒå›´ inet_get_local_port_range(&amp;low, &amp;high); remaining = (high - low) + 1; // åœ¨ç«¯å£èŒƒå›´ä¸­å–ä¸€ä¸ªéšæœºä½ç½®å¼€å§‹éå† smallest_rover = rover = net_random() % remaining + low; smallest_size = -1; do { // å¦‚æœæœ¬åœ°è®¾ç½®äº†ä¸€ä¸ªç«¯å£ä¸å¯ç”¨ if (inet_is_reserved_local_port(rover)) goto next_nolock; head = &amp;hashinfo-&gt;bhash[inet_bhashfn(net, rover, hashinfo-&gt;bhash_size)]; spin_lock(&amp;head-&gt;lock); inet_bind_bucket_for_each(tb, node, &amp;head-&gt;chain) // å†²çªæ£€æµ‹ï¼Œå¦‚æœç«¯å£æ˜¯ç”¨åˆ°çš„ï¼Œå»have_sumé€»è¾‘ if (net_eq(ib_net(tb), net) &amp;&amp; tb-&gt;port == rover) { if (tb-&gt;fastreuse &gt; 0 &amp;&amp; sk-&gt;sk_reuse &amp;&amp; sk-&gt;sk_state != TCP_LISTEN &amp;&amp; (tb-&gt;num_owners &lt; smallest_size || smallest_size == -1)) { smallest_size = tb-&gt;num_owners; smallest_rover = rover; if (atomic_read(&amp;hashinfo-&gt;bsockets) &gt; (high - low) + 1) { spin_unlock(&amp;head-&gt;lock); snum = smallest_rover; goto have_snum; } } goto next; } break; next: spin_unlock(&amp;head-&gt;lock); next_nolock: if (++rover &gt; high) rover = low; } while (--remaining &gt; 0); /* Exhausted local port range during search? It is not * possible for us to be holding one of the bind hash * locks if this test triggers, because if 'remaining' * drops to zero, we broke out of the do/while loop at * the top level, not from the 'break;' statement. */ ret = 1; if (remaining &lt;= 0) { if (smallest_size != -1) { snum = smallest_rover; goto have_snum; } goto fail; } /* OK, here is the one we will use. HEAD is * non-NULL and we hold it's mutex. */ snum = rover; } else {have_snum: head = &amp;hashinfo-&gt;bhash[inet_bhashfn(net, snum, hashinfo-&gt;bhash_size)]; spin_lock(&amp;head-&gt;lock); inet_bind_bucket_for_each(tb, node, &amp;head-&gt;chain) if (net_eq(ib_net(tb), net) &amp;&amp; tb-&gt;port == snum) // åˆ¤æ–­ç«¯å£æ˜¯å¦è¢«å ç”¨ goto tb_found; } // ......} listen()ä¸»è¦æ˜¯ç”³è¯·å’Œåˆå§‹åŒ–æ¥æ”¶é˜Ÿåˆ—ï¼ŒåŒ…æ‹¬å…¨è¿æ¥é˜Ÿåˆ—å’ŒåŠè¿æ¥é˜Ÿåˆ— å…¨è¿æ¥é˜Ÿåˆ—é•¿åº¦ï¼šç”¨æˆ·ä¼ å…¥çš„ backlog å’Œ net.core.somaxconn ä¹‹é—´è¾ƒå°çš„é‚£ä¸ªå€¼ åŠè¿æ¥é˜Ÿåˆ—é•¿åº¦ï¼šmin(backlog, somaxconn, tcp_max_syn_backlog) + 1 å†ä¸Šå–æ•´åˆ° 2 çš„å¹‚æ¬¡ï¼Œä½†æœ€å°ä¸èƒ½å°äº16ã€‚ æµç¨‹ï¼š æ ¹æ®æ–‡ä»¶æè¿°ç¬¦fdæŸ¥æ‰¾socketå†…æ ¸å¯¹è±¡ è·å–å†…æ ¸å‚æ•°net.core.somaxconnï¼Œä¸ç”¨æˆ·ä¼ å…¥çš„backlogç›¸æ¯”è¾ƒï¼Œå–æœ€å°çš„ è°ƒç”¨sock-&gt;ops-&gt;listen(sock, backlog)å‡½æ•°ï¼Œå®é™…æ˜¯inet_listen åˆ¤æ–­æ˜¯å¦æ˜¯listençŠ¶æ€ å¦‚æœä¸æ˜¯listençŠ¶æ€ï¼Œå¼€å§‹ç›‘å¬ï¼ˆæ¥æ”¶é˜Ÿåˆ—çš„åˆ›å»ºã€åˆå§‹åŒ–ã€‚å†…å­˜ç”³è¯·ã€åŠè¿æ¥é˜Ÿåˆ—é•¿åº¦çš„è®¡ç®—ã€å…¨è¿æ¥é˜Ÿåˆ—å¤´çš„åˆå§‹åŒ–ç­‰ï¼‰ã€‚1. è®¡ç®—åŠè¿æ¥é˜Ÿåˆ—é•¿åº¦ï¼ˆä¸sysctl_max_syn_backlogå– ä¸€æ¬¡æœ€å°å€¼ï¼›ä¿è¯ä¸èƒ½æ¯”8å°ï¼›å‘ä¸Šå¯¹é½åˆ°2çš„æ•´æ•°æ¬¡å¹‚ï¼‰ã€‚2. ç”³è¯·å†…å­˜ã€‚3. å…¨é˜Ÿåˆ—å¤´åˆå§‹åŒ–ï¼Œè®¾ç½®ä¸ºnullã€‚4. å°†åŠè¿æ¥é˜Ÿåˆ—æŒ‚è½½åˆ°æ¥æ”¶é˜Ÿåˆ—ä¸Šã€‚ è®¾ç½®å…¨è¿æ¥é˜Ÿåˆ—çš„é•¿åº¦ï¼ˆbacklogä¸net.core.somaxconnä¹‹é—´è¾ƒå°çš„å“ªä¸ªå€¼ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122//file: net/socket.cSYSCALL_DEFINE2(listen, int, fd, int, backlog){ struct socket *sock; int err, fput_needed; int somaxconn; // æ ¹æ® fdï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰ æŸ¥æ‰¾å¯¹åº”çš„ socket å†…æ ¸å¯¹è±¡ sock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed); if (sock) { // è·å–å†…æ ¸å‚æ•° somaxconn = sock_net(sock-&gt;sk)-&gt;core.sysctl_somaxconn; // å¦‚æœè®¾ç½®çš„backlogå¤§äºæ ¸å¿ƒå‚æ•° if ((unsigned)backlog &gt; somaxconn) // ä½¿ç”¨æ ¸å¿ƒå‚æ•° backlog = somaxconn; err = security_socket_listen(sock, backlog); if (!err) // è°ƒç”¨åè®®æ ˆæ³¨å†Œçš„listenå‡½æ•° err = sock-&gt;ops-&gt;listen(sock, backlog); fput_light(sock-&gt;file, fput_needed); } return err;}// file: net/ipv4/af_inet.c// æœåŠ¡ç«¯çš„å…¨è¿æ¥é˜Ÿåˆ—é•¿åº¦æ˜¯listenæ—¶ä¼ å…¥çš„backlogå’Œnet.core.somaxconnä¹‹é—´æœ€å°çš„int inet_listen(struct socket *sock, int backlog){ // ...... // è¿˜ä¸æ˜¯listençŠ¶æ€ï¼ˆæ²¡æœ‰listenè¿‡ï¼‰ if (old_state != TCP_LISTEN) { // å¼€å§‹ç›‘å¬ err = inet_csk_listen_start(sk, backlog); if (err) goto out; } // è®¾ç½®å…¨è¿æ¥é˜Ÿåˆ—é•¿åº¦ sk-&gt;sk_max_ack_backlog = backlog; err = 0; // ......}// file: net/ipv4/inet_connection_sock.c// ç”¨æ¥åˆå§‹åŒ–æ¥æ”¶é˜Ÿåˆ—int inet_csk_listen_start(struct sock *sk, const int nr_table_entries){ // ...... // ç”¨æ¥ç”³è¯·å’Œåˆå§‹åŒ–icsk_accept_queueï¼ˆåŠè¿æ¥é˜Ÿåˆ—å’Œå…¨è¿æ¥é˜Ÿåˆ—ï¼‰è¿™ä¸ªå¯¹è±¡ // 1.å®šä¹‰æ¥æ”¶é˜Ÿåˆ—æ•°æ®ç»“æ„ // 2.æ¥æ”¶é˜Ÿåˆ—çš„ç”³è¯·å’Œåˆå§‹åŒ–ï¼ˆå†…å­˜çš„ç”³è¯·ã€åŠè¿æ¥é˜Ÿåˆ—é•¿åº¦çš„è®¡ç®—ã€å…¨è¿æ¥é˜Ÿåˆ—å¤´çš„åˆå§‹åŒ–ï¼‰ int rc = reqsk_queue_alloc(&amp;icsk-&gt;icsk_accept_queue, nr_table_entries); // ......}// file: net/core/request_sock.c/* * queueï¼šç”¨æ¥å­˜æ”¾å…¨è¿æ¥å’ŒåŠè¿æ¥é˜Ÿåˆ—çš„ç»“æ„ä½“ * nr_table_entriesï¼šæ˜¯å†…æ ¸å‚æ•°å’Œç”¨æˆ·ä¼ å…¥çš„backlogä¸­çš„æœ€å°å€¼ * * 1. å®šä¹‰ä¸€ä¸ªlisten_sockæŒ‡é’ˆï¼ˆåŠè¿æ¥é˜Ÿåˆ—ï¼‰ * 2. è®¡ç®—åŠè¿æ¥é˜Ÿåˆ—çš„é•¿åº¦ï¼Œç„¶åç”³è¯·å†…å­˜ã€‚åŠè¿æ¥é˜Ÿåˆ—çš„é•¿åº¦æ˜¯ min(backlog, somaxconn, tcp_max_syn_backlog) + 1 å†ä¸Šå–æ•´åˆ° 2 çš„å¹‚æ¬¡ï¼Œä½†æœ€å°ä¸èƒ½å°äº16ã€‚ * 3. å°†å…¨è¿æ¥é˜Ÿåˆ—å¤´queue-&gt;rskq_accept_headè®¾ç½®æˆNULLï¼Œ * å°†åŠè¿æ¥é˜Ÿåˆ—æŒ‚è½½åˆ°æ¥æ”¶é˜Ÿåˆ—queueä¸Š */int reqsk_queue_alloc(struct request_sock_queue *queue, unsigned int nr_table_entries){ size_t lopt_size = sizeof(struct listen_sock); // åŠè¿æ¥é˜Ÿåˆ— struct listen_sock *lopt; // è®¡ç®—åŠè¿æ¥é˜Ÿåˆ—çš„é•¿åº¦ // å†æ¬¡å’Œsysctl_max_syn_backlogå†…æ ¸å¯¹è±¡åˆå–ä¸€æ¬¡æœ€å°å€¼ nr_table_entries = min_t(u32, nr_table_entries, sysctl_max_syn_backlog); // ä¿è¯nr_table_entriesä¸èƒ½æ¯”8å°ã€‚ nr_table_entries = max_t(u32, nr_table_entries, 8); // ç”¨æ¥ä¸Šå¯¹é½åˆ°2çš„æ•´æ•°æ¬¡å¹‚ // æ¯”å¦‚è¯´å½“å‰nr_table_entriesæ˜¯æœ€å°å€¼8 // ç»è¿‡roundup_pow_of_twoï¼ˆ8+1ï¼‰ = 16 nr_table_entries = roundup_pow_of_two(nr_table_entries + 1); // ä¸ºlisten_sockå¯¹è±¡ç”³è¯·å†…å­˜ï¼Œè¿™é‡ŒåŒ…å«äº†åŠè¿æ¥é˜Ÿåˆ— lopt_size += nr_table_entries * sizeof(struct request_sock *); if (lopt_size &gt; PAGE_SIZE) lopt = vzalloc(lopt_size); else lopt = kzalloc(lopt_size, GFP_KERNEL); if (lopt == NULL) return -ENOMEM; // ä¸ºäº†æ•ˆç‡ï¼Œä¸è®°å½•nr_table_entries // è€Œæ˜¯è®°å½•2çš„å‡ æ¬¡å¹‚ç­‰äºnr_table_entries // t for (lopt-&gt;max_qlen_log = 3; (1 &lt;&lt; lopt-&gt;max_qlen_log) &lt; nr_table_entries; lopt-&gt;max_qlen_log++); get_random_bytes(&amp;lopt-&gt;hash_rnd, sizeof(lopt-&gt;hash_rnd)); rwlock_init(&amp;queue-&gt;syn_wait_lock); // å…¨è¿æ¥é˜Ÿåˆ—å¤´åˆå§‹åŒ– queue-&gt;rskq_accept_head = NULL; // åŠè¿æ¥é˜Ÿåˆ—è®¾ç½® lopt-&gt;nr_table_entries = nr_table_entries; write_lock_bh(&amp;queue-&gt;syn_wait_lock); queue-&gt;listen_opt = lopt; write_unlock_bh(&amp;queue-&gt;syn_wait_lock); return 0;} connect()æµç¨‹ï¼š è¿›å…¥å†…æ ¸ç³»ç»Ÿæ ¹æ®ç”¨æˆ·ä¼ å…¥çš„fdï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰æ¥æŸ¥è¯¢å¯¹åº”çš„socketå†…æ ¸å¯¹è±¡ è°ƒç”¨è¯¥sockå¯¹è±¡çš„sock-&gt;ops-&gt;connectæ–¹æ³•ï¼ˆinet_stream_connectï¼‰ æ ¹æ®sockçš„çŠ¶æ€æ¥è¿›å…¥ä¸åŒçš„å¤„ç†é€»è¾‘ã€‚ç¬¬ä¸€æ¬¡connectï¼Œsockçš„çŠ¶æ€éƒ½æ˜¯unconnectï¼Œæ‰€ä»¥ä¼šè°ƒsk-&gt;sk_prot-&gt;connectæ–¹æ³•ï¼ˆtcp_v4_connectï¼‰ å°†socketçŠ¶æ€è®¾ç½®ä¸ºTCP-SYN-SENT åŠ¨æ€é€‰æ‹©ä¸€ä¸ªç«¯å£ï¼ˆé¦–å…ˆåˆ¤æ–­æ˜¯å¦bind()äº†ä¸€ä¸ªç«¯å£ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±æ ¹æ®ç›®æ ‡åœ°å€å’Œç«¯å£ç­‰ä¿¡æ¯ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œç„¶ååœ¨æœ¬åœ°ç«¯å£èŒƒå›´ä¸­é€šè¿‡è¿™ä¸ªéšæœºæ•°é€æ¸å¢åŠ éå†ï¼Œå¦‚æœæ˜¯æœ¬åœ°é…ç½®çš„ä¿ç•™ç«¯å£å°±è·³è¿‡ï¼Œå¦‚æœä¸æ˜¯å°±éå†å·²ç»ä½¿ç”¨çš„ç«¯å£çš„å“ˆå¸Œé“¾è¡¨ï¼ˆhinfo-&gt;bhashï¼‰ï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»è¢«ä½¿ç”¨ã€‚å¦‚æœè¯¥ç«¯å£å·²ç»è¢«ä½¿ç”¨å¹¶ä¸”TCPè¿æ¥ä¸­çš„å››å…ƒç»„ä¸å½“å‰å»ºç«‹çš„å››å…ƒç»„å®Œå…¨ä¸€è‡´ï¼Œå°±ä¸å¯ä½¿ç”¨ã€‚ç»§ç»­éå†ï¼Œæ‰¾åˆ°äº†å°±è¿”å›ç«¯å£ï¼Œæ²¡æ‰¾åˆ°å°±æç¤ºâ€Address already in useâ€ï¼‰ è¿›è¡Œtcpè¿æ¥ã€‚ï¼ˆé¦–å…ˆç”³è¯·å¹¶è®¾ç½®skbï¼Œç„¶åæ·»åŠ åˆ°å‘é€é˜Ÿåˆ—sk_write_queueä¸Šï¼Œè¿›è¡Œå‘é€ï¼Œå¯åŠ¨é‡ä¼ å®šæ—¶å™¨ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192//file: net/socket.cSYSCALL_DEFINE3(connect, int, fd, struct sockaddr __user *, uservaddr, int, addrlen){ struct socket *sock; struct sockaddr_storage address; int err, fput_needed; // æ ¹æ®ç”¨æˆ·fdæŸ¥æ‰¾å†…æ ¸ä¸­çš„socketå¯¹è±¡ sock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed); // ...... // è°ƒç”¨sockä¸­opsçš„connect()æ–¹æ³• // å…¶å®æ˜¯inet_stream_connect() err = sock-&gt;ops-&gt;connect(sock, (struct sockaddr *)&amp;address, addrlen, sock-&gt;file-&gt;f_flags); // ......}//file: ipv4/af_inet.cint inet_stream_connect(struct socket *sock, struct sockaddr *uaddr, int addr_len, int flags){ struct sock *sk = sock-&gt;sk; // ...... switch (sock-&gt;state) { default: err = -EINVAL; goto out; case SS_CONNECTED: err = -EISCONN; goto out; case SS_CONNECTING: err = -EALREADY; /* Fall out of switch with err, set for this state */ break; case SS_UNCONNECTED: // åˆšåˆ›å»ºå®Œçš„socketçŠ¶æ€å°±æ˜¯SS_UNCONNECTEDï¼Œ // æ‰€ä»¥ç¬¬ä¸€æ¬¡connectçš„å°±ä¼šèµ°è¿™ä¸ªcase err = -EISCONN; if (sk-&gt;sk_state != TCP_CLOSE) goto out; // è°ƒç”¨sockçš„tcp_v4_connectæ–¹æ³• err = sk-&gt;sk_prot-&gt;connect(sk, uaddr, addr_len); if (err &lt; 0) goto out; // ä¿®æ”¹sockçš„çŠ¶æ€ sock-&gt;state = SS_CONNECTING; /* Just entered SS_CONNECTING state; the only * difference is that return value in non-blocking * case is EINPROGRESS, rather than EALREADY. */ err = -EINPROGRESS; break; } // ......}//file: net/ipv4/tcp_ipv4.c// å¯åŠ¨ä¼ å‡ºè¿æ¥int tcp_v4_connect(struct sock *sk, struct sockaddr *uaddr, int addr_len){ // è®¾ç½®socketçŠ¶æ€ä¸ºTCP_SYN_SENT tcp_set_state(sk, TCP_SYN_SENT); // åŠ¨æ€é€‰æ‹©ä¸€ä¸ªç«¯å£ err = inet_hash_connect(&amp;tcp_death_row, sk); // å‡½æ•°ç”¨æ¥æ ¹æ®skä¸­çš„ä¿¡æ¯ï¼Œæ„å»ºä¸€ä¸ªå®Œæˆçš„synæŠ¥æ–‡ï¼Œå¹¶å°†å®ƒå‘é€å‡ºå» err = tcp_connect(sk);}//file:net/ipv4/inet_hashtables.c// ç»‘å®šä¸€ä¸ªç«¯å£int inet_hash_connect(struct inet_timewait_death_row *death_row, struct sock *sk){ // inet_sk_port_offset(sk): æ ¹æ®è¦è¿æ¥çš„ç›®çš„IPå’Œç«¯å£ç­‰ä¿¡æ¯ç”Ÿæˆä¸€ä¸ªéšæœºæ•° // __inet_check_established: æ£€æŸ¥æ˜¯å¦å’Œç°æœ‰ ESTABLISH çš„è¿æ¥æ˜¯å¦å†²çªçš„æ—¶å€™ç”¨çš„å‡½æ•° return __inet_hash_connect(death_row, sk, inet_sk_port_offset(sk), __inet_check_established, __inet_hash_nolisten);}//file:net/ipv4/inet_hashtables.c// ç«¯å£å·é€‰æ‹©int __inet_hash_connect(struct inet_timewait_death_row *death_row, struct sock *sk, u32 port_offset, int (*check_established)(struct inet_timewait_death_row *, struct sock *, __u16, struct inet_timewait_sock **), int (*hash)(struct sock *sk, struct inet_timewait_sock *twp)){ struct inet_hashinfo *hinfo = death_row-&gt;hashinfo; // æ˜¯å¦ç»‘å®šè¿‡ç«¯å£ï¼ˆbind()æ–¹æ³•ï¼‰ const unsigned short snum = inet_sk(sk)-&gt;inet_num; struct inet_bind_hashbucket *head; struct inet_bind_bucket *tb; int ret; struct net *net = sock_net(sk); int twrefcnt = 1; // å¦‚æœæ²¡æœ‰ç»‘å®šç«¯å£ if (!snum) { int i, remaining, low, high, port; static u32 hint; u32 offset = hint + port_offset; struct hlist_node *node; struct inet_timewait_sock *tw = NULL; // è·å–æœ¬æœºçš„ç«¯å£èŒƒå›´ä¿¡æ¯ inet_get_local_port_range(&amp;low, &amp;high); remaining = (high - low) + 1; local_bh_disable(); // éå†æŸ¥æ‰¾ç«¯å£ for (i = 1; i &lt;= remaining; i++) { // ä¹‹å‰ç®—å‡ºçš„éšæœºæ•°+i port = low + (i + offset) % remaining; // å¦‚æœæœ¬æœºé…ç½®äº†è¯¥ç«¯å£ä¸å¯ç”¨ if (inet_is_reserved_local_port(port)) continue; // æŸ¥æ‰¾å’Œéå†å·²ç»ä½¿ç”¨çš„ç«¯å£çš„å“ˆå¸Œé“¾è¡¨ head = &amp;hinfo-&gt;bhash[inet_bhashfn(net, port, hinfo-&gt;bhash_size)]; spin_lock(&amp;head-&gt;lock); inet_bind_bucket_for_each(tb, node, &amp;head-&gt;chain) { // å¦‚æœè¯¥ç«¯å£å·²ç»è¢«ä½¿ç”¨ if (net_eq(ib_net(tb), net) &amp;&amp; tb-&gt;port == port) { if (tb-&gt;fastreuse &gt;= 0) goto next_port; WARN_ON(hlist_empty(&amp;tb-&gt;owners)); // é€šè¿‡ check_established ç»§ç»­æ£€æŸ¥æ˜¯å¦å¯ç”¨ if (!check_established(death_row, sk, port, &amp;tw)) goto ok; goto next_port; } } } // ......}//file:net/ipv4/tcp_output.c// tcpè¿æ¥int tcp_connect(struct sock *sk){ struct tcp_sock *tp = tcp_sk(sk); struct sk_buff *buff; int err; // tcpè¿æ¥åˆå§‹åŒ– tcp_connect_init(sk); // ç”³è¯·skbå¹¶æ„é€ ä¸ºä¸€ä¸ªSYNåŒ… buff = alloc_skb_fclone(MAX_TCP_HEADER + 15, sk-&gt;sk_allocation); if (unlikely(buff == NULL)) return -ENOBUFS; // ...... // æ·»åŠ åˆ°å‘é€é˜Ÿåˆ— __tcp_add_write_queue_tail(sk, buff); // ...... // å®é™…å‘å‡ºsyn err = tcp_transmit_skb(sk, buff, 1, sk-&gt;sk_allocation); if (err == -ECONNREFUSED) return err; // ...... /* Timer for repeating the SYN until an answer. */ // å¯åŠ¨é‡ä¼ å®šæ—¶å™¨ inet_csk_reset_xmit_timer(sk, ICSK_TIME_RETRANS, inet_csk(sk)-&gt;icsk_rto, TCP_RTO_MAX); return 0;} åˆ¤æ–­å››å…ƒç»„ ä¸¤å¯¹å››å…ƒç»„ä¸­åªè¦ä»»æ„ä¸€ä¸ªå…ƒç´ ä¸åŒï¼Œéƒ½ç®—æ˜¯ä¸¤æ¡ä¸åŒçš„è¿æ¥ã€‚ä»¥ä¸‹çš„ä¸¤æ¡ TCP è¿æ¥å®Œå…¨å¯ä»¥åŒæ—¶å­˜åœ¨ï¼ˆå‡è®¾ 192.168.1.101 æ˜¯å®¢æˆ·ç«¯ï¼Œ192.168.1.100 æ˜¯æœåŠ¡ç«¯ï¼‰ è¿æ¥1ï¼š192.168.0.1 5000 192.168.0.2 8090 è¿æ¥2ï¼š192.168.0.1 5000 192.168.0.2 8091 check_established ä½œç”¨å°±æ˜¯æ£€æµ‹ç°æœ‰çš„ TCP è¿æ¥ä¸­æ˜¯å¦å››å…ƒç»„å’Œè¦å»ºç«‹çš„è¿æ¥å››å…ƒç´ å®Œå…¨ä¸€è‡´ã€‚å¦‚æœä¸å®Œå…¨ä¸€è‡´ï¼Œé‚£ä¹ˆè¯¥ç«¯å£ä»ç„¶å¯ç”¨ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152static int __inet_check_established(struct inet_timewait_death_row *death_row, struct sock *sk, __u16 lport, struct inet_timewait_sock **twp){ // æ‰¾åˆ°hashæ¡¶ï¼Œæ‰€æœ‰ESTABLISHçŠ¶æ€çš„socketç»„æˆçš„å“ˆå¸Œè¡¨ã€‚ unsigned int hash = inet_ehashfn(net, daddr, lport, saddr, inet-&gt;inet_dport); spin_lock(lock); /* Check TIME-WAIT sockets first. */ // éå†æŸ¥çœ‹æ˜¯å¦æœ‰å››å…ƒç»„ä¸€æ ·çš„ï¼Œä¸€æ ·å°±æŠ¥é”™ sk_nulls_for_each(sk2, node, &amp;head-&gt;twchain) { tw = inet_twsk(sk2); if (INET_TW_MATCH(sk2, net, hash, acookie, saddr, daddr, ports, dif)) { if (twsk_unique(sk, sk2, twp)) goto unique; else goto not_unique; } } tw = NULL; /* And established part... */ // ä½¿ç”¨ INET_MATCH æ¥åˆ¤æ–­æ˜¯å¦å¯ç”¨ã€‚ sk_nulls_for_each(sk2, node, &amp;head-&gt;chain) { if (INET_MATCH(sk2, net, hash, acookie, saddr, daddr, ports, dif)) goto not_unique; }unique: // ...... return 0;not_unique: spin_unlock(lock); return -EADDRNOTAVAIL;}// include/net/inet_hashtables.h#define INET_MATCH(__sk, __net, __hash, __cookie, __saddr, __daddr, __ports, __dif) \\ (((__sk)-&gt;sk_hash == (__hash)) &amp;&amp; net_eq(sock_net(__sk), (__net)) &amp;&amp; \\ (inet_sk(__sk)-&gt;inet_daddr == (__saddr)) &amp;&amp; \\ (inet_sk(__sk)-&gt;inet_rcv_saddr == (__daddr)) &amp;&amp; \\ ((*((__portpair *)&amp;(inet_sk(__sk)-&gt;inet_dport))) == (__ports)) &amp;&amp; \\ (!((__sk)-&gt;sk_bound_dev_if) || ((__sk)-&gt;sk_bound_dev_if == (__dif)))) æ‰€ä»¥ä¸€å°å®¢æˆ·ç«¯æœºæœ€å¤§èƒ½å»ºç«‹çš„è¿æ¥æ•°å¹¶ä¸æ˜¯ 65535ã€‚åªè¦ server è¶³å¤Ÿå¤šï¼Œå•æœºå‘å‡ºç™¾ä¸‡æ¡è¿æ¥æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚ recv()æœåŠ¡å™¨å“åº”SYNä¸»è¦å·¥ä½œæ˜¯åˆ¤æ–­ä¸‹æ¥æ”¶é˜Ÿåˆ—æ˜¯å¦æ»¡äº†ï¼Œæ»¡çš„è¯å¯èƒ½ä¼šä¸¢å¼ƒè¯¥è¯·æ±‚ï¼Œå¦åˆ™å‘å‡º synackã€‚ç”³è¯· request_sock æ·»åŠ åˆ°åŠè¿æ¥é˜Ÿåˆ—ä¸­ï¼ŒåŒæ—¶å¯åŠ¨å®šæ—¶å™¨ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158// file: net/ipv4/tcp_ipv4.c// å¤„ç†æ¡æ‰‹è¿‡ç¨‹ int tcp_v4_do_rcv(struct sock *sk, struct sk_buff *skb){ // ...... // å¦‚æœå·²ç»å»ºç«‹çš„TCPè¿æ¥ if (sk-&gt;sk_state == TCP_ESTABLISHED) { /* Fast path */ sock_rps_save_rxhash(sk, skb-&gt;rxhash); if (tcp_rcv_established(sk, skb, tcp_hdr(skb), skb-&gt;len)) { rsk = sk; goto reset; } return 0; } if (skb-&gt;len &lt; tcp_hdrlen(skb) || tcp_checksum_complete(skb)) goto csum_err; // æœåŠ¡å™¨æ”¶åˆ°ç¬¬ä¸€æ­¥æ¡æ‰‹SYNæˆ–è€…ç¬¬ä¸‰æ­¥ACKéƒ½ä¼šè¿›å…¥é‡Œ if (sk-&gt;sk_state == TCP_LISTEN) { // è¿›å…¥tcp_v4_hnd_reqä¸­æŸ¥çœ‹åŠè¿æ¥é˜Ÿåˆ— struct sock *nsk = tcp_v4_hnd_req(sk, skb); if (!nsk) goto discard; if (nsk != sk) { sock_rps_save_rxhash(nsk, skb-&gt;rxhash); if (tcp_child_process(sk, nsk, skb)) { rsk = nsk; goto reset; } return 0; } } else sock_rps_save_rxhash(sk, skb-&gt;rxhash); // æ ¹æ®ä¸åŒçš„socketçŠ¶æ€è¿›è¡Œä¸åŒçš„å¤„ç† if (tcp_rcv_state_process(sk, skb, tcp_hdr(skb), skb-&gt;len)) { rsk = sk; goto reset; } // ......}// file:net/ipv4/tcp_input.c// é™¤äº† ESTABLISHED å’Œ TIME_WAITï¼Œå…¶ä»–çŠ¶æ€ä¸‹çš„ TCP å¤„ç†éƒ½èµ°è¿™é‡Œint tcp_rcv_state_process(struct sock *sk, struct sk_buff *skb, struct tcphdr *th, unsigned len){ // ...... // ç¬¬ä¸€æ¬¡æ¡æ‰‹æˆ–ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼ŒæœåŠ¡å™¨æ”¶åˆ°ackåŒ… case TCP_LISTEN: if (th-&gt;ack) // å¦‚æœæ˜¯å“åº”åŒ… return 1; if (th-&gt;rst) goto discard; if (th-&gt;syn) { // å¦‚æœæ˜¯SYNæ¡æ‰‹åŒ… // conn_requestæ˜¯ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘tcp_v4_conn_request // æœåŠ¡å™¨å“åº” SYN çš„ä¸»è¦å¤„ç†é€»è¾‘éƒ½åœ¨è¿™ä¸ªtcp_v4_conn_requesté‡Œ if (icsk-&gt;icsk_af_ops-&gt;conn_request(sk, skb) &lt; 0) return 1; kfree_skb(skb); return 0; } // ......}// file: net/ipv4/tcp_ipv4.c// å“åº”SYNçš„ä¸»è¦å¤„ç†é€»è¾‘éƒ½åœ¨è¿™ä¸ªæ–¹æ³•ä¸­// 1.å…ˆåˆ¤æ–­ä¸€ä¸‹åŠè¿æ¥é˜Ÿåˆ—æ˜¯å¦æ»¡äº†// å¦‚æœæ»¡äº†å°±è¿›å…¥tcp_syn_flood_actionï¼ˆsyn floodæ”»å‡»ï¼‰æŸ¥çœ‹æ˜¯å¦å¼€å¯tcp_syncookieså†…æ ¸å‚æ•°ï¼Œæ²¡æœ‰å¼€å¯å°±ä¼šä¸¢å¼ƒè¯¥æ¡æ‰‹åŒ…// 2.åˆ¤æ–­å…¨è¿æ¥é˜Ÿåˆ—æ˜¯å¦æ»¡äº†// å¦‚æœæ»¡äº†å¹¶ä¸”å¦‚æœæœ‰young_ackï¼Œç›´æ¥ä¸¢å¼ƒ// young_ackï¼ˆæœªå¤„ç†å®Œçš„åŠè¿æ¥è¯·æ±‚ï¼‰æ˜¯åŠè¿æ¥é˜Ÿåˆ—é‡Œä¿æŒç€çš„ä¸€ä¸ªè®¡æ•°å™¨ã€‚// è®°å½•çš„æ˜¯åˆšæœ‰SYNåˆ°è¾¾ï¼Œæ²¡æœ‰è¢«SYN_ACKé‡ä¼ å®šæ—¶å™¨é‡ä¼ è¿‡SYN_ACK,// åŒæ—¶ä¹Ÿæ²¡æœ‰å®Œæˆè¿‡ä¸‰æ¬¡æ¡æ‰‹çš„sockæ•°é‡// 3.ç”³è¯·request_sockåˆ†é…å†…æ ¸å¯¹è±¡// 4.æ„é€ syn+ackåŒ…å¹¶å‘é€å“åº”ï¼Œtcp_v4_send_synack()æ–¹æ³•ä¸­ã€‚// 5.æ·»åŠ åˆ°åŠè¿æ¥é˜Ÿåˆ—ä¸­å¹¶å¼€å¯è®¡æ—¶å™¨é‡ä¼ ã€‚int tcp_v4_conn_request(struct sock *sk, struct sk_buff *skb){ // ...... // åˆ¤æ–­åŠè¿æ¥é˜Ÿåˆ—æ˜¯å¦æ»¡äº†ï¼Œå¦‚æœæ»¡äº†å°±è¿›å…¥syn_flood_warningå»åˆ¤æ–­æ˜¯å¦å¼€å¯ // äº† tcp_syncookies å†…æ ¸å‚æ•°ã€‚ // å¦‚æœé˜Ÿåˆ—æ»¡ï¼Œä¸”æœªå¼€å¯ tcp_syncookiesï¼Œé‚£ä¹ˆè¯¥æ¡æ‰‹åŒ…å°†ç›´æ¥è¢«ä¸¢å¼ƒ if (inet_csk_reqsk_queue_is_full(sk) &amp;&amp; !isn) if (net_ratelimit()) syn_flood_warning(skb); // ...... // åœ¨å…¨è¿æ¥çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæœ‰young_ackï¼Œé‚£ä¹ˆç›´æ¥ä¸¢ // young_ack æ˜¯åŠè¿æ¥é˜Ÿåˆ—é‡Œä¿æŒç€çš„ä¸€ä¸ªè®¡æ•°å™¨ã€‚ // è®°å½•çš„æ˜¯åˆšæœ‰SYNåˆ°è¾¾ï¼Œæ²¡æœ‰è¢«SYN_ACKé‡ä¼ å®šæ—¶å™¨é‡ä¼ è¿‡SYN_ACK, // åŒæ—¶ä¹Ÿæ²¡æœ‰å®Œæˆè¿‡ä¸‰æ¬¡æ¡æ‰‹çš„sockæ•°é‡ if (sk_acceptq_is_full(sk) &amp;&amp; inet_csk_reqsk_queue_young(sk) &gt; 1) goto drop; // åˆ†é…request_sockå†…æ ¸å¯¹è±¡ req = inet_reqsk_alloc(&amp;tcp_request_sock_ops); if (!req) goto drop; // ...... // tcp_v4_send_synack()æ„é€ å¹¶å‘é€syn+ackå“åº” if (tcp_v4_send_synack(sk, dst, req, (struct request_values *)&amp;tmp_ext) || want_cookie) goto drop_and_free; // æ·»åŠ åˆ°åŠè¿æ¥é˜Ÿåˆ—ï¼Œå¹¶å¼€å¯è®¡æ—¶å™¨ // è®¡æ—¶å™¨çš„ä½œç”¨æ˜¯åœ¨æŸä¸ªæ—¶é—´ä¹‹å†…è¿˜æ”¶ä¸åˆ°å®¢æˆ·ç«¯çš„ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼Œ // æœåŠ¡å™¨å°±ä¼šé‡ä¼ syn+ackåŒ… inet_csk_reqsk_queue_hash_add(sk, req, TCP_TIMEOUT_INIT); // ......}// file: net/ipv4/tcp_ipv4.c // æ„é€ å¹¶å‘é€syn + ackstatic int tcp_v4_send_synack(struct sock *sk, struct dst_entry *dst, struct request_sock *req, struct request_values *rvp){ // ...... // æ„é€ syn + ackåŒ… skb = tcp_make_synack(sk, dst, req, rvp); if (skb) { // å¦‚æœæ„å»ºæˆåŠŸ __tcp_v4_send_check(skb, ireq-&gt;loc_addr, ireq-&gt;rmt_addr); // å‘é€syn + ackå“åº” err = ip_build_and_send_pkt(skb, sk, ireq-&gt;loc_addr, ireq-&gt;rmt_addr, ireq-&gt;opt); err = net_xmit_eval(err); } dst_release(dst); return err;} å®¢æˆ·ç«¯å“åº”SYN + ACKæ¸…é™¤äº† connect æ—¶è®¾ç½®çš„é‡ä¼ å®šæ—¶å™¨ï¼ŒæŠŠå½“å‰ socket çŠ¶æ€è®¾ç½®ä¸º ESTABLISHEDï¼Œå¼€å¯ä¿æ´»è®¡æ—¶å™¨åå‘å‡ºç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„ ack ç¡®è®¤ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131// file:net/ipv4/tcp_input.cint tcp_rcv_state_process(struct sock *sk, struct sk_buff *skb, struct tcphdr *th, unsigned len){ // ...... // å®¢æˆ·ç«¯ç¬¬äºŒæ¬¡æ¡æ‰‹å¤„ç† case TCP_SYN_SENT: // å¤„ç† syn+ack åŒ… queued = tcp_rcv_synsent_state_process(sk, skb, th, len); if (queued &gt;= 0) return queued; /* Do step6 onward by hand. */ tcp_urg(sk, skb, th); __kfree_skb(skb); tcp_data_snd_check(sk); return 0; }}// file: net/ipv4/tcp_input.cstatic int tcp_rcv_synsent_state_process(struct sock *sk, struct sk_buff *skb, struct tcphdr *th, unsigned len){ // ...... if (th-&gt;ack) { // ...... // ä¿®æ”¹socketçŠ¶æ€ tcp_set_state(sk, TCP_ESTABLISHED); // è¿æ¥å»ºç«‹å®Œæˆ security_inet_conn_established(sk, skb); // ...... // åˆå§‹åŒ–æ‹¥å¡æ§åˆ¶ tcp_init_congestion_control(sk); // ...... // ä¿æ´»è®¡æ—¶å™¨æ‰“å¼€ if (sock_flag(sk, SOCK_KEEPOPEN)) inet_csk_reset_keepalive_timer(sk, keepalive_time_when(tp)); // ...... if (sk-&gt;sk_write_pending || icsk-&gt;icsk_accept_queue.rskq_defer_accept || icsk-&gt;icsk_ack.pingpong) { /* Save one ACK. Data will be ready after * several ticks, if write_pending is set. * * It may be deleted, but with this feature tcpdumps * look so _wonderfully_ clever, that I was not able * to stand against the temptation 8) --ANK */ // å»¶è¿Ÿç¡®è®¤ inet_csk_schedule_ack(sk); icsk-&gt;icsk_ack.lrcvtime = tcp_time_stamp; icsk-&gt;icsk_ack.ato = TCP_ATO_MIN; tcp_incr_quickack(sk); tcp_enter_quickack_mode(sk); inet_csk_reset_xmit_timer(sk, ICSK_TIME_DACK, TCP_DELACK_MAX, TCP_RTO_MAX);discard: __kfree_skb(skb); return 0; } else { // ç”³è¯·æ„é€ ackåŒ…ç„¶åè¿”å›å“åº” tcp_send_ack(sk); } return -1; } /* No ACK in the segment */ if (th-&gt;rst) { /* rfc793: * &quot;If the RST bit is set * * Otherwise (no ACK) drop the segment and return.&quot; */ goto discard_and_undo; } // ...... if (th-&gt;syn) { /* We see SYN without ACK. It is attempt of * simultaneous connect with crossed SYNs. * Particularly, it can be connect to self. */ // å¦‚æœæ˜¯synåŒ…ï¼Œå°±è®¾ç½®socketçŠ¶æ€ä¸ºTCP_SYN_RECV tcp_set_state(sk, TCP_SYN_RECV); // ...... // åºå·seq+1 tp-&gt;rcv_nxt = TCP_SKB_CB(skb)-&gt;seq + 1; tp-&gt;rcv_wup = TCP_SKB_CB(skb)-&gt;seq + 1; // ...... // å‘é€syn + ackåŒ… tcp_send_synack(sk); } // ......}// file:net/ipv4/tcp_output.cvoid tcp_send_ack(struct sock *sk){ // ...... // ç”³è¯·å’Œæ„é€ ackåŒ… buff = alloc_skb(MAX_TCP_HEADER, GFP_ATOMIC); // ...... // å‘é€ackåŒ… tcp_transmit_skb(sk, buff, 0, GFP_ATOMIC);} æœåŠ¡ç«¯å“åº”ACKæŠŠå½“å‰åŠè¿æ¥å¯¹è±¡åˆ é™¤ï¼Œåˆ›å»ºäº†æ–°çš„ sock ååŠ å…¥åˆ°å…¨è¿æ¥é˜Ÿåˆ—ä¸­ï¼Œæœ€åå°†æ–°è¿æ¥çŠ¶æ€è®¾ç½®ä¸º ESTABLISHEDã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105// æœåŠ¡ç«¯ç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„ackä¸ç¬¬ä¸€æ¬¡æ¡æ‰‹ä¸€æ ·ï¼Œéƒ½ä¼šè¿›å…¥åˆ°tcp_v4_do_rcvï¼Œæ­¤æ—¶å»åŠè¿æ¥é˜Ÿåˆ—ä¸­æŸ¥çœ‹å°±ä¸æ˜¯ç©ºçš„äº†ï¼Œä¼šä¿ç•™ç¬¬ä¸€æ¬¡æ¡æ‰‹çš„åŠè¿æ¥ä¿¡æ¯// file:net/ipv4/tcp_ipv4.cstatic struct sock *tcp_v4_hnd_req(struct sock *sk, struct sk_buff *skb){ // ...... // æŸ¥æ‰¾listen socketçš„åŠè¿æ¥é˜Ÿåˆ— struct request_sock *req = inet_csk_search_req(sk, &amp;prev, th-&gt;source, iph-&gt;saddr, iph-&gt;daddr); if (req) // å¦‚æœæ‰¾åˆ°äº† return tcp_check_req(sk, skb, req, prev); // ......}// fileï¼šnet/ipv4/tcp_minisocks.c// ä¸»è¦æ˜¯åˆ›å»ºä¸€ä¸ªå­socketï¼Œç„¶åæ¸…ç†åŠè¿æ¥é˜Ÿåˆ—ï¼Œæ·»åŠ åˆ°å…¨è¿æ¥é˜Ÿåˆ—ä¸­struct sock *tcp_check_req(struct sock *sk, struct sk_buff *skb, struct request_sock *req, struct request_sock **prev){ // ...... // åˆ›å»ºå­socket // å¯¹åº”çš„æ˜¯tcp_v4_syn_recv_sock å‡½æ•° child = inet_csk(sk)-&gt;icsk_af_ops-&gt;syn_recv_sock(sk, skb, req, NULL); if (child == NULL) goto listen_overflow; // æ¸…ç†åŠè¿æ¥é˜Ÿåˆ— inet_csk_reqsk_queue_unlink(sk, req, prev); inet_csk_reqsk_queue_removed(sk, req); // æ·»åŠ å…¨è¿æ¥é˜Ÿåˆ— inet_csk_reqsk_queue_add(sk, req, child); return child; // ......}// file:net/ipv4/tcp_ipv4.c// åˆ›å»ºsockå†…æ ¸å¯¹è±¡struct sock *tcp_v4_syn_recv_sock(struct sock *sk, struct sk_buff *skb, struct request_sock *req, struct dst_entry *dst){ // ...... // åˆ¤æ–­æ¥æ”¶é˜Ÿåˆ—æ˜¯å¦æ»¡äº†ï¼Œå¦‚æœæ»¡äº†å°±ä¿®æ”¹ä¸€ä¸‹è®¡æ•°å™¨ç„¶åä¸¢å¼ƒ if (sk_acceptq_is_full(sk)) goto exit_overflow; // åˆ›å»ºsock &amp;&amp; åˆå§‹åŒ– newsk = tcp_create_openreq_child(sk, req, skb); // ......}// file: include/net/inet_connection_sock.h static inline void inet_csk_reqsk_queue_unlink(struct sock *sk, struct request_sock *req, struct request_sock **prev){ // æŠŠè¿æ¥è¯·æ±‚å—ä»åŠè¿æ¥é˜Ÿåˆ—ä¸­åˆ é™¤ reqsk_queue_unlink(&amp;inet_csk(sk)-&gt;icsk_accept_queue, req, prev);}// file:net/ipv4/syncookies.cstatic inline void inet_csk_reqsk_queue_add(struct sock *sk, struct request_sock *req, struct sock *child){ // å°†æ¡æ‰‹æˆåŠŸçš„request_sockå¯¹è±¡æ’å…¥åˆ°å…¨è¿æ¥é˜Ÿåˆ—é“¾è¡¨çš„å°¾éƒ¨ reqsk_queue_add(&amp;inet_csk(sk)-&gt;icsk_accept_queue, req, sk, child);}// file:net/ipv4/tcp_input.cint tcp_rcv_state_process(struct sock *sk, struct sk_buff *skb, struct tcphdr *th, unsigned len){ // ...... switch (sk-&gt;sk_state) { case TCP_SYN_RECV: //ç¬¬ä¸‰æ¬¡æ¡æ‰‹å¤„ç† if (acceptable) { tp-&gt;copied_seq = tp-&gt;rcv_nxt; smp_mb(); // ä¿®æ”¹çŠ¶æ€ä¸ºå·²è¿æ¥ tcp_set_state(sk, TCP_ESTABLISHED); // ...... } else { return 1; } break; } // ......} accept()æœåŠ¡ç«¯acceptï¼šä»å·²å»ºç«‹å¥½çš„å…¨è¿æ¥é˜Ÿåˆ—ä¸­å–ç¬¬ä¸€ä¸ªè¿”å›ç»™ç”¨æˆ·è¿›ç¨‹ 123456789101112131415161718192021222324252627282930313233343536373839// file: net/ipv4/inet_connection_sock.cstruct sock *inet_csk_accept(struct sock *sk, int flags, int *err){ // ...... // ä»å…¨è¿æ¥é˜Ÿåˆ—ä¸­è·å–ç¬¬ä¸€ä¸ªå…ƒç´  newsk = reqsk_queue_get_child(&amp;icsk-&gt;icsk_accept_queue, sk); // ......}// file:include/net/request_sock.hstatic inline struct sock *reqsk_queue_get_child(struct request_sock_queue *queue, struct sock *parent){ // ä»å…¨è¿æ¥é˜Ÿåˆ—ä¸­è·å–ç¬¬ä¸€ä¸ªå…ƒç´  struct request_sock *req = reqsk_queue_remove(queue); struct sock *child = req-&gt;sk; WARN_ON(child == NULL); sk_acceptq_removed(parent); __reqsk_free(req); return child;}// file:include/net/request_sock.hstatic inline int reqsk_queue_removed(struct request_sock_queue *queue, struct request_sock *req){ struct listen_sock *lopt = queue-&gt;listen_opt; if (req-&gt;retrans == 0) --lopt-&gt;qlen_young; return --lopt-&gt;qlen;} æ€»ç»“æ¡æ‰‹å‰çš„å‡†å¤‡ å®¢æˆ·ç«¯ï¼šé€šè¿‡socket()æ–¹æ³•è·å–ä¸€ä¸ªfdæ–‡ä»¶æè¿°ç¬¦ï¼Œé€šè¿‡bind()æ–¹æ³•ç»‘å®šä¸€ä¸ªç«¯å£ï¼ˆå¯ä»¥ä¸è°ƒç”¨è¯¥æ–¹æ³•ï¼›å¦‚æœè°ƒç”¨äº†ï¼Œé¦–å…ˆä¼šåˆ¤æ–­ç”¨æˆ· ä¼ å…¥çš„ç«¯å£å·æ˜¯å¦å¤§äº1024ï¼Œç„¶åé€šè¿‡inet_csk_get_portæ–¹æ³•åˆ¤æ–­è¯¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼Œå¦‚æœè¢«å ç”¨å°±è¿”å›``EADDRINUSE`ã€‚åªä¼šåœ¨bindçŠ¶æ€çš„socketé‡Œé¢æŸ¥æ‰¾ï¼Œä¸ä¼šå»ESTABLISH çš„å“ˆå¸Œè¡¨è¿›è¡Œå¯ç”¨æ£€æµ‹ï¼‰ æœåŠ¡ç«¯ï¼šé€šè¿‡socket()æ–¹æ³•è·å–ä¸€ä¸ªfdæ–‡ä»¶æè¿°ç¬¦ï¼Œé€šè¿‡listen()æ–¹æ³•åˆå§‹åŒ–è¿æ¥é˜Ÿåˆ—ï¼ˆå…¨è¿æ¥é˜Ÿåˆ—å¤§å° = min(backlog, net.core.somaxconn)ï¼ŒåŠè¿æ¥é˜Ÿåˆ—å¤§å° = min(backlog, somaxconn, tcp_max_syn_backlog) + 1 å†å‘ä¸Šå–æ•´åˆ° 2 çš„å¹‚æ¬¡ï¼Œä½†æœ€å°ä¸èƒ½å°äº16ï¼‰ ç¬¬ä¸€æ¬¡æ¡æ‰‹ å®¢æˆ·ç«¯ï¼šæ ¹æ®ä¼ å…¥çš„fdæ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰¾åˆ°å¯¹åº”çš„socketå†…æ ¸å¯¹è±¡ã€‚è°ƒç”¨sock-&gt;ops-&gt;connectæ–¹æ³•ï¼ˆinet_stream_connectï¼‰ï¼Œç„¶ååœ¨tcp_v4_connect()æ–¹æ³•ä¸­å°†socketçŠ¶æ€è®¾ç½®ä¸ºTCP_SYN_SENTï¼Œé€šè¿‡_inet_hash_connect()æ–¹æ³•åŠ¨æ€é€‰æ‹©ä¸€ä¸ªç«¯å£å·ï¼ˆé¦–å…ˆåˆ¤æ–­æ˜¯å¦bind()äº†ä¸€ä¸ªç«¯å£ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±æ ¹æ®ç›®æ ‡åœ°å€å’Œç«¯å£ç­‰ä¿¡æ¯ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œç„¶ååœ¨æœ¬åœ°ç«¯å£èŒƒå›´ä¸­é€šè¿‡è¿™ä¸ªéšæœºæ•°é€æ¸å¢åŠ éå†ï¼Œå¦‚æœæ˜¯æœ¬åœ°é…ç½®çš„ä¿ç•™ç«¯å£å°±è·³è¿‡ï¼Œå¦‚æœä¸æ˜¯å°±éå†å·²ç»ä½¿ç”¨çš„ç«¯å£çš„å“ˆå¸Œé“¾è¡¨ï¼ˆhinfo-&gt;bhashï¼‰ï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»è¢«ä½¿ç”¨ï¼Œå¦‚æœè¯¥ç«¯å£å·²ç»è¢«ä½¿ç”¨å¹¶ä¸”TCPè¿æ¥ä¸­çš„å››å…ƒç»„ä¸å½“å‰å»ºç«‹çš„å››å…ƒç»„å®Œå…¨ä¸€è‡´ï¼Œå°±ä¸èƒ½ä½¿ç”¨ï¼Œç»§ç»­éå†ã€‚æ‰¾åˆ°äº†å°±è¿”å›ç«¯å£ï¼Œæ²¡æ‰¾åˆ°å°±æç¤ºAddress already in useï¼‰ã€‚é€šè¿‡tcp_connect()æ„å»ºskbå¹¶æ·»åŠ åˆ°å‘é€é˜Ÿåˆ—sk_write_queueä¸Šï¼Œå¯åŠ¨é‡ä¼ å®šæ—¶å™¨ï¼Œè¿›è¡Œå‘é€ã€‚ ç¬¬äºŒæ¬¡æ¡æ‰‹ æœåŠ¡ç«¯ï¼šé¦–å…ˆä¼šåˆ¤æ–­åŠè¿æ¥é˜Ÿåˆ—æ˜¯å¦æ»¡äº†ï¼Œå¦‚æœæ»¡äº†å°±è¿›å…¥syn_flood_warningå»åˆ¤æ–­æ˜¯å¦å¼€å¯äº† tcp_syncookies å†…æ ¸å‚æ•°ã€‚å¦‚æœé˜Ÿåˆ—æ»¡ï¼Œä¸”æœªå¼€å¯ tcp_syncookiesï¼Œé‚£ä¹ˆè¯¥æ¡æ‰‹åŒ…å°†ç›´æ¥è¢«ä¸¢å¼ƒï¼Œç„¶åå»åˆ¤æ–­ä¸€ä¸‹å…¨è¿æ¥é˜Ÿåˆ—æ˜¯å¦æ»¡äº†ï¼Œå¦‚æœæ»¡äº†å¹¶ä¸”æœ‰young_ackï¼Œç›´æ¥ä¸¢å¼ƒï¼Œå¦åˆ™å‘å‡º synackã€‚ç”³è¯·request_sock æ·»åŠ åˆ°åŠè¿æ¥é˜Ÿåˆ—ä¸­ï¼ŒåŒæ—¶å¯åŠ¨å®šæ—¶å™¨ã€‚young_ackï¼ˆæœªå¤„ç†å®Œçš„åŠè¿æ¥è¯·æ±‚ï¼‰æ˜¯åŠè¿æ¥é˜Ÿåˆ—é‡Œä¿æŒç€çš„ä¸€ä¸ªè®¡æ•°å™¨ã€‚è®°å½•çš„æ˜¯åˆšæœ‰SYNåˆ°è¾¾ï¼Œæ²¡æœ‰è¢«SYN_ACKé‡ä¼ å®šæ—¶å™¨é‡ä¼ è¿‡SYN_ACK,åŒæ—¶ä¹Ÿæ²¡æœ‰å®Œæˆè¿‡ä¸‰æ¬¡æ¡æ‰‹çš„sockæ•°é‡ã€‚ å®¢æˆ·ç«¯ï¼šæ¸…é™¤é‡ä¼ å®šæ—¶å™¨ï¼Œå°†å½“å‰socketçŠ¶æ€è®¾ç½®ä¸ºESTABLISHEDï¼Œå¼€å¯ä¿æ´»è®¡æ—¶å™¨åå‘å‡ºackç¡®è®¤ ç¬¬ä¸‰æ¬¡æ¡æ‰‹ æœåŠ¡ç«¯ï¼šæ‰¾åˆ°åŠè¿æ¥é˜Ÿåˆ—ä¸­çš„request_sockå¯¹è±¡ï¼Œåˆ¤æ–­å…¨è¿æ¥é˜Ÿåˆ—æ˜¯å¦æ»¡äº†ï¼Œå¦‚æœæ»¡äº†å°±ä¿®æ”¹è®¡æ•°å™¨ç„¶åä¸¢å¼ƒï¼Œæ²¡æ»¡å°±åˆ›å»ºæ–°çš„sockå¯¹è±¡ï¼Œå°†åŠè¿æ¥ä¸­çš„è¿æ¥è¯·æ±‚è¿›è¡Œåˆ é™¤ï¼Œæ·»åŠ åˆ°å…¨è¿æ¥é˜Ÿåˆ—ä¸­ï¼Œå°†çŠ¶æ€è®¾ç½®ä¸ºTCP_ESTABLISHEDã€‚ æœ€å è°ƒç”¨accept()æ–¹æ³•ä»å…¨è¿æ¥é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªè¿”å›ç»™ç”¨æˆ·è¿›ç¨‹","link":"/2021/07/11/Linux%E4%B8%ADTCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E7%9A%84%E5%AE%9E%E7%8E%B0/"},{"title":"SpringIOCå¤§è‡´æµç¨‹","text":"æ˜¯ä»€ä¹ˆï¼Ÿâ€‹ å®˜æ–¹æ–‡æ¡£çš„è§£é‡Šæ˜¯ï¼šIoCä¹Ÿç§°ä¸ºä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰ã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œå¯¹è±¡ä»…é€šè¿‡æ„é€ å‡½æ•°å‚æ•°ï¼Œå·¥å‚æ–¹æ³•çš„å‚æ•°æˆ–åœ¨æ„é€ æˆ–ä»å·¥å‚æ–¹æ³•è¿”å›ååœ¨å¯¹è±¡å®ä¾‹ä¸Šè®¾ç½®çš„å±æ€§æ¥å®šä¹‰å…¶ä¾èµ–é¡¹ï¼ˆå³ï¼Œä¸å®ƒä»¬ä¸€èµ·ä½¿ç”¨çš„å…¶ä»–å¯¹è±¡ï¼‰ ã€‚ç„¶åï¼Œå®¹å™¨åœ¨åˆ›å»ºbeanæ—¶æ³¨å…¥é‚£äº›ä¾èµ–é¡¹ã€‚ä»æœ¬è´¨ä¸Šè®²ï¼Œæ­¤è¿‡ç¨‹æ˜¯é€šè¿‡ä½¿ç”¨ç±»çš„ç›´æ¥æ„é€ æˆ–è¯¸å¦‚æœåŠ¡å®šä½å™¨æ¨¡å¼ä¹‹ç±»çš„æœºåˆ¶æ¥æ§åˆ¶å…¶ä¾èµ–å…³ç³»çš„å®ä¾‹åŒ–æˆ–ä½ç½®çš„Beanæœ¬èº«çš„é€†è¿‡ç¨‹ï¼ˆå› æ­¤ï¼Œå…¶åç§°ä¸ºControl Inversionï¼‰ã€‚ â€‹ ç®€å•æ¥è¯´ï¼šå°±æ˜¯æˆ‘ä»¬å°†ä¸€ä¸ªä¸ªçš„beanå¯¹è±¡äº¤ç»™IoCå»ç®¡ç†ï¼Œä»–ä¼šå¸®åŠ©æˆ‘ä»¬å»åˆ›å»ºå¯¹è±¡å®ä¾‹ã€å¡«å……å±æ€§ã€åˆå§‹åŒ–ã€æ·»åŠ ç›‘å¬å™¨ç­‰è¿‡ç¨‹ã€‚ ç±»å›¾â€‹ æˆ‘ä»¬ä»¥å¸¸ç”¨çš„ClassPathXmlApplicationContextä¸ºä¾‹ å¤§è‡´è¿‡ç¨‹ â€‹ é¦–å…ˆï¼Œä¸€ä¸ªIoCå®¹å™¨åº”åˆ›å»ºä¸€ä¸ªå·¥å‚ï¼ˆDefaultListableBeanFactoryï¼‰ï¼Œå¯ä»¥ä½¿æˆ‘ä»¬è¯»å–çš„èµ„æºæ–‡ä»¶å¯ä»¥å­˜æ”¾ã€‚ â€‹ ç„¶åï¼Œå°†é…ç½®æ–‡ä»¶é€šè¿‡ä¸€ä¸ªè§„èŒƒï¼ˆBeanDefinitionReaderï¼‰åŠ è½½å‡ºæ¥ã€‚ â€‹ æ¥ç€ï¼Œæ˜¯beanå¯¹è±¡å®ä¾‹åŒ–ä¹‹å‰çš„ä¸€äº›å‡†å¤‡ï¼ˆåˆå§‹åŒ–å•Šã€äº‹ä»¶å¤„ç†å™¨ã€æ³¨å†Œç»„ä»¶ç­‰ï¼‰ï¼›ä¾‹å¦‚ä¸Šå›¾ä¸­çš„BeanFactoryPostProcessorã€å¤šæ’­å™¨ç­‰ã€‚ â€‹ é‡è¦çš„åœ°æ–¹æ¥äº†ï¼Œåˆ›å»ºä¸€ä¸ªä¸ªçš„éæ‡’åŠ è½½çš„æˆå“Beanå¯¹è±¡ï¼ˆfinishBeanFactoryInitializationæ–¹æ³•ï¼‰ã€‚ â€‹ æœ€åï¼Œæ˜¯ä¸€äº›äº‹ä»¶çš„å‘å¸ƒã€ç¼“å­˜ã€é”€æ¯ç­‰ã€‚ æºç åˆ†æâ€‹ ä»ClassPathXmlApplicationContextå¼€å§‹åˆ†æã€‚åœ¨å®ƒçš„æ„é€ æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹è§è°ƒç”¨äº†çˆ¶ç±»ï¼ˆAbstractApplicationContextç±»ï¼‰çš„æ„é€ æ–¹æ³•ã€è®¾ç½®é…ç½®æ–‡ä»¶çš„åŠ è½½è·¯å¾„ä»¥åŠæ ¸å¿ƒæ–¹æ³•refresh()æ–¹æ³•ã€‚ â€‹ çˆ¶ç±»AbstractApplicationContextçš„æ„é€ æ–¹æ³• â€‹ setConfigLocations()æ–¹æ³• â€‹ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿›å…¥æ ¸å¿ƒæ–¹æ³•**refresh()**ã€‚ â€‹ æˆ‘ä»¬é‡ç‚¹çœ‹åºå·2å’Œåºå·11ï¼Œå…¶ä»–æœ‰å…´è¶£å¯ä»¥è‡ªå·±ç‚¹è¿›å»çœ‹çœ‹ã€‚ â€‹ obtainFreshBeanFactory()æ–¹æ³• â€‹ â€‹ è·Ÿè¿›refreshBeanFactory()æ–¹æ³•ï¼Œåœ¨AbstractRefreshableApplicationContextç±»ä¸­å¯ä»¥æ‰¾åˆ°refreshBeanFactory()è¿™ä¸ªæ–¹æ³• â€‹ createBeanFactory()æ–¹æ³•ä¸­ â€‹ loadBeanDefinitions()æ–¹æ³•ï¼Œä¹Ÿæ˜¯å§”æ´¾ç»™å­ç±»å»å®ç°ã€‚ æˆ‘ä»¬è¿›å»å­ç±»AbstractXmlApplicationContextç±»çš„loadBeanDefinition()æ–¹æ³•ã€‚åœ¨è¿™é‡Œè¿›è¡Œäº†é…ç½®æ–‡ä»¶è¯»å–è§„èŒƒçš„å®šä¹‰ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¿›loadBeanDefinitions()æ–¹æ³•ã€‚ loadBeanDefinitions()æ–¹æ³•ã€‚ä¼ å…¥çš„å¯èƒ½æ˜¯ä¸ªString[]æˆ–è€…Resource[]ç±»å‹ã€‚ä½†æ˜¯å¤§è‡´æµç¨‹éƒ½å·®ä¸å¤šï¼šString[]-&gt;String-&gt;Resource[]-&gt;Resource-&gt;Document-&gt;BeanDefinitionã€‚è¿™é‡Œå°±ä¸è¿‡å¤šæ·±å…¥äº†ï¼Œæ„Ÿå…´è¶£å¯ä»¥ç…§è¿™ä¸ªæµç¨‹çœ‹ä¸‹å»ã€‚ èµ„æºæ–‡ä»¶åŠ è½½å®Œæˆåï¼Œæˆ‘ä»¬çš„BeanFactoryå·®ä¸å¤šå°±åˆ›å»ºå¥½äº†ã€‚æ¥ç€ï¼Œæˆ‘ä»¬åˆ°IoCæœ€é‡è¦çš„è¿‡ç¨‹ï¼ŒBeanå¯¹è±¡ï¼ˆä¸æ˜¯æ‡’åŠ è½½çš„ï¼‰çš„å®ä¾‹åŒ–å’Œåˆå§‹åŒ–ã€‚è¿™é‡Œä¸ºä»€ä¹ˆå°†å®ä¾‹åŒ–å’Œåˆå§‹åŒ–åˆ†å¼€è¯´å‘¢ï¼Œæ˜¯æƒ³æ›´å¥½çš„å¸®åŠ©ç†è§£Beanå¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ã€‚å…¶å®Springä¸­æ›´åŠ çš„ç»†åˆ†äº†ä¸€ä¸‹ï¼Œåˆ†æˆäº†å®ä¾‹åŒ–ï¼ˆcreateBeanInstance()æ–¹æ³•ï¼‰ã€å¡«å……å±æ€§ï¼ˆpopulateBean()æ–¹æ³•ï¼‰å’Œåˆå§‹åŒ–ï¼ˆinitializeBean()æ–¹æ³•ï¼‰ã€‚ â€‹ å®ä¾‹åŒ–ï¼šåœ¨å †ä¸­å¼€è¾Ÿäº†ä¸€å—ç©ºé—´ã€‚å±æ€§éƒ½æ˜¯ç³»ç»Ÿé»˜è®¤å€¼ã€‚ â€‹ åˆå§‹åŒ–ï¼šç»™å±æ€§å®Œæˆå…·ä½“çš„èµ‹å€¼æ“ä½œï¼Œè°ƒç”¨å…·ä½“çš„åˆå§‹åŒ–æ–¹æ³•ã€‚ â€‹ å¥½äº†ï¼Œæˆ‘ä»¬è¿›å…¥finishBeanFactoryInitialization()æ–¹æ³•ï¼Œé‡Œé¢ä½ ä¼šçœ‹åˆ°ä¸€äº›å¯¹beanFactoryçš„å±æ€§è®¾ç½®ï¼Œå…¶ä¸­é‡ç‚¹çš„æ˜¯preInstantiateSingletons()æ–¹ï¼Œç‚¹è¿›å»ï¼Œå®ƒä¼šè°ƒç”¨DefaultListableBeanFactoryçš„preInstantiateSingletons()æ–¹æ³•ã€‚ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°**getBean()**æ–¹æ³•ï¼Œè¿™é‡Œå°±æ˜¯å‡†å¤‡å¼€å§‹è¿›è¡Œbeanå¯¹è±¡çš„åˆ›å»ºäº†ã€‚ ç‚¹è¿›å»ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœŸæ­£æ‰§è¡Œçš„æ˜¯**doGetBean()**æ–¹æ³• doGetBean()æ–¹æ³•ï¼Œå°±æ˜¯æ ¹æ®ä¸åŒçš„Beané‡‡ç”¨ä¸åŒçš„åˆ›å»ºç­–ç•¥ã€‚ å¦‚æœBeanæ˜¯å•ä¾‹çš„ï¼Œåˆ™åœ¨å®¹å™¨åˆ›å»ºä¹‹å‰å…ˆä»ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œç¡®ä¿æ•´ä¸ªå®¹å™¨åªå­˜åœ¨ä¸€ä¸ªå®ä¾‹å¯¹è±¡ å¦‚æœBeanæ˜¯åŸå‹æ¨¡å¼çš„ï¼Œåˆ™å®¹å™¨æ¯æ¬¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹å¯¹è±¡ æŒ‡å®šäº†Beançš„ç”Ÿå‘½å‘¨æœŸ â€‹ æˆ‘ä»¬è¿›å…¥createBean()ï¼Œå‘ç°è¿˜æœ‰ä¸€ä¸ªdoCreateBeanæ–¹æ³•()ï¼Œç»ˆäºï¼Œæˆ‘ä»¬åˆ°äº†çœŸæ­£åˆ›å»ºBeanå¯¹è±¡çš„æ–¹æ³•ã€‚ç‚¹è¿›å»ã€‚ â€‹ æˆ‘ä»¬å‘ç°æˆ‘ä»¬ç»ˆäºæ‰¾åˆ°äº†ä¹‹å‰æ‰€è¯´çš„é‚£ä¸‰ä¸ªæ–¹æ³•äº†ï¼Œåˆ›å»ºã€å¡«å……å’Œåˆå§‹åŒ–ã€‚ â€‹ createBeanInstance()æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªBeanWrapperï¼Œbeançš„å°è£…ç±»ã€‚ â€‹ populateBean()åˆ™æ˜¯å°†beançš„ä¸€äº›å±æ€§å­—æ®µè¿›è¡Œè§£æã€å¡«å……ã€‚ â€‹ åœ¨initializeBean()ä¸­ åˆ°æ­¤ï¼Œæˆ‘ä»¬ä¸€å¼€å§‹çš„æµç¨‹å›¾æ‰€æœ‰çš„åœ°æ–¹å·®ä¸å¤šéƒ½å®Œæˆäº†ã€‚å…¶ä¸­æœ‰äº›ç»†èŠ‚æ–¹é¢æ²¡ç‚¹è¿›å»çœ‹çœ‹ï¼Œä¸»è¦æ˜¯å¤§è‡´äº†è§£IoCçš„è¿‡ç¨‹ã€‚å¯ä»¥è‡ªè¡Œdebugè¿›å»çœ‹çœ‹ã€‚","link":"/2021/04/23/SpringIOC%E5%A4%A7%E8%87%B4%E6%B5%81%E7%A8%8B/"},{"title":"SpringMVCå¤§è‡´è¿‡ç¨‹","text":"MVCMVCæ˜¯ä¸€ç§æ¡†æ¶æ¨¡å¼ï¼Œå°†Må’ŒVçš„å®ç°ä»£ç åˆ†ç¦»ã€‚ Mï¼ˆModelï¼‰ï¼šæ¨¡å‹ï¼Œä¸šåŠ¡è§„åˆ™ã€‚å¤„ç†è¯·æ±‚ã€è¿”å›æ•°æ®ï¼Œæ•°æ®å¯ä»¥è¢«å¤šä¸ªè§†å›¾ä½¿ç”¨ã€‚ Vï¼ˆViewï¼‰ï¼šè§†å›¾ï¼Œå°±æ˜¯ä½ èƒ½çœ‹åˆ°å¹¶èƒ½äº¤äº’çš„ç•Œé¢ã€‚ Cï¼ˆControllerï¼‰ï¼šæ§åˆ¶å™¨ï¼Œè´Ÿè´£æ¥æ”¶ç”¨æˆ·çš„è¯·æ±‚å»è°ƒç”¨å“ªä¸ªMå»å¤„ç†ï¼Œç„¶åå†è¿”å›ç¡®å®šå“ªä¸ªVæ˜¾ç¤ºæ•°æ®ã€‚ Servletä¸ºä»€ä¹ˆåœ¨è¿™é‡Œè®²ä¸€ä¸‹Servletï¼Ÿå…¶å®SpringMVCå°±æ˜¯ä¸€ä¸ªServletï¼Œæ‰€ä»¥å¼„æ¸…æ¥šServletçš„è¿‡ç¨‹ï¼ŒSpringMVCçš„å°±ç±»ä¼¼äº†ã€‚ æˆ‘ä»¬ç°æ¥çœ‹ä¸€ä¸‹Servletçš„ç±»å›¾å…³ç³»ã€‚ SpringMVCSpringMVCå’ŒServletçš„å…³ç³» å¤§è‡´è¿‡ç¨‹ åˆå§‹åŒ–çš„æ—¶å€™ç”¨äº†ä¸€ä¸ªMapä¿å­˜URLå’ŒControllerç±»çš„å¯¹åº”å…³ç³» æ ¹æ®è¯·æ±‚çš„URLæ‰¾åˆ°å¯¹åº”çš„Controllerï¼Œç„¶åä»Controllerä¸­æ‰¾åˆ°å¤„ç†è¯·æ±‚çš„æ–¹æ³• å°†è¯·æ±‚å‚æ•°ç»‘å®šåˆ°æ–¹æ³•çš„å½¢å‚ä¸Šï¼Œæ‰§è¡Œæ–¹æ³•å¤„ç†è¯·æ±‚ï¼Œå¹¶è¿”å›ç»“æœè§†å›¾ ä¹å¤§ç»„ä»¶åœ¨DispathcherServletç±»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°SpringMVCçš„ä¹å¤§ç»„ä»¶ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667/** * ä¹å¤§ç»„ä»¶ä¹‹ä¸€ * ç”¨äºå¤„ç†ä¸Šä¼ è¯·æ±‚ã€‚å°†æ™®é€šè¯·æ±‚å°è£… */@Nullableprivate MultipartResolver multipartResolver;/** * ä¹å¤§ç»„ä»¶ä¹‹ä¸€ï¼šæœ¬åœ°è¯­è¨€è§£æå™¨ * ä»è¯·æ±‚ä¸­è§£æå‡ºLocalã€‚ä¸»è¦ç”¨äºi18nã€‚ */@Nullableprivate LocaleResolver localeResolver;/** * ä¹å¤§ç»„ä»¶ä¹‹ä¸€ï¼šæ¨¡æ¿è§£æå™¨ * è´Ÿè´£ä»è¯·æ±‚ä¸­è§£æå‡ºä¸»é¢˜åï¼Œä¸»é¢˜å°±æ˜¯æ ·å¼ã€å›¾ç‰‡ä»¥åŠå®ƒä»¬æ‰€å½¢æˆçš„æ˜¾ç¤ºæ•ˆæœçš„é›†åˆã€‚ç›¸å…³ç±»ï¼š * ThemeSourceï¼šæ ¹æ®ä¸»é¢˜åæŸ¥æ‰¾å…·ä½“çš„ä¸»é¢˜ */@Nullableprivate ThemeResolver themeResolver;/** * ä¹å¤§ç»„ä»¶ä¹‹ä¸€ * ç”¨æ¥æŸ¥æ‰¾Handlerã€‚å¯ä»¥æ˜¯ç±»ä¹Ÿå¯ä»¥æ˜¯æ–¹æ³•ã€‚ * æ¯”å¦‚æ ‡æ³¨äº†@RequestMappingçš„æ¯ä¸ªæ–¹æ³•éƒ½å¯ä»¥çœ‹æˆä¸€ä¸ªHandler */@Nullableprivate List&lt;HandlerMapping&gt; handlerMappings;/** * ä¹å¤§ç»„ä»¶ä¹‹ä¸€ï¼šé€‚é…å™¨ * å› ä¸ºServletçš„æ–¹æ³•ç»“æ„éƒ½æ˜¯doService(HttpServletRequest req, * HttpServletResponse resp)å½¢å¼çš„ï¼Œ * å°†SpringMVCä¸­çš„Handlerè½¬ä¸ºè¿™ç§æ ¼å¼ã€‚ */@Nullableprivate List&lt;HandlerAdapter&gt; handlerAdapters;/** * ä¹å¤§ç»„ä»¶ä¹‹ä¸€ï¼šå¼‚å¸¸å¤„ç†å™¨ * å¤„ç†Handleräº§ç”Ÿçš„å¼‚å¸¸æƒ…å†µçš„ç»„ä»¶ */@Nullableprivate List&lt;HandlerExceptionResolver&gt; handlerExceptionResolvers;/** * ä¹å¤§ç»„ä»¶ä¹‹ä¸€ * ä»è¯·æ±‚ä¸­è·å–ViewName */@Nullableprivate RequestToViewNameTranslator viewNameTranslator;/** * ä¹å¤§ç»„ä»¶ä¹‹ä¸€ * ç”¨äºç®¡ç†FlashMapã€‚FlashMapç”¨äºé‡å®šå‘æ—¶çš„å‚æ•°ä¼ é€’ */@Nullableprivate FlashMapManager flashMapManager;/** * ä¹å¤§ç»„ä»¶ä¹‹ä¸€ï¼šè§†å›¾è§£æå™¨ * å°†Stringç±»å‹çš„è§†å›¾åå’ŒLocaleè§£æä¸ºViewç±»å‹çš„è§†å›¾ï¼Œåªæœ‰ä¸€ä¸ªresolveViewName()æ–¹æ³•ã€‚ */@Nullableprivate List&lt;ViewResolver&gt; viewResolvers; æºç è§£æSpringMVCåˆå§‹åŒ–é¦–å…ˆæˆ‘ä»¬ä»Servletçš„åˆå§‹åŒ–init()å¼€å§‹ï¼Œåœ¨DispatcherServletç±»ä¸­ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å‘ç°Servletçš„åˆå§‹åŒ–æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å»çˆ¶ç±»ä¸­å»æ‰¾æ‰¾ã€‚åœ¨HttpServletBeanä¸­æˆ‘ä»¬ç»ˆäºå‘ç°äº†init()æ–¹æ³•ã€‚ æˆ‘ä»¬å¯ä»¥çœ‹è§è¿™é‡Œåªæ˜¯å¯¹ä¸€äº›åˆå§‹çš„å±æ€§å‚æ•°è¿›è¡Œäº†è®¾ç½®ï¼Œå…·ä½“é€šè¿‡å­ç±»è°ƒç”¨initServletBean()è¿™ä¸ªæ–¹æ³•æ¥è°ƒç”¨ã€‚æˆ‘ä»¬ç‚¹è¿›å»çœ‹çœ‹ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å­ç±»FrameworkServletçš„initServletBean()æ–¹æ³•ä¸­æ·»åŠ äº†ä¸€äº›æ—¥å¿—ç›¸å…³çš„ä¿¡æ¯ï¼Œä»¥åŠä¸€ä¸ªé‡è¦çš„æ–¹æ³•**initWebApplicationContext()**ï¼Œè¿™ä¸ªæ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨æˆ‘ä»¬IoCå®¹å™¨çš„refresh()æ–¹æ³•ã€‚å‰©ä¸‹çš„initFrameworkServlet()è¿™ä¸ªæ–¹æ³•æ˜¯ä¸ªç©ºæ–¹æ³•ï¼Œå¯ä»¥ç•™ç»™æˆ‘ä»¬è¿›è¡Œæ‰©å±•ã€‚æˆ‘ä»¬ç»§ç»­è·Ÿè¿›initWebApplicationContext()æ–¹æ³•ã€‚ æˆ‘ä»¬è¿›å…¥createWebApplicationContext()æ–¹æ³•ä¸­ configureAndRefreshWebApplicationContext()æ–¹æ³•ï¼Œç»ˆäºæˆ‘ä»¬çœ‹è§äº†refresh()æ–¹æ³• å…¶å®å°±æ˜¯IoCå®¹å™¨çš„åˆå§‹åŒ–ã€‚ æˆ‘ä»¬æ¥ç€çœ‹SpringMVCä¹å¤§ç»„ä»¶çš„åˆå§‹åŒ– åœ¨DispatcherServletä¸­ï¼ŒonRefresh()æ–¹æ³•å’ŒinitStrategies()æ–¹æ³• åˆ°æ­¤ï¼ŒSpringMVCåˆå§‹åŒ–å·®ä¸å¤šå°±å®Œæˆäº†ï¼Œä¸‹é¢å»çœ‹çœ‹SpringMVCæ˜¯å¦‚ä½•å¤„ç†è¯·æ±‚çš„ã€‚ SpringMVCå¤„ç†è¯·æ±‚åœ¨doService()æ–¹æ³•ä¸­ã€‚å…¶ä¸­æœ€æ ¸å¿ƒçš„æ–¹æ³•æ˜¯doDispatch()æ–¹æ³•ã€‚ æˆ‘ä»¬è¿›å…¥doDispatch()ã€‚ è¿™é‡Œé¢çš„å¤„ç†å¤§è‡´æµç¨‹æ˜¯ï¼š å…ˆåˆ¤æ–­ä¸€ä¸‹æ˜¯ä¸æ˜¯æ–‡ä»¶ä¸Šä¼  é€šè¿‡getHandler()æ–¹æ³•æ‰¾åˆ°è¯·æ±‚å¯¹åº”çš„å¤„ç†handlerçš„Beanå®ä¾‹ä»¥åŠæ·»åŠ ä¸€äº›æ‹¦æˆªå™¨ï¼Œå°è£…æˆä¸€ä¸ªHandlerExecutionChainè¯·æ±‚å¤„ç†é“¾å¯¹è±¡ è·å–ä¸€ä¸ªæ”¯æŒçš„å¤„ç†é€‚é…å™¨HandlerAdapterã€‚getHandlerAdapter() è°ƒç”¨ç»™å®šçš„handlerå¤„ç†è¯·æ±‚ï¼Œæ‰§è¡Œå¹¶è¿”å›ç»“æœè§†å›¾ã€‚handle() å¤„ç†ä¸€ä¸‹å¤„ç†çš„ç»“æœï¼Œå¯ä»¥æ˜¯ModelAndViewæˆ–è€…æ˜¯ä¸€ä¸ªå¼‚å¸¸ã€‚processDispatchResult() æˆ‘ä»¬å…ˆå»çœ‹çœ‹getHandler()æ–¹æ³•ã€‚ ç»§ç»­ç‚¹è¿›å»ï¼Œåœ¨AbstractHandlerMappingçš„getHandler()æ–¹æ³•ä¸­ã€‚ æ˜¯ä¸æ˜¯çœ‹è§äº†ä¸€ä¸ªæˆ‘ä»¬å¾ˆç†Ÿæ‚‰çš„æ–¹æ³•ï¼ŸgetBean()ã€‚è¿™æ—¶å€™æˆ‘ä»¬å°±è·å–åˆ°äº†å¯¹åº”handlerçš„å®ä¾‹äº†ï¼Œç„¶åå°±æ˜¯è°ƒç”¨getHandlerExecutionChain()æ–¹æ³•ï¼Œå°†ä¸€äº›æ‹¦æˆªå™¨ä¸ä¹‹å°è£…ä¸ºä¸€ä¸ªHandlerExecutionChainã€‚ è¿™æ—¶å€™ä¸€ä¸ªHandlerExecutionChainå°±å®Œæˆäº†ã€‚ ç„¶åæˆ‘ä»¬å»çœ‹çœ‹getHandlerAdapter()æ–¹æ³•ã€‚ æ¥ä¸‹æ¥æ˜¯handle()æ–¹æ³•ï¼Œæˆ‘ä»¬ç‚¹è¿›å»çœ‹çœ‹ï¼Œä»–ä¼šè°ƒç”¨AbstractHandlerMethodAdapterç±»çš„handleæ–¹æ³•ï¼Œæˆ‘ä»¬ä¼šå‘ç°å®ƒæœ€åä¼šè°ƒç”¨handleInternal()è¿™ä¸ªæ–¹æ³•ï¼Œäº¤ç»™å­ç±»å»å®ç°ã€‚ è¿›å…¥handleInternal()æ–¹æ³• æˆ‘ä»¬å¯ä»¥çœ‹è§éƒ½ä¼šè°ƒç”¨invokeHandlerMethod()è¿™ä¸ªæ–¹æ³•ï¼Œè·Ÿè¿›å»ã€‚éƒ½æ˜¯äº›ä»€ä¹ˆaddXXXã€setXXXã€registerXXXæ–¹æ³•ã€‚æœ€é‡è¦çš„æ˜¯invokeAndHandle()æ–¹æ³•ï¼Œå®ƒå®Œæˆäº†å°†è¯·æ±‚ä¸­çš„å‚æ•°å’Œæ–¹æ³•ä¸­çš„å‚æ•°è¿›è¡Œç»‘å®šï¼Œé€šè¿‡@RequestParamæ³¨è§£æˆ–è€…æ˜¯ASMæ¡†æ¶ã€‚ invokeAndHandle()æ–¹æ³• ç„¶åå°±æ˜¯è¿”å›ç›¸åº”çš„ModelAndViewäº†ã€‚ æ¥ä¸‹æ¥å¯¹ModelAndViewè¿›è¡Œå¤„ç†ï¼Œåœ¨processDispatchResult()æ–¹æ³•ä¸­ã€‚å¯ä»¥çœ‹è§å¯¹å¼‚å¸¸çš„å¤„ç†å’Œå¯¹æ­£å¸¸è§†å›¾çš„å¤„ç†ã€‚ å…¶ä¸­è°ƒç”¨äº†render()æ–¹æ³•å¯¹è§†å›¾è¿›è¡Œæ¸²æŸ“ã€‚ åˆ°æ­¤ï¼Œä¸€ä¸ªè¯·æ±‚çš„å¤„ç†å·®ä¸å¤šå°±å®Œæˆäº†ã€‚SpringMVCçš„å·¥ä½œä¹Ÿå·®ä¸å¤šç»“æŸäº†ã€‚å…¶ä¸­è¿˜æœ‰äº›ç»†èŠ‚çš„åœ°æ–¹ï¼Œæ¯”å¦‚åœ¨å°†è¯·æ±‚ä¸­çš„å‚æ•°å’Œæ–¹æ³•çš„å‚æ•°ç»‘å®šæ—¶ASMæ¡†æ¶çš„ä½¿ç”¨ï¼Œæ„Ÿå…´è¶£å¯ä»¥å»çœ‹çœ‹ã€‚ å…³äºè°ƒç”¨äº†refresh()æ–¹æ³•ï¼Œä¹å¤§ç»„ä»¶ä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–ã€‚ å‰é¢æˆ‘ä»¬çŸ¥é“çœ‹åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå¦‚æœè¿›è¡Œäº†refresh()ï¼Œä¸‹é¢çš„onRefresh()æ–¹æ³•å¥½åƒå°±ä¸èƒ½è°ƒç”¨äº†å•Šï¼Œé‚£ä¹å¤§ç»„ä»¶åˆ°åº•æ˜¯ä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–çš„å‘¢ï¼Ÿ è¿™å…¶å®ç”¨åˆ°äº†äº‹ä»¶ç›‘å¬å™¨ã€‚æˆ‘ä»¬éƒ½çŸ¥é“IoCå®¹å™¨çš„refresh()æ–¹æ³•ä¸­æœ‰äº‹ä»¶ä¼ æ’­å™¨çš„æ³¨å†Œï¼ˆinitApplicationEventMulticaster()æ–¹æ³•ï¼‰ã€äº‹ä»¶çš„å‘å¸ƒï¼ˆfinishRefresh()ï¼‰æ–¹æ³•ã€‚å…¶å®å°±æ˜¯åœ¨äº‹ä»¶å‘å¸ƒçš„æ—¶å€™ï¼Œè°ƒç”¨äº†SpringMVCä¹å¤§ç»„ä»¶çš„åˆå§‹åŒ–ã€‚æˆ‘ä»¬åç»­å†è®²ã€‚","link":"/2021/04/26/SpringMVC%E5%A4%A7%E8%87%B4%E8%BF%87%E7%A8%8B/"},{"title":"Springä¸­Beançš„ç”Ÿå‘½å‘¨æœŸ","text":"Beanæ˜¯ä»€ä¹ˆï¼Ÿæœ¬æ¥æ²¡æœ‰è¿™ä¸€èŠ‚çš„ï¼Œä½†æ˜¯å†™å®Œæºç ä¹‹åï¼Œåœ¨æƒ³æ˜¯å¦èƒ½å¤Ÿç±»æ¯”ä¸€ä¸‹åˆ«çš„æ›´å…·ä½“çš„ä¸œè¥¿ï¼Œç„¶åæƒ³ç€æƒ³ç€çªç„¶æƒ³åˆ°äº†ä¸ªBeanåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿå¥½åƒç”¨äº†è¿™ä¹ˆä¹…çš„Springï¼Œéƒ½è¿˜æ²¡æƒ³è¿‡è¿™ä¸ªé—®é¢˜ã€‚ç„¶åå°±å»çœ‹çœ‹å®˜ç½‘ã€ä¹¦ã€åšå®¢ç­‰ã€‚å°±æœ‰äº†è¿™ä¸€èŠ‚ã€‚ å®˜ç½‘çš„è§£é‡Šï¼š ã€ŠSpring5æ ¸å¿ƒåŸç†ä¸30ä¸ªç±»æ‰‹å†™å®æˆ˜ã€‹ä¸­çš„è§£é‡Š:Beanå¯¹äºSpringçš„æ„ä¹‰å°±åƒObjectå¯¹äºOOPçš„æ„ä¹‰ä¸€æ ·ã€‚Springåœ¨Javaç»„ä»¶åŒ–ï¼ˆJavaBeanã€EJBç­‰ï¼‰å¼€å‘ç†å¿µä¸‹å‡ºç°çš„ã€‚ ä¸ªäººç†è§£ï¼šBeanæ˜¯ä¸€ä¸ªç»„ä»¶ï¼ˆå¯¹è±¡ï¼‰ï¼Œç»„æˆäº†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œé€šè¿‡IoCå¯ä»¥å¯¹å…¶è¿›è¡Œç®¡ç†ã€‚å°±å¥½æ¯”å»åƒè‡ªåŠ©é¤é‡Œé¢çš„ä¸€é“é“èœã€‚ ç”Ÿå‘½å‘¨æœŸæºç ä¸­çš„æè¿°ï¼š å¤§è‡´è¿‡ç¨‹ï¼š æºç åˆ†æä¸Šå›¾ä¸­çš„æ ¸å¿ƒæ–¹æ³•å‡ ä¹éƒ½åœ¨doCreateBean()ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥è¿›å…¥åˆ°AbstractAutowireCapableBeanFactoryç±»ä¸­ã€‚ é¦–å…ˆï¼Œè¿›å…¥beanå®ä¾‹çš„åˆ›å»ºï¼ŒcreateBeanInstance()æ–¹æ³•ã€‚ æˆ‘ä»¬å¯ä»¥çœ‹è§ä¸Šå›¾ä¸­Beanå¯ä»¥é€šè¿‡instantiateUsingFactoryMethod()æ–¹æ³•åˆ›å»ºï¼Œä¹Ÿå¯ä»¥é€šè¿‡autowireConstructor()æ–¹æ³•åˆ›å»ºï¼Œä½†æ˜¯é»˜è®¤çš„æ˜¯ä½¿ç”¨instantiateBean()æ–¹æ³•åˆ›å»ºã€‚æˆ‘ä»¬ç‚¹è¿›å»çœ‹çœ‹ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™é‡Œé¢æœ‰JDKçš„å®‰å…¨APIä»¥åŠå¯¹è·å–åˆ°çš„beanå®ä¾‹å¯¹è±¡è¿›è¡Œå°è£…ï¼Œæœ€é‡è¦çš„æ˜¯getInstantiationStrategy().instantiate();è¿™ä¸ªæ–¹æ³•ã€‚æˆ‘ä»¬ç»§ç»­ç‚¹è¿›å»ã€‚ æ˜¯ä¸æ˜¯çœ‹è§äº†ä¸ªå¾ˆç†Ÿæ‚‰çš„æ–¹æ³•ï¼Ÿclazz.getDeclaredConstructor();è·å–æ„é€ æ–¹æ³•ã€‚æ˜¯ä¸æ˜¯æ¥ä¸‹æ¥å°±ä¼šæƒ³åˆ°äº†å¯¹åº”çš„newInstance()ï¼Ÿè¿™å…¶å®å°±æ˜¯åœ¨BeanUtils.instantiateClass(constructorToUse);è°ƒç”¨äº†ã€‚åˆ°æ­¤ï¼ŒBeançš„å®ä¾‹åŒ–å‡ºæ¥äº†ï¼Œåç»­å°±æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´çš„å¯¹Beanå®ä¾‹çš„å°è£…BeanWrapperäº†ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿›å…¥beanå®ä¾‹å¯¹è±¡çš„å±æ€§å¡«å……ï¼ˆpopulateBean()æ–¹æ³•ï¼‰ã€‚ é‡è¦çš„æ˜¯applyPropertyValues()è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬ç‚¹è¿›å»çœ‹çœ‹ã€‚ å…¶ä¸­æœ€é‡è¦çš„ä¸¤ä¸ªæ–¹æ³•æ˜¯ï¼šè§£æresolveValueIfNecessary()å’Œæ³¨å…¥setPropertyValues()æ–¹æ³•ã€‚ å¤§è‡´è¿‡ç¨‹æ˜¯ï¼š å±æ€§ç±»å‹ä¸éœ€è¦å¼ºåˆ¶è½¬æ¢æ—¶ï¼Œä¸éœ€è¦è§£æå±æ€§å€¼ï¼Œç›´æ¥è¿›è¡Œä¾èµ–æ³¨å…¥ å±æ€§å€¼ç±»å‹éœ€è¦è¿›è¡Œå¼ºåˆ¶è½¬æ¢æ—¶ï¼Œå¦‚å¯¹å…¶ä»–å¯¹è±¡çš„å¼•ç”¨ç­‰ï¼Œé¦–å…ˆéœ€è¦è§£æå±æ€§å€¼ï¼Œç„¶åå¯¹è§£æåçš„å±æ€§å€¼è¿›è¡Œä¾èµ–æ³¨å…¥ æˆ‘ä»¬è¿›å…¥resolveValueIfNecessary()æ–¹æ³•ï¼Œå¯ä»¥çœ‹è§è¿™é‡Œé¢æœ‰å¯¹ä¸åŒç±»å‹å±æ€§çš„è§£æï¼Œæ„Ÿå…´è¶£è‡ªå·±ç‚¹è¿›å»çœ‹çœ‹ã€‚ æˆ‘ä»¬è¿›å…¥setPropertyValues()è¿™ä¸ªæ–¹æ³•ï¼Œåˆ°AbstractPropertyAccessorè¿™ä¸ªç±»ä¸­ï¼Œæˆ‘ä»¬ä¼šå‘ç°å¾ˆå¤šsetPropertyValuesçš„é‡è½½æ–¹æ³•ã€‚ä½†æ˜¯éƒ½ä¼šèµ°åˆ°**setPropertyValue()**è¿™ä¸ªæ–¹æ³•ä¸­ã€‚ æˆ‘ä»¬ç»§ç»­è·Ÿè¿›ï¼Œè¿˜æ˜¯ä¼šå‘ç°æœ‰å¾ˆå¤šçš„setPropertyValue()æ–¹æ³•çš„é‡è½½ï¼Œæˆ‘é ï¼Œæ€ä¹ˆè¿™ä¹ˆå¤šï¼ä½†æœ€åè¿˜æ˜¯ä¼šå›åˆ°è¿™å‡ ä¸ªæ–¹æ³•ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å±æ€§çš„ä¾èµ–æ³¨å…¥ç»ˆäºè¦è¿›è¡Œäº†ã€‚æˆ‘ä»¬å¯ä»¥çœ‹è§ä¸»è¦æœ‰3ç±»ï¼Œå¯¹æ•°ç»„ç±»å‹ã€å¯¹Listç±»å‹å’Œå¯¹Mapç±»å‹çš„æ³¨å…¥ åˆ°æ­¤ï¼Œæˆ‘ä»¬çš„å±æ€§å¡«å……ç»ˆäºç»ˆäºç»ˆäºå®Œæˆäº†ï¼Œé‡è½½çš„æ–¹æ³•æ˜¯çœŸçš„å¤šï¼ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿›å…¥åˆå§‹åŒ–æ–¹æ³•ï¼ˆinitializeBean()ï¼‰ä¸­ã€‚ åœ¨è¿™ä¸ªé‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹è§ä¸Šé¢ç”»çš„æµç¨‹å›¾ä¸­çš„å¤§éƒ¨åˆ†æ–¹æ³•äº†ã€‚Awareæ¥å£ã€BeanPostProcesså’Œinit-method Awareæ¥å£ä¸Šé¢å·²ç»è´´å‡ºæ¥äº†ï¼Œå°±ä¸å±•ç¤ºäº†ã€‚ applyBeanPostProcessorsBeforeInitialization()æ–¹æ³• invokeInitMethods()æ–¹æ³• applyBeanPostProcessorsAfterInitialization()æ–¹æ³• ç»ˆäºè¦åˆ°é”€æ¯æ–¹æ³•äº†ï¼Œåœ¨refresh()ä¸­çš„destroyBeans()æ–¹æ³•ã€‚ æˆ‘ä»¬ç‚¹è¿›å»ï¼Œä¼šè°ƒç”¨å½“å‰BeanFactoryçš„destroySingletons()æ–¹æ³• è°ƒç”¨çˆ¶ç±»çš„destroySingletons()æ–¹æ³• åˆ°æ­¤ï¼Œæˆ‘ä»¬æ•´ä¸ªBeançš„ç”Ÿå‘½å‘¨æœŸå°±ç»“æŸäº†ã€‚","link":"/2021/04/24/Spring%E4%B8%ADBean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/"},{"title":"ã€æ¯”èµ›å¤ç›˜ã€‘äº‘ä¸Šå¼€å‘ï¼Œé«˜æ•ˆæ™ºèƒ½â€“é˜¿é‡Œäº‘ECS Cloudbuildå¼€å‘è€…å¤§èµ›æ€§èƒ½æŒ‘æˆ˜èµ›é“","text":"å‰è¨€å¿«æš‘å‡çš„æ—¶å€™ï¼Œåœ¨é˜¿é‡Œå¤©æ± ä¸Šé¢é—²é€›ã€‚è¯¶ï¼Œæ€§èƒ½ä¼˜åŒ–æŒ‘æˆ˜èµ›ï¼Ÿç‚¹è¿›å»çœ‹çœ‹ï¼Œåˆç•¥çš„è¯»äº†ä¸€ä¸‹èµ›é¢˜ï¼Œè¦å®ç°ä¸€ä¸ªèŠå¤©å®¤æœåŠ¡ï¼Œéƒ¨ç½²åœ¨ECSæœåŠ¡å™¨ä¸Šé¢ï¼Œç„¶åå¯¹å®ƒè¿›è¡Œä¸€ä¸‹æ‰‹æ®µçš„æ€§èƒ½ä¼˜åŒ–ï¼Œæ„Ÿè§‰è¿˜æŒºåˆé€‚çš„ï¼ˆps: å½“æ—¶å› ä¸ºå†™äº†ä¸€ä¸ªç§’æ€ç³»ç»Ÿå¹¶å‹æµ‹ä¼˜åŒ–è¿‡ã€ä¹Ÿçœ‹è¿‡ä¸€äº›æ€§èƒ½è°ƒä¼˜çš„ä¹¦ï¼Œæ„Ÿè§‰è‡ªå·±å¾ˆnbï¼Œåé¢æ‰çŸ¥é“è‡ªå·±è¿˜æ˜¯å¤ªå«©äº†ğŸ¤£ï¼‰ï¼Œé¡¿æ—¶å°±æŠ¥åäº†ã€‚ å› ä¸ºç¬¬ä¸€æ¬¡å‚åŠ è¿™ç§æ¯”èµ›ï¼Œæ‰€ä»¥ç»™è‡ªå·±å®šçš„æ˜¯å‰50å°±okäº†ã€‚ç„¶åä¸€ä¸ªæœˆçš„åˆèµ›ï¼Œå¿«ç»“æŸçš„é‚£ä¸€å‘¨æ’ååå¤šåï¼Œæ„Ÿè§‰è‡ªå·±è¿˜æ˜¯å¾ˆå‰å®³çš„ï¼Œä½†æ˜¯å°±ä¸€å‘¨çš„æ—¶é—´ï¼Œçœ‹ç€è‡ªå·±æ’åç›´æ¥è·Œå‡ºå‰ 20ï¼Œåˆ°äº† 23ã€‚æ‰æ„è¯†åˆ°è‡ªå·±é«˜å…´å¤ªæ—©äº†ã€‚ æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªæœˆçš„å¤èµ›æ—¶é—´ï¼Œè¿™å›æ˜¯è¦å®ç°ä¸€ä¸ªé›†ç¾¤äº†ã€‚ä¸­é€”é‡åˆ°äº†è€å¤šé—®é¢˜ï¼Œæ‰¾äº†å¥½å¤šå®˜ç½‘æ–‡æ¡£ï¼ˆVertxã€Hazelcastã€Igniteã€LevelDBï¼‰ï¼Œä¹Ÿå­¦åˆ°äº†ä¸å°‘ï¼Œä½†è¿˜æ˜¯æ„Ÿè§‰å·®ç‚¹ç«å€™ğŸ˜…ã€‚æ¯å¤©æ—©ä¸Šä¸ƒç‚¹å¤šèµ·åºŠä¸€ç›´è°ƒè¯•åˆ°æ™šä¸Šåç‚¹å·¦å³ï¼Œå®˜æ–¹äººå‘˜éƒ½è¢«çƒ¦çš„ä¸è¦ä¸è¦çš„äº†ğŸ˜‚ï¼ˆå¸Œæœ›ä¸è¦åŒçƒ¦ï¼‰ã€‚è¿˜æ˜¯å¤ªèœäº†å“ˆå“ˆå“ˆã€‚ ä¸å¤šè¯´äº†ï¼Œå…ˆä¸Šæ’åã€‚ èµ›é¢˜èƒŒæ™¯ï¼šåŸºäºå…¬å…±äº‘æ„å»ºäº§å“ã€ç³»ç»Ÿå’Œåº”ç”¨å·²ç»æ˜¯å½“å‰æœ€çƒ­é—¨çš„æŠ€æœ¯è¶‹åŠ¿äº†ã€‚èµ›é¢˜æ¢è®¨Web Serviceåœ¨äº‘ä¸Šéƒ¨ç½²çš„æ€§èƒ½ä¼˜åŒ–ï¼Œå¸Œæœ›å‚èµ›è€…é€šè¿‡ä»£ç æ’°å†™ã€æ“ä½œç³»ç»Ÿä¸æ•°æ®åº“é€‰å‹ã€å„ç§å‚æ•°è°ƒä¼˜ç­‰æ‰‹æ®µï¼Œä¼˜åŒ–äº‘ç«¯WebæœåŠ¡çš„æ€§èƒ½å’Œä¿éšœæœåŠ¡çš„é«˜å¯ç”¨ã€‚ æè¿°ï¼šæ ¹æ®ç»™å®šçš„APIå®Œæˆï¼šç”¨æˆ·æ³¨å†Œã€ç”¨æˆ·ç™»å½•ã€åˆ›å»ºæˆ¿é—´ã€æŸ¥çœ‹æˆ¿é—´ã€ç”¨æˆ·è¿›å…¥ã€é€€å‡ºå®æ—¶èŠå¤©æˆ¿é—´ã€ç”¨æˆ·å‘è¨€å’Œå®æ—¶æ”¶å–å…¶ä»–äººçš„æ¶ˆæ¯ã€‚æ³¨ï¼šèŠå¤©å®¤ã€æ¶ˆæ¯å’Œç”¨æˆ·ï¼Œä¸‰ä¸ªæ•°æ®å¿…é¡»æŒä¹…åŒ–ï¼›åœ¨çº¿äººæ•°æ— é¡»æŒä¹…åŒ–ã€‚éœ€è¦ä¿è¯ç¨‹åºè¿”å›æ—¶å®•æœºï¼Œæ•°æ®è¿˜å­˜åœ¨ï¼Œå…è®¸å¾ˆå°‘çš„ä¸¢å¤±ã€‚ä¸‰å°æœåŠ¡å™¨ã€‚ æœºå™¨è§„æ ¼ï¼š4 æ ¸ 8 G è¯„åˆ†ï¼šèƒ½æµ‹è¯•çš„ç»¼åˆå¾—åˆ†= n âˆ— 10 + 50 âˆ— (qps / 10000) âˆ— k + 50 âˆ— (1 / time_deplay) âˆ— mã€‚ ä¼˜åŒ–ç‚¹çº¿ç¨‹æ¨¡å‹ä¸€å¼€å§‹ç³»ç»Ÿçš„æ¶æ„é‡‡ç”¨çš„æ˜¯Springboot + redisï¼ˆç”¨äº†MySQLï¼Œç›´æ¥æ²¡å‡ºåˆ†ğŸ˜…ï¼‰ã€‚å†™å®Œç¨‹åºåæäº¤ï¼Œçº³å°¼ï¼Ÿå±…ç„¶æ‰æ‹¿åˆ°äº†ç®€å•çš„APIæ­£å¸¸åˆ†ï¼ˆ190ï¼‰ï¼Ÿç«‹é©¬æ‰“å¼€Jprofilerå¼€å§‹ç›‘æ§ï¼Œå‘ç°å‹æµ‹çš„æ—¶å€™çº¿ç¨‹æ•°åªæœ‰å‡ åä¸ªå¹¶ä¸”çº¿ç¨‹å¤§å¤šéƒ½å¤„äºç­‰å¾…çŠ¶æ€ï¼Œè€Œä¸”CPUåˆ©ç”¨ç‡å¾ˆä½ã€‚okï¼Œæé«˜tomcatçš„çº¿ç¨‹æ•°ï¼ˆå› ä¸ºSpringbootæ˜¯å†…åµŒtomcatçš„ï¼Œè€Œä¸”ä¸€ä¸ªè¯·æ±‚ä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†ï¼‰ï¼Œä¸æ–­çš„è°ƒæ•´ï¼Œæœ€åæ‰¾åˆ°æœ€ä¼˜çš„çº¿ç¨‹æ•°ã€‚é¸¡å†»ï¼ç«‹é©¬æ‰“å¼€æäº¤ç•Œé¢å¼€å§‹æäº¤ï¼Œè¿‡äº†å‡ åˆ†é’Ÿï¼ŒQPSå¾—åˆ†æé«˜ 5 åˆ†ï¼Ÿï¼Ÿï¼Ÿæ€ä¹ˆæ‰ 5 åˆ†ï¼Ÿæˆ‘æµ‹äº†è¿™ä¹ˆä¹…ï¼ç®—äº†ç®—äº†ï¼Œæé«˜äº†å°±å¥½ã€‚ ä½†æ˜¯æ¥ä¸‹æ¥ä¸€æ®µæ—¶é—´ï¼Œé™·å…¥è‰°éš¾çš„æ—¶åˆ»äº†ï¼Œä¸æ–­çš„ä¿®æ”¹ã€æäº¤ï¼Œä½†æ˜¯åˆ†æ•°è€æ˜¯ä¸Šä¸å»ã€‚ä¸è¡Œä¸è¡Œï¼Œä¸èƒ½å°±è¿™æ ·ä¸‹å»ï¼Œå¤§æ¦‚åœ¨ç½‘ä¸Šæ‰¾äº†å¥½å‡ å¤©ï¼ŒæœŸé—´éƒ½å·®ç‚¹æƒ³å»å­¦C++çš„seastarï¼Œåé¢åœ¨techempowerç½‘ç«™ä¸Šæ‰¾åˆ°äº†æ€§èƒ½è¾ƒé«˜çš„webå®¹å™¨Vertxï¼Œç»ˆäºçœ‹è§äº†æ›™å…‰ã€‚èŠ±äº† 3 ~ 5 å¤©å»ç†Ÿæ‚‰Vertxä¸€ä¸ªä¸ªçš„demoï¼Œåé¢æ ¹æ®éœ€è¦ç„¶åä¸æ–­çš„æ‰¾æ–‡æ¡£ã€åŠ åŠŸèƒ½ï¼Œä¸€ä¸ªwebserverå¼„å¥½äº†ï¼ï¼ˆä¸å¾—ä¸è¯´ï¼ŒVertxçš„æ–‡æ¡£æ˜¯æˆ‘è§è¿‡æœ€å®¹æ˜“æ‡‚çš„ï¼Œå­¦çš„æœ€å¿«çš„ï¼‰å…ˆç‚¹ä¸ªæäº¤çœ‹çœ‹ï¼Œ300+ï¼èŠœæ¹–ã€‚ åŒæ­¥æ¨¡å‹åƒä¼ ç»Ÿçš„Springbootå°±æ˜¯åŒæ­¥æ¨¡å‹ï¼ˆå…¶å®æ˜¯tomcatï¼‰ï¼Œæ”¶åˆ°ä¸€ä¸ªè¯·æ±‚åï¼Œå°±ç”¨ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†ï¼Œåªèƒ½å¤„ç†ä¸€ä¸ªï¼Œå…¶ä»–çº¿ç¨‹å°±å¯èƒ½ä¼šè¢«é˜»å¡ï¼Œè¿™æ ·å°±ä¼šå¤§å¤§çš„é™ä½ç³»ç»Ÿçš„ååé‡ã€‚è™½ç„¶tomcatåé¢ä¹Ÿæ”¯æŒNIOä»¥åŠAIOï¼Œä½†æ˜¯åœ¨æ¯”èµ›åˆæœŸçš„æ—¶å€™ä½¿ç”¨äº†ä½†æ˜¯æ•ˆæœä¸å¤ªæ˜æ˜¾ï¼Œå°±èˆå¼ƒäº†ã€‚ å¤šè·¯å¤ç”¨æ¨¡å‹åƒæˆ‘ä»¬çŸ¥é“çš„Linuxä¸­çš„selectã€pollå’Œepollï¼Œåˆæˆ–è€…æ˜¯Redisä¸­çš„ï¼Œéƒ½æ˜¯ä½¿ç”¨çš„IOå¤šè·¯å¤ç”¨ã€‚Vertxæ­£æ˜¯ä½¿ç”¨äº†è¿™ç§æ¨¡å‹ï¼Œå®ƒé€šè¿‡ä¸€ä¸ªEvent Loopç»„ä¸æ–­çš„å¾ªç¯ï¼Œå½“æœ‰Eventåˆ°è¾¾æ—¶ï¼Œå®ƒä¼šè°ƒç”¨ç›¸åº”çš„handleå»å¤„ç†ã€‚è¿™å°±ä½¿å¾—å®ƒç›¸æ¯”äºåŒæ­¥æ¨¡å‹æœ‰ç€å¤©ç„¶çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œèƒ½å¤Ÿå¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚æ³¨æ„ï¼šä¸è¦åœ¨Event Loopè¿è¡Œæ—¶é—´è¾ƒé•¿çš„ä»£ç ï¼ŒVertxæœ‰ä¸“é—¨ç”¨äºå¤„ç†è€—æ—¶é•¿çš„ä»£ç çº¿ç¨‹ï¼ˆWorker Verticleï¼‰ã€‚ çº¿ç¨‹æ•°æˆ‘ä»¬å‰é¢è¯´åˆ°Vertxæ˜¯é€šè¿‡ä¸€ä¸ªEvent Loopç»„æ¥ä¸æ–­çš„å¾ªç¯ä»¥åŠWorker Verticleæ¥å¤„ç†é˜»å¡ä»£ç ï¼Œä½†æ˜¯å®ƒä»¬çš„çº¿ç¨‹æ•°é‡åº”è¯¥å¦‚ä½•å»è®¾ç½®å‘¢ï¼Ÿæˆ‘çš„æ€è·¯ï¼šEvent Loopå› ä¸ºæ˜¯ä¸æ–­å¾ªç¯çš„ï¼Œçº¿ç¨‹æ•°åº”å’ŒCPUæ ¸æ•°å·®ä¸å¤šã€‚è€ŒWorker Verticleå¤„ç†é˜»å¡ä»£ç ï¼Œå¯ä»¥å°½å¯èƒ½çš„å¤šã€‚æœ€ç»ˆç»è¿‡ä¸æ–­çš„benchmarkï¼Œè°ƒæ•´çº¿ç¨‹æ•°ï¼Œæœ€ç»ˆæé«˜çš„å¤§æ¦‚ 50 å¤šåˆ†ã€‚ 12345678910111213// file: io.vertx.core.Launcher@Overridepublic void beforeStartingVertx(VertxOptions options) { // è®¾ç½®EventLoopçº¿ç¨‹æ± å¤§å° options.setEventLoopPoolSize(8);}@Overridepublic void beforeDeployingVerticle(DeploymentOptions deploymentOptions) { // è®¾ç½®éƒ¨ç½²å¤šå°‘ä¸ªVerticleå®ä¾‹ deploymentOptions.setInstances(100);} æ•°æ®å†™å…¥è¿™æ˜¯å¦å¤–ä¸€ä¸ªå¤§å¤´ã€‚å› ä¸ºä»¥å‰æ¥è§¦å­˜å‚¨è¿™æ–¹é¢æ¯”è¾ƒå°‘ï¼Œå½“æ—¶è®¤çŸ¥é‡Œé¢Redisæœ€å¿«ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ä¸€ç›´å¼€å¯aofçš„AOF_FSYNC_ALWAYSï¼Œå› ä¸ºèµ›é¢˜è¦æ±‚ç³»ç»Ÿè¿”å›å°±æ„å‘³ç€æ•°æ®ç½—ç›˜ã€‚åé¢å…¬å¸ƒå¯ä»¥å…è®¸å°‘é‡çš„æ•°æ®ä¸¢å¤±åï¼Œå¼€å¯äº†AOF_FSYNC_EVERYSECï¼Œåˆ†æ•°æé«˜äº† 100 åˆ†å·¦å³ã€‚ç„¶ååœ¨ç½‘ä¸Šå‚è€ƒä¸€äº›å†™æ€§èƒ½å¿«çš„ä¸­é—´ä»¶ï¼ˆå¯èƒ½æ˜¯æˆ‘æ²¡æœå¼•æ“ä¹‹ç±»çš„ï¼Œå±…ç„¶æ²¡çœ‹è§LevelDBï¼‰ï¼Œåé¢ä¸çŸ¥é“æ˜¯å“ªä¸ªåšå®¢ä¸Šé¢ç»™çš„æµ‹è¯•æŠ¥å‘Šï¼Œè¯´MongoDBçš„å†™æ€§èƒ½ä¼˜äºRedisï¼Œç„¶åèŠ±äº†å¥½å‡ å¤©çš„æ—¶é—´å»å¼„MongoDBå’Œæµ‹è¯•ï¼Œä½†æ˜¯åœ¨ 4 æ ¸ 8 Gçš„æƒ…å†µä¸‹ï¼Œå†…å­˜å ç”¨å¤ªå¤šï¼Œå¹¶ä¸”æ€§èƒ½ä¹Ÿæ²¡Rediså¥½ã€‚ç„¶åå‚è€ƒäº†MongoDBçš„å®ç°ï¼Œå¼‚æ­¥å®šæ—¶åˆ·ç›˜ã€‚åé¢å°±åœ¨æƒ³è‡ªå·±å¼„ä¸ªå­˜å‚¨çš„ï¼Œç›´æ¥å†™ï¼Œä¸è°ƒä¸­é—´ä»¶äº†ï¼Œæ•´ä¸ªæ–¹æ¡ˆæ˜¯å†™åœ¨å†…å­˜ä¸­ç„¶ååˆ°è¾¾æŸä¸€é˜ˆå€¼ / æ—¶é™åå¼‚æ­¥åˆ·ç›˜ï¼Œä½†æ˜¯æµ‹è¯•å‡ºæ¥æ•ˆæœéƒ½ä¸ç†æƒ³ï¼Œå°±ç»™æ”¾å¼ƒäº†ã€‚åé¢å°±æ˜¯ä¹±æ‰¾äº†ï¼ŒåƒCassandraã€ScyllaDBè¿™äº›ï¼ˆå½“æ—¶å±…ç„¶æ²¡æƒ³åˆ°çœ‹åº•å±‚æ˜¯å¦‚ä½•å®ç°çš„äº†ï¼‰ã€‚ åé¢åˆèµ›å®Œæ‰äº†è§£åˆ°LevelDBä»¥åŠLSMæ ‘ã€‚è¯¦æƒ…è§ï¼šLSMè®ºæ–‡ é›†ç¾¤ï¼ˆé€šä¿¡ / æ•°æ®ä¼ è¾“ï¼‰è¿™å…¶å®éƒ½è¿˜æŒºå¥½å¼„çš„ï¼Œä¸»è¦æ˜¯ä¸€èˆ¬ä»¥ä¸Šçš„èŠ‚ç‚¹ ack true å responseã€‚å½“æ—¶è€ƒè™‘çš„æ–¹æ¡ˆæœ‰ é€šè¿‡åˆ†å¸ƒå¼ç¼“å­˜å®ç°ã€‚åƒRedisé›†ç¾¤ï¼Œåˆæˆ–è€…åµŒå…¥åœ¨ç¨‹åºé‡Œé¢çš„Hazelcastã€Igniteã€‚ è‡ªå·±å®ç° ä½†æ˜¯å½“æ—¶å› ä¸ºåœ¨å…¶ä»–æ–¹æ¡ˆä¸Šé¢æµªè´¹äº†å¾ˆå¤šæ—¶é—´ï¼Œæ‰€ä»¥å°±é€‰æ‹©äº†æˆç†Ÿçš„å®ç°è¾ƒå¿«çš„æ–¹æ¡ˆï¼šIgniteã€‚å…¶ä»–æ–¹é¢çš„åŸå› å°±æ˜¯å½“æ—¶æƒ³ç€åµŒå…¥åœ¨åº”ç”¨ç¨‹åºé‡Œé¢æ¯”åƒRedisé¢å¤–å¼€ä¸€ä¸ªè¿›ç¨‹èµ„æºæ¶ˆè€—ä½ä»¥åŠç½‘ç»œIOå°‘ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆä¸é€‰æ‹©Hazelcastå‘¢ï¼Ÿå› ä¸ºè¿™ä¸ªä¸œè¥¿æŒä¹…åŒ–ç¼“å­˜çš„è¯éœ€è¦ money ï¼ï¼ï¼ åƒè¿™ç§ç®€å•ã€éœ€æ±‚ä¸å¤šã€è¿½æ±‚æ€§èƒ½çš„åœºæ™¯æ„Ÿè§‰è¿˜æ˜¯è‡ªå·±å®ç°å¹¶ä¸”åœ¨ä¸€ä¸ªç¨‹åºé‡Œé¢å¥½ç‚¹ã€‚ è‡³äºæ•°æ®ä¼ è¾“çš„æ ¼å¼ï¼Œprotobufå°±æŒºä¸é”™çš„ï¼Œå…¼å®¹æ€§å’Œæ€§èƒ½éƒ½æŒºå¥½ã€‚å…¶ä»–çš„åƒJsonã€Xmlç”¨çš„æ¯”è¾ƒå¤šã€‚ æ¯”èµ›å®Œåå®ç°äº†ä¸€ä¸ªé€šè¿‡Javaå®ç°Raftç®—æ³•ï¼Œå…·ä½“è¯¦æƒ…ç§»æ­¥åˆ°è¯¥æ–‡ç« ã€‚ æ•°æ®åˆ†åŒºåˆšæ‹¿åˆ°å¤èµ›èµ›é¢˜çš„æ—¶å€™ï¼Œä¸€å¼€å§‹è€ƒè™‘çš„æ˜¯é›†ç¾¤æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¿å­˜ä¸€ä»½å®Œæ•´çš„æ•°æ®ï¼ˆps: å½“æ—¶æƒ³ç€å¿«é€Ÿå“åº”ï¼Œå½“æœ¬åœ°å†…å­˜ä¸­å­˜æœ‰æ•°æ®æ—¶ï¼Œè¿™æ ·æœ€å¿«ï¼‰ï¼Œåé¢æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°æŸ¥è¯¢çš„æ•ˆç‡æ˜¯æŒºå¿«çš„äº†ï¼Œä½†æ˜¯å½“é›†ç¾¤é¢ä¸´å†™å¤šçš„åœºæ™¯ä¸‹ï¼Œå°±å‡ºç°äº†å¾ˆå¤šé—®é¢˜ã€‚æ¯”å¦‚è¯´æ¶ˆæ¯é¡ºåºä¹±ï¼ˆè€ƒè™‘çš„æ˜¯æ—¶é—´æˆ³æ¥è§£å†³ï¼‰ã€é›†ç¾¤ä¹‹é—´æ•°æ®åŒæ­¥å¤ªæ…¢ï¼ˆä¸»è¦åŸå› ï¼‰ã€‚åé¢è¿˜æ˜¯å°†æ•°æ®è¿›è¡Œäº†åˆ†åŒºå­˜æ”¾ï¼Œé›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå­˜å‚¨ä¸€å—åŒºåŸŸçš„æ•°æ®ï¼Œå½“æœ¬åœ°åˆ†åŒºæ²¡æœ‰è¯¥æ•°æ®æ—¶ï¼Œå°±ä¼šå»å…¶ä»–åˆ†åŒºæŸ¥è¯¢ï¼Œå¹¶å¯ä»¥æŒ‰éœ€è¦å°†æŸ¥è¯¢åˆ°çš„æ•°æ®ç¼“å­˜åˆ°æœ¬åœ°ï¼Œè¿™æ ·åšåæ€§èƒ½æé«˜äº†ä¸å°‘ã€‚ ä½†æ˜¯éšä¹‹è€Œæ¥çš„é—®é¢˜å°±æ˜¯å½“å­˜å‚¨æŸä¸€åˆ†åŒºçš„èŠ‚ç‚¹å®•æœºä¹‹åï¼Œå…¶ä»–èŠ‚ç‚¹å¦‚ä½•è®¿é—®è¯¥åˆ†åŒºçš„æ•°æ®ï¼Ÿ åé¢åœ¨Igniteå®˜ç½‘æŸ¥çœ‹åˆ°äº†æ•°æ®å†å¹³è¡¡æœºåˆ¶ã€‚å°±æ˜¯ä¼šæœ‰ä¸ªä¸­å¿ƒçš„èŠ‚ç‚¹ä¼šç®¡ç†åˆ†åŒºï¼Œå¹¶å°†åˆ†åŒºåˆ†é…ç»™é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ï¼Œå½“æŸä¸€èŠ‚ç‚¹å®•æœºåï¼Œä¸­å¿ƒèŠ‚ç‚¹å°±ä¼šå°†å®•æœºåçš„åˆ†åŒºæ•°æ®æµè½¬åˆ°å…¶ä»–ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šé¢ï¼Œè¿™æ ·å°±è§£å†³çš„æ•°æ®ä¸¢å¤±é—®é¢˜ã€‚ï¼ˆå› ä¸ºè¯„æµ‹ç¯å¢ƒä¸ä¼šå‡ºç°ä¸‰å°æœåŠ¡å™¨éƒ½å®•æœºçš„åœºæ™¯ï¼Œæ‰€ä»¥ä¸ç®¡å¦‚ä½•å®•æœºæ•°æ®éƒ½ä¸ä¼šä¸¢å¤±ï¼Œå‰ææ˜¯å®•æœºåçš„èŠ‚ç‚¹é‡å¯ä¼šå…ˆè¿›è¡Œæ•°æ®åŒæ­¥ï¼‰ Linuxå¯æ‰“å¼€çš„æ–‡ä»¶æ•°è¿™ä¸œè¥¿æ„Ÿè§‰è¿˜æŒºå¸¸ç”¨çš„å“ˆï¼Œå…·ä½“æ¥è¯´å°±æ˜¯è¿æ¥æ•°çš„å¤§å°ï¼Œå› ä¸ºLinuxéƒ½æ˜¯ä»¥fdæ–‡ä»¶æè¿°ç¬¦æ¥å¼„çš„å˜›ï¼Œæ‰€ä»¥è®¾ç½®Linuxä¸­å¯ä»¥æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æ•°å¯ä»¥åº”å¯¹ä¸€äº›connection refuseçš„åœºæ™¯ã€‚å…·ä½“é…ç½®ï¼š 12345678# vi /etc/sysctl.conf# è®¾ç½®ç³»ç»Ÿçº§åˆ«çš„fs.file-max=1100000fs.nr_open=1100000# sysctl -p è®¾ç½®ç”Ÿæ•ˆ# vi /etc/security/limits.confsoft nofile 1010000hard nofile 1010000 æ³¨æ„ï¼šhard nofile ä¸€å®šè¦æ¯” fs.nr_open è¦å°ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´ç”¨æˆ·æ— æ³•ç™»å½• æ€»ç»“ ä¸€ä¸ªå¥½çš„æ¶æ„ / è®¾è®¡ï¼ˆè¿™ä¼šå¸®ä½ çœä¸‹å¾ˆå¤šæ—¶é—´ï¼‰ æŠ€æœ¯çš„å¹¿åº¦ä¸æ·±åº¦ï¼ˆä½ å¯ä»¥å¿«é€Ÿçš„æ‰¾åˆ°ä½ æ‰€éœ€è¦çš„æŠ€æœ¯ï¼‰ å­¦ä¹ èƒ½åŠ›ï¼ˆèƒ½å¤Ÿå¿«é€Ÿç†Ÿç»ƒçš„ä¸Šæ‰‹æŸä¸ªæ–°çš„æŠ€æœ¯ï¼‰ å¿ƒæ€ï¼ˆæ”¾è½»æ¾ï¼‰ åŠ æ²¹ï¼ï¼ï¼ æœ€åå¤èµ›ç¬¬äºŒæŠ€æœ¯åˆ†äº«","link":"/2021/11/07/%E3%80%90%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%9B%98%E3%80%91%E4%BA%91%E4%B8%8A%E5%BC%80%E5%8F%91%EF%BC%8C%E9%AB%98%E6%95%88%E6%99%BA%E8%83%BD%E2%80%93%E9%98%BF%E9%87%8C%E4%BA%91ECS%20Cloudbuild%E5%BC%80%E5%8F%91%E8%80%85%E5%A4%A7%E8%B5%9B%E6%80%A7%E8%83%BD%E6%8C%91%E6%88%98%E8%B5%9B%E9%81%93/"},{"title":"åŠ¨æ€è§„åˆ’","text":"å‰è¨€â€‹ å‰ä¸€ä¸ªæœˆå¼€å§‹åˆ·é¢˜ï¼Œé‚£ä¼šå„¿åœ¨åŠ›æ‰£ä¸Šé¢ï¼Œè§ä¸€ä¸ªDPé¢˜ä¸€ä¸ªä¸ä¼šçš„ã€‚çªç„¶è§‰å¾—è‡ªå·±å¥½åƒåœ¾å“ˆå“ˆå“ˆã€‚ä¸ºä»€ä¹ˆç°åœ¨å†™è¿™ä¸ªå‘¢ï¼Œå°±åˆšåˆšåˆ·ç€åˆ·ç€é¢˜ï¼Œçªå‘å¥‡æƒ³äº†ï¼Œè§‰å¾—å¥½åƒæ‰¾åˆ°äº†å“ªä¸ªæ„Ÿè§‰ï¼Ÿå¼€å§‹åˆ·DPè¿‡ç˜¾äº†å“ˆå“ˆå“ˆã€‚ä½†æ˜¯æˆ‘åˆä¸å¤ªä¼šè®²ï¼Œç›´æ¥æ¥åˆ†äº«æˆ‘å¯¹ä¸€äº›DPæ¡ˆä¾‹é¢˜çš„è§£é¢˜æ€è·¯ã€‚ä¸å¤šè¯´ï¼Œè¿›å…¥æ­£é¢˜ã€‚ æ¡ˆä¾‹(å…¶ä»–å‡ ä¸ªæ¡ˆä¾‹æ•´ç†å‡ºæ¥åè¡¥ä¸Š)é’è›™è·³çº§é—®é¢˜ ä¸€ä¸ªé’è›™ä¸€æ¬¡å¯ä»¥è·³ä¸Š1çº§å°é˜¶ï¼Œä¹Ÿå¯ä»¥è·³ä¸Š2çº§å°é˜¶ã€‚æ±‚è¯¥é’è›™è·³ä¸Šä¸€ä¸ªnçº§å°é˜¶æ€»å…±æœ‰å¤šå°‘ç§è·³æ³•ã€‚ æ€è€ƒ é’è›™è·³çº§çš„æ–¹å¼æœ‰2ç§ï¼š è·³1ä¸ªå°é˜¶ è·³2ä¸ªå°é˜¶ å°†é—®é¢˜è½¬å˜ä¸ºæ•°å­¦å‡½æ•°ï¼š è§£é¢˜ 123456789101112131415class Solution { public int climbStairs(int n) { int[] res = new int[n+1]; if(n &lt;= 0) return 0; if(n == 1) return 1; if(n == 2) return 2; res[0] = 0; res[1] = 1; res[2] = 2; for(int i = 3; i &lt;= n; i++){ res[i] = res[i-1] + res[i-2]; } return res[n]; }} æ‹“å±• å¦‚æœå°é’è›™æœ‰ä¸‰ç§è·³æ³•å‘¢ï¼Ÿè·³ä¸€ä¸ªå°é˜¶ã€è·³ä¸¤ä¸ªå°é˜¶ã€è·³ä¸‰ä¸ªå°é˜¶å‘¢ï¼Ÿ æ–æ³¢é‚£å¥‘æ•°åˆ— åŠ›æ‰£72é¢˜ èƒŒåŒ…é—®é¢˜ å‡å¦‚ä½ æœ‰ä¸€ä¸ªå¯ä»¥è£…5kgçš„èƒŒåŒ…ï¼Œä½ å»å•†åŸé‡Œé¢å¾—å°†æœ€æœ‰ä»·å€¼çš„ç‰©å“è£…è¿›èƒŒåŒ…ï¼Œä½†æ˜¯ä¸èƒ½è¶…è¿‡èƒŒåŒ…å®¹é‡ã€‚æ±‚ä½ èƒ½å¸¦èµ°çš„æœ€å¤§ä»·å€¼çš„æ€»å’Œ å•†åœºä¸­çš„ç‰©å“æœ‰ï¼š ç‰©å“ é‡é‡ ä»·å€¼ é“…ç¬” 0.5kg 1 é¢åŒ… 1kg 3 æ‰‹ç”µç­’ 3kg 10 æ°´ 2kg 7 æ€è€ƒ å¹³å¸¸æˆ‘ä»¬é‡åˆ°è¿™ç§é—®é¢˜ï¼Œéƒ½æ˜¯æƒ³ç€å…ˆæŠŠæ€§ä»·æ¯”æœ€é«˜çš„æ‹¿äº†ï¼Œç„¶åæ‹¿ç¬¬äºŒçš„ï¼Œä½†æ˜¯åœ¨æŸäº›åœºæ™¯ä¸‹å°±ä¸å¤ªé€‚åˆäº†ã€‚è¿™é‡Œå°±ä¸å¤ªè¿‡å¤šè®²è§£ï¼Œä¸»è¦ä½¿ç”¨åŠ¨æ€è§„åˆ’æ¥è§£è¿™é“é¢˜ç›®ã€‚ ç‰©å“ 0.5kg 1kg 2kg 3kg 4kg 5kg é“…ç¬” 1 2 4 6 8 10 é¢åŒ… 1 3 6 9 12 15 æ‰‹ç”µç­’ 1 3 6 10 13 16 æ°´ 1 3 7 10 14 17 ä¸»è¦æ€è·¯ï¼šå°†æ¯ä¸€é˜¶æ®µé‡é‡çš„æœ€ä¼˜è§£ä¿å­˜ ä¾‹å¦‚ï¼š å½“åªæœ‰é“…ç¬”çš„æ—¶å€™ï¼š 0.5kgçš„æœ€ä¼˜è§£æ˜¯1ã€1kgçš„æœ€ä¼˜è§£æ˜¯2â€¦â€¦5kgçš„æœ€ä¼˜è§£æ˜¯10 å½“æœ‰é“…ç¬”å’Œé¢åŒ…çš„æ—¶å€™ï¼š0.5kgçš„æœ€ä¼˜è§£æ˜¯1ã€1kgçš„æœ€ä¼˜è§£æ˜¯3â€¦â€¦5kgçš„æœ€ä¼˜è§£æ˜¯15 â€¦â€¦ å½“å…¨éƒ¨ç‰©å“éƒ½åœ¨æ—¶ï¼š0.5kgçš„æœ€ä¼˜è§£æ˜¯1ã€1kgçš„æœ€ä¼˜è§£æ˜¯3â€¦â€¦5kgçš„æœ€ä¼˜è§£æ˜¯17 æˆ‘ä»¬è¿™æ—¶å°±èƒ½å¾—åˆ°æœ€ç»ˆç­”æ¡ˆä¸º17","link":"/2021/04/04/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/"},{"title":"å¾ªç¯ä¾èµ–","text":"æ˜¯ä»€ä¹ˆï¼Ÿç®€å•çš„æ¥è¯´å°±æ˜¯å¯¹è±¡açš„å±æ€§ä¸­å¼•ç”¨äº†å¯¹è±¡bï¼Œå¯¹è±¡bçš„å±æ€§ä¸­å¼•ç”¨äº†å¯¹è±¡câ€¦â€¦æœ€åå¼•ç”¨åˆ°aã€‚ 1234567891011&lt;bean id=&quot;a&quot; class=&quot;com.zmm.test.A&quot; lazy-init=&quot;false&quot;&gt; &lt;property name=&quot;b&quot; ref=&quot;b&quot;/&gt;&lt;/bean&gt;&lt;bean id=&quot;b&quot; class=&quot;com.zmm.test.B&quot; lazy-init=&quot;false&quot;&gt; &lt;property name=&quot;c&quot; ref=&quot;c&quot;/&gt;&lt;/bean&gt;&lt;bean id=&quot;c&quot; class=&quot;com.zmm.test.C&quot; lazy-init=&quot;false&quot;&gt; &lt;property name=&quot;a&quot; ref=&quot;a&quot;/&gt;&lt;/bean&gt; Springæ˜¯å¦‚ä½•è§£å†³çš„ï¼Ÿ1. ä¸‰çº§ç¼“å­˜ï¼ˆå…¶å®äºŒçº§ç¼“å­˜ä¹Ÿèƒ½è§£å†³ï¼Œåªæ˜¯çœ‹æ˜¯å¦ä½¿ç”¨AOPï¼‰1234567891011121314151617181920212223242526// DefaultSingletonBeanRegistryç±»ä¸‹çš„/** * ä¸€çº§ç¼“å­˜ * ç”¨æ¥å­˜æ”¾æˆå“beanå¯¹è±¡ï¼ˆå·²ç»æˆåŠŸå®ä¾‹åŒ–ä¸åˆå§‹åŒ–äº†çš„ï¼‰ * * Cache of singleton objects: bean name to bean instance. */private final Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;(256);/** * ä¸‰çº§ç¼“å­˜ ï¼ˆAOPçš„å…³é”®ï¼Œå¦‚æœä¸ç”¨AOPï¼ŒäºŒçº§ç¼“å­˜ä¹Ÿèƒ½è§£å†³å¾ªç¯ä¾èµ–ï¼‰ * ç”¨æ¥å­˜æ”¾æ—©æœŸçš„beanå®ä¾‹(lambdaè¡¨è¾¾å¼ï¼Œä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»çš„å½¢å¼)ï¼Œçœ‹beanå¯¹è±¡æ˜¯å¦éœ€è¦è¢«ä»£ç†ã€‚ * ObjectFactory&lt;?&gt;æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œ * * Cache of singleton factories: bean name to ObjectFactory. */private final Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;&gt;(16);/** * äºŒçº§ç¼“å­˜ * ç”¨æ¥å­˜æ”¾åŠæˆå“beanå¯¹è±¡ï¼Œå·²ç»å®ä¾‹åŒ–äº†çš„ä½†æ˜¯æœªåˆå§‹åŒ–çš„beanå¯¹è±¡ * * Cache of early singleton objects: bean name to bean instance. */private final Map&lt;String, Object&gt; earlySingletonObjects = new ConcurrentHashMap&lt;&gt;(16); 2.æå‰æš´éœ²AbstractAutowireCapableBeanFactoryç±»çš„doCreateBean()æ–¹æ³• 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253protected Object doCreateBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) throws BeanCreationException { // ....... // Eagerly cache singletons to be able to resolve circular references // even when triggered by lifecycle interfaces like BeanFactoryAware. // æ€¥äºç¼“å­˜å•ä¾‹ï¼Œä»¥ä¾¿å³ä½¿åœ¨è¯¸å¦‚BeanFactoryAwareä¹‹ç±»çš„ç”Ÿå‘½å‘¨æœŸæ¥å£è§¦å‘æ—¶ä¹Ÿèƒ½å¤Ÿè§£æå¾ªç¯å¼•ç”¨ã€‚ // æ˜¯å¦æ˜¯å•ä¾‹çš„ &amp;&amp; å…è®¸å¾ªç¯å¼•ç”¨ &amp;&amp; æ˜¯Singletonå½“å‰beanæ­£åœ¨åˆ›ä½œä¸­ boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp; isSingletonCurrentlyInCreation(beanName)); if (earlySingletonExposure) { if (logger.isTraceEnabled()) { logger.trace(&quot;Eagerly caching bean '&quot; + beanName + &quot;' to allow for resolving potential circular references&quot;); } // ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»ï¼Œæå‰æš´éœ²åˆ›å»ºçš„å®ä¾‹beanã€‚å¯ä»¥é˜²æ­¢å¾ªç¯å¼•ç”¨ï¼Œå°½æ—©çš„æŒæœ‰å¯¹è±¡çš„å¼•ç”¨ // å¦‚æœä¸€çº§ç¼“å­˜ä¸­ä¸å­˜åœ¨æŒ‡å®šçš„beanï¼Œå°±æ·»åŠ åˆ°ä¸‰çº§ç¼“å­˜ä¸­å»ï¼Œå°†äºŒçº§ç¼“å­˜ä¸­çš„ç§»é™¤ addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean)); } // ........................ // å¦‚æœæ˜¯æå‰æš´éœ²çš„å•ä¾‹ if (earlySingletonExposure) { // è·å–æŒ‡å®šåç§°çš„å·²æ³¨å†Œçš„å•ä¾‹æ¨¡å¼çš„Beanå¯¹è±¡ Object earlySingletonReference = getSingleton(beanName, false); if (earlySingletonReference != null) { // å¦‚æœè·å–åˆ°çš„beanå¯¹è±¡ä¸ä¸ºç©º if (exposedObject == bean) { // å¦‚æœè·å–åˆ°çš„Beanå¯¹è±¡ä¸å½“å‰å®ä¾‹åŒ–çš„Beanå¯¹è±¡ç›¸åŒ // å°†å®ä¾‹æš´éœ²å‡ºå»ï¼Œå½“å‰å®ä¾‹åˆå§‹åŒ–å®Œæˆ exposedObject = earlySingletonReference; } // å½“å‰Beanä¾èµ–å…¶ä»–Beanï¼Œå¹¶ä¸”å½“å‘ç”Ÿå¾ªç¯å¼•ç”¨æ—¶ä¸å…è®¸åˆ›å»ºæ–°çš„å®ä¾‹å¯¹è±¡ else if (!this.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) { String[] dependentBeans = getDependentBeans(beanName); Set&lt;String&gt; actualDependentBeans = new LinkedHashSet&lt;&gt;(dependentBeans.length); // è·å–å½“å‰Beanæ‰€ä¾èµ–çš„å…¶ä»–Bean for (String dependentBean : dependentBeans) { if (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) { actualDependentBeans.add(dependentBean); } } // ....... } } } // ...... return exposedObject;} BeanDefinitionValueResolverç±»ä¸‹çš„resolveValueIfNecessary()æ–¹æ³• 1234567891011// è§£æå±æ€§å€¼ï¼Œå¯¹æ³¨å…¥ç±»å‹è¿›è¡Œè½¬æ¢public Object resolveValueIfNecessary(Object argName, @Nullable Object value) { // å¯¹å¼•ç”¨ç±»å‹çš„å±æ€§è¿›è¡Œè§£æ if (value instanceof RuntimeBeanReference) { RuntimeBeanReference ref = (RuntimeBeanReference) value; // è°ƒç”¨å¼•ç”¨ç±»å‹çš„è§£ææ–¹æ³• return resolveReference(argName, ref); } // ......å¯¹å…¶ä»–ç±»å‹çš„å±æ€§çš„è§£æ} å¤§è‡´æµç¨‹ â€‹ æºç åˆ†æAå¼•ç”¨Bã€Bå¼•ç”¨Cã€Cå¼•ç”¨Aã€‚æ ¹æ®ä¸Šé¢å¤§è‡´æµç¨‹æ¥ã€‚åœ¨docreate()æ–¹æ³•ä¸­ï¼Œå…ˆå¯¹aå®ä¾‹åŒ– å°†aå®ä¾‹çš„å¼•ç”¨æš´éœ²å‡ºå» å‡†å¤‡å»å¡«å……å±æ€§ï¼Œè¿›å…¥populateBean()æ–¹æ³•ï¼ŒapplyPropertyValues()æ–¹æ³•ç»§ç»­è¿›å…¥ï¼Œé‡ç‚¹æ¥äº†ï¼ŒresolveValueIfNecessary()æ–¹æ³• ç»§ç»­è¿›å…¥ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä¼šè°ƒç”¨resolveReference()è¿™ä¸ªæ–¹æ³• æœ€ç»ˆåˆä¼šè°ƒç”¨**getBean()**æ–¹æ³• æ¥ä¸‹æ¥æˆ‘å°±çœç•¥å¯¹bçš„å®ä¾‹åŒ–ï¼Œç›´æ¥å»çœ‹å¯¹cçš„ã€‚ ç»§ç»­è·Ÿç€ä¸Šé¢çš„èµ°ï¼Œåœ¨BeanDefinitionValueResolverç±»çš„resolveReference()æ–¹æ³•æ—¶ï¼Œè°ƒç”¨getBean()å»è·å–äº†açš„å®ä¾‹ ä»ç¼“å­˜ä¸­è·å–açš„å®ä¾‹ æˆ‘ä»¬ç»§ç»­è·Ÿè¿›åˆ°cå®ä¾‹çš„doGetBean()æ–¹æ³• è¿™æ—¶å€™ï¼Œcçš„å®ä¾‹åŒ–åˆå§‹åŒ–å·²ç»å®Œæˆäº†ï¼Œç„¶åå°±æ˜¯bçš„åˆå§‹åŒ–ä»¥åŠaçš„åˆå§‹åŒ–äº†ï¼Œæ­¥éª¤ç±»ä¼¼ï¼Œè‡ªè¡Œå»debugå§ã€‚ ç»†èŠ‚1ã€åœ¨ä¸‰çº§ç¼“å­˜ä¸­ï¼Œå®ä¾‹çš„å˜æ›´æƒ…å†µã€‚ä¾‹å¦‚aã€bã€cã€‚åºå·ä»£è¡¨é¡ºåº ä¸€çº§ç¼“å­˜ï¼š7.æ·»åŠ cã€9.æ·»åŠ bã€11.æ·»åŠ a äºŒçº§ç¼“å­˜ï¼š4.æ·»åŠ aã€10.ç§»é™¤a ä¸‰çº§ç¼“å­˜ï¼š1.æ·»åŠ aã€2.æ·»åŠ bã€3.æ·»åŠ cã€5.ç§»é™¤aã€6.ç§»é™¤cã€8.ç§»é™¤b 2ã€å…³äºæ„é€ å™¨æ³¨å…¥å’Œsetæ³¨å…¥ï¼Œä¸‹é¢æ˜¯å®˜ç½‘çš„è§£é‡Š","link":"/2021/04/22/%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96/"},{"title":"é€šè¿‡Javaå®ç°Raftç®—æ³•","text":"å‰è¨€7æœˆä»½çš„æ—¶å€™å‚åŠ äº†ä¸€ä¸ªé˜¿é‡Œå¤©æ± çš„æ€§èƒ½ä¼˜åŒ–æ¯”èµ›ï¼Œåé¢åœ¨å¤èµ›çš„æ—¶å€™å› ä¸ºæ˜¯é›†ç¾¤åœºæ™¯ï¼Œéœ€è¦è€ƒè™‘å„ä¸ªèŠ‚ç‚¹ä¹‹é—´æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæœ¬æ¥æƒ³è‡ªå·±å®ç°çš„ï¼Œä½†å¥ˆä½•æ—¶é—´å¤ªçŸ­ï¼ˆps: å¤ªèœäº†ğŸ˜­ï¼‰ï¼Œæœ€ç»ˆè¿˜æ˜¯æ‰¾äº†å¸‚é¢ä¸Šæˆç†Ÿçš„ä¸­é—´ä»¶æ¥å®ç°ï¼ˆIgniteï¼‰ã€‚è¿™ä¸ï¼Œè¿˜æ˜¯æ‰‹ç—’ï¼Œè‡ªå·±å®ç°ä¸€ä¸ªåŸºäºRaftçš„ä¸€è‡´æ€§æœåŠ¡ã€‚ Githubï¼šzraft ä¸ªäººåšå®¢ï¼šzhaommmmomo Raftæ˜¯ä»€ä¹ˆï¼ŸRaftæ˜¯ä¸€ä¸ªä¸ºäº†ç®¡ç†å¤åˆ¶æ—¥å¿—çš„ä¸€è‡´æ€§ç®—æ³•ã€‚å®ƒæä¾›å’ŒPaxosç®—æ³•ç›¸åŒçš„åŠŸèƒ½å’Œæ€§èƒ½ï¼Œä½†æ˜¯å®ƒçš„ç®—æ³•ç»“æ„ä¸Paxosä¸åŒå¹¶ä¸”æ›´åŠ æ˜“äºç†è§£ Raft é€šè¿‡é€‰ä¸¾ä¸€ä¸ªLeaderï¼Œç„¶åç»™äºˆä»–å…¨éƒ¨çš„ç®¡ç†å¤åˆ¶æ—¥å¿—çš„è´£ä»»æ¥å®ç°ä¸€è‡´æ€§ã€‚é¢†å¯¼äººä»å®¢æˆ·ç«¯æ¥æ”¶æ—¥å¿—æ¡ç›®ï¼ˆlog entriesï¼‰ï¼ŒæŠŠæ—¥å¿—æ¡ç›®å¤åˆ¶åˆ°å…¶ä»–æœåŠ¡å™¨ä¸Šï¼Œå¹¶å‘Šè¯‰å…¶ä»–çš„æœåŠ¡å™¨ä»€ä¹ˆæ—¶å€™å¯ä»¥å®‰å…¨åœ°å°†æ—¥å¿—æ¡ç›®åº”ç”¨åˆ°ä»–ä»¬çš„çŠ¶æ€æœºä¸­ã€‚æ•°æ®çš„æµå‘åªèƒ½æ˜¯Leader -&gt; otherNodeã€‚ çŠ¶æ€æœº å¤åˆ¶çŠ¶æ€æœºé€šå¸¸éƒ½æ˜¯åŸºäºå¤åˆ¶æ—¥å¿—å®ç°çš„ï¼Œå¦‚å›¾ 1ã€‚æ¯ä¸€ä¸ªæœåŠ¡å™¨å­˜å‚¨ä¸€ä¸ªåŒ…å«ä¸€ç³»åˆ—æŒ‡ä»¤çš„æ—¥å¿—ï¼Œå¹¶ä¸”æŒ‰ç…§æ—¥å¿—çš„é¡ºåºè¿›è¡Œæ‰§è¡Œã€‚æ¯ä¸€ä¸ªæ—¥å¿—éƒ½æŒ‰ç…§ç›¸åŒçš„é¡ºåºåŒ…å«ç›¸åŒçš„æŒ‡ä»¤ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªæœåŠ¡å™¨éƒ½æ‰§è¡Œç›¸åŒçš„æŒ‡ä»¤åºåˆ—ã€‚å› ä¸ºæ¯ä¸ªçŠ¶æ€æœºéƒ½æ˜¯ç¡®å®šçš„ï¼Œæ¯ä¸€æ¬¡æ‰§è¡Œæ“ä½œéƒ½äº§ç”Ÿç›¸åŒçš„çŠ¶æ€å’ŒåŒæ ·çš„åºåˆ—ã€‚ ä¸€è‡´æ€§ç®—æ³•çš„ä»»åŠ¡æ˜¯ä¿è¯å¤åˆ¶æ—¥å¿—çš„ä¸€è‡´æ€§ã€‚æœåŠ¡å™¨ä¸Šçš„ä¸€è‡´æ€§æ¨¡å—æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æŒ‡ä»¤ç„¶åæ·»åŠ åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­ã€‚å®ƒå’Œå…¶ä»–æœåŠ¡å™¨ä¸Šçš„ä¸€è‡´æ€§æ¨¡å—è¿›è¡Œé€šä¿¡æ¥ä¿è¯æ¯ä¸€ä¸ªæœåŠ¡å™¨ä¸Šçš„æ—¥å¿—æœ€ç»ˆéƒ½ä»¥ç›¸åŒçš„é¡ºåºåŒ…å«ç›¸åŒçš„è¯·æ±‚ï¼Œå³ä½¿æœ‰äº›æœåŠ¡å™¨å‘ç”Ÿæ•…éšœã€‚ä¸€æ—¦æŒ‡ä»¤è¢«æ­£ç¡®çš„å¤åˆ¶ï¼Œæ¯ä¸€ä¸ªæœåŠ¡å™¨çš„çŠ¶æ€æœºæŒ‰ç…§æ—¥å¿—é¡ºåºå¤„ç†ä»–ä»¬ï¼Œç„¶åè¾“å‡ºç»“æœè¢«è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å› æ­¤ï¼ŒæœåŠ¡å™¨é›†ç¾¤çœ‹èµ·æ¥å½¢æˆäº†ä¸€ä¸ªé«˜å¯é çš„çŠ¶æ€æœºã€‚ å®é™…ç³»ç»Ÿä¸­ä½¿ç”¨çš„ä¸€è‡´æ€§ç®—æ³•é€šå¸¸å«æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š å®‰å…¨æ€§ä¿è¯ï¼ˆç»å¯¹ä¸ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯çš„ç»“æœï¼‰ï¼šåœ¨éæ‹œå åº­é”™è¯¯æƒ…å†µä¸‹ï¼ŒåŒ…æ‹¬ç½‘ç»œå»¶è¿Ÿã€åˆ†åŒºã€ä¸¢åŒ…ã€é‡å¤å’Œä¹±åºç­‰é”™è¯¯éƒ½å¯ä»¥ä¿è¯æ­£ç¡®ã€‚ å¯ç”¨æ€§ï¼šé›†ç¾¤ä¸­åªè¦æœ‰å¤§å¤šæ•°çš„æœºå™¨å¯è¿è¡Œå¹¶ä¸”èƒ½å¤Ÿç›¸äº’é€šä¿¡ã€å’Œå®¢æˆ·ç«¯é€šä¿¡ï¼Œå°±å¯ä»¥ä¿è¯å¯ç”¨ã€‚å› æ­¤ï¼Œä¸€ä¸ªå…¸å‹çš„åŒ…å« 5 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤å¯ä»¥å®¹å¿ä¸¤ä¸ªèŠ‚ç‚¹çš„å¤±è´¥ã€‚æœåŠ¡å™¨è¢«åœæ­¢å°±è®¤ä¸ºæ˜¯å¤±è´¥ã€‚å®ƒä»¬ç¨åå¯èƒ½ä¼šä»å¯é å­˜å‚¨çš„çŠ¶æ€ä¸­æ¢å¤å¹¶é‡æ–°åŠ å…¥é›†ç¾¤ã€‚ ä¸ä¾èµ–æ—¶åºæ¥ä¿è¯ä¸€è‡´æ€§ï¼šç‰©ç†æ—¶é’Ÿé”™è¯¯æˆ–è€…æç«¯çš„æ¶ˆæ¯å»¶è¿Ÿåªæœ‰åœ¨æœ€åæƒ…å†µä¸‹æ‰ä¼šå¯¼è‡´å¯ç”¨æ€§é—®é¢˜ã€‚ é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€æ¡æŒ‡ä»¤å¯ä»¥å°½å¯èƒ½å¿«çš„åœ¨é›†ç¾¤ä¸­å¤§å¤šæ•°èŠ‚ç‚¹å“åº”ä¸€è½®è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æ—¶å®Œæˆã€‚å°éƒ¨åˆ†æ¯”è¾ƒæ…¢çš„èŠ‚ç‚¹ä¸ä¼šå½±å“ç³»ç»Ÿæ•´ä½“çš„æ€§èƒ½ã€‚ æ¦‚å¿µèŠ‚ç‚¹çŠ¶æ€ Leaderï¼šè´Ÿè´£å¤„ç†æ‰€æœ‰Clientè¯·æ±‚ï¼Œå¹¶å°†entriesé€šè¿‡AppendEntries()RPCæ–¹æ³•æ·»åŠ åˆ°å…¶ä»–èŠ‚ç‚¹å»ã€‚ Candidateï¼šå¯ä»¥å˜ä¸ºLeaderçš„èŠ‚ç‚¹ã€‚å½“æŸä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°å¿ƒè·³æˆ–è€…æ”¶åˆ°çš„å¤§å¤šæ•°ç¥¨æ•°æ—¶ï¼Œå°±ä¼šå˜ä¸ºLeaderï¼Œç»™å…¶ä»–èŠ‚ç‚¹å‘é€å¿ƒè·³ã€‚å¦åˆ™å˜ä¸ºFollower Followerï¼šåªå“åº”æ¥è‡ªå…¶ä»–æœåŠ¡å™¨çš„è¯·æ±‚ã€‚é›†ç¾¤åˆšå¯åŠ¨æ—¶ï¼Œæ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€éƒ½æ˜¯Followerï¼Œå½“æŸä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°å…¶ä»–èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œå°±ä¼šå˜ä¸ºCandidateå¹¶å‘å…¶ä»–èŠ‚ç‚¹è¯·æ±‚æŠ•ç¥¨ã€‚ ä»»æœŸï¼ˆtermï¼‰ Raftå°†ä»»æœŸï¼ˆtermï¼‰ä½œä¸ºé€»è¾‘æ—¶é—´ã€‚ä»»æœŸè‡ªå¢çš„æ•´æ•°è¡¨ç¤ºï¼ˆåˆå§‹ä¸º0ï¼‰ã€‚æ¯ä¸€æ®µä»»æœŸä»ä¸€æ¬¡é€‰ä¸¾å¼€å§‹ï¼Œå¦‚æœä¸€ä¸ªå€™é€‰äººèµ¢å¾—é€‰ä¸¾ï¼Œç„¶åä»–å°±åœ¨æ¥ä¸‹æ¥çš„ä»»æœŸå†…å……å½“é¢†å¯¼äººçš„èŒè´£ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸€æ¬¡é€‰ä¸¾è¿‡ç¨‹ä¼šé€ æˆé€‰ç¥¨çš„ç“œåˆ†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™ä¸€ä»»æœŸä¼šä»¥æ²¡æœ‰é¢†å¯¼äººç»“æŸï¼›ä¸€ä¸ªæ–°çš„ä»»æœŸï¼ˆå’Œä¸€æ¬¡æ–°çš„é€‰ä¸¾ï¼‰ä¼šå¾ˆå¿«é‡æ–°å¼€å§‹ã€‚Raft ä¿è¯äº†åœ¨ä¸€ä¸ªç»™å®šçš„ä»»æœŸå†…ï¼Œæœ€å¤šåªæœ‰ä¸€ä¸ªé¢†å¯¼äººã€‚ é€‰ä¸¾æ–¹æ³•ï¼ˆRequestVote()ï¼‰ å¦‚æœterm &lt; currentTermè¿”å› false å¦‚æœ votedFor ä¸ºç©ºæˆ–è€…ä¸º candidateIdï¼Œå¹¶ä¸”å€™é€‰äººçš„æ—¥å¿—è‡³å°‘å’Œè‡ªå·±ä¸€æ ·æ–°ï¼Œé‚£ä¹ˆå°±æŠ•ç¥¨ç»™ä»– 1234567891011121314151617181920public VoteResponse requestVote(VoteRequest voteRequest) { // å¦‚æœterm &lt; currentTermè¿”å› false // å¦‚æœ votedFor ä¸ºç©ºæˆ–è€…ä¸º candidateIdï¼Œå¹¶ä¸”å€™é€‰äººçš„æ—¥å¿—è‡³å°‘å’Œè‡ªå·±ä¸€æ ·æ–°ï¼Œé‚£ä¹ˆå°±æŠ•ç¥¨ç»™ä»–}Class VoteRequest { /** å€™é€‰äººçš„ä»»æœŸå· */ long term; /** å€™é€‰äººId */ long candidateId; /** å€™é€‰äººçš„æœ€åæ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼ */ long lastLogIndex; /** å€™é€‰äººæœ€åæ—¥å¿—æ¡ç›®çš„ä»»æœŸå· */ long lastLogTerm}class VoteResponse { /** å½“å‰èŠ‚ç‚¹çš„ä»»æœŸå· */ long term; /** æ˜¯å¦æŠ•ç¥¨ */ boolean voteGranted;} é›†ç¾¤åˆšå¯åŠ¨çš„æ—¶å€™ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯FollowerçŠ¶æ€ã€‚å¦‚æœFolloweråœ¨é€‰ä¸¾è¶…æ—¶å†…æ¯æ”¶åˆ°å¿ƒè·³æˆ–è€…æŠ•ç¥¨è¯·æ±‚ï¼Œå®ƒå°±ä¼šè¿›è¡Œé€‰ä¸¾æŠ•ç¥¨ï¼Œå…ˆå¢åŠ è‡ªå·±çš„ä»»æœŸå·å¹¶è½¬æ¢ä¸ºCandidateï¼Œç„¶åå‘å…¶ä»–èŠ‚ç‚¹å‘é€RPCæŠ•ç¥¨è¯·æ±‚ã€‚ è·å¾—äº†å¤§å¤šæ•°çš„é€‰ç¥¨ã€‚ä¿®æ”¹çŠ¶æ€ä¸ºLeaderï¼Œä¿®æ”¹ç»´æŠ¤çš„nextIndex[]æ•°ç»„ä¸ºå½“å‰æ—¥å¿—æ¡ç›®çš„ç´¢å¼•ï¼Œå…³é—­ç­‰å¾…è¶…æ—¶è®¡æ—¶å™¨ï¼Œå¼€å¯å¿ƒè·³è®¡æ—¶å™¨å¹¶å‘é€å¿ƒè·³åŒ…ã€‚ å…¶ä»–èŠ‚ç‚¹æˆä¸ºLeaderã€‚å¦‚æœLeaderçš„ä»»æœŸå·ä¸å°äºå½“å‰ä»»æœŸå·ï¼Œä¿®æ”¹çŠ¶æ€ä¸ºFollowerã€‚ å‡ºç°åŒç¥¨æƒ…å†µã€‚éšæœºç”Ÿæˆè¶…æ—¶æ—¶é—´åé‡æ–°å¼€å§‹æ–°ä¸€è½®çš„é€‰ä¸¾ã€‚ è¿½åŠ æ¡ç›®ï¼ˆAppendEntries()ï¼‰åªèƒ½ç”±Leader -&gt; å…¶ä»–èŠ‚ç‚¹ï¼Œä¸èƒ½åˆ°Leaderï¼Œæ˜¯å•å‘çš„ã€‚ Clientå‘é€RPCè¯·æ±‚ï¼ŒLeaderé¦–å…ˆä¼šå°†æ—¥å¿—è¿½åŠ åˆ°æœ¬åœ°ï¼Œè¿½åŠ å¤±è´¥åˆ™è¿”å›falseã€‚ç„¶åé€šè¿‡AppendEntries()æ–¹æ³•åŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šå»ï¼Œå½“Leaderæ”¶åˆ°å¤§å¤šæ•°èŠ‚ç‚¹å“åº”trueæ—¶ï¼Œä¼šå°†è¯¥æ—¥å¿—æ¡ç›®Commitï¼Œç„¶åå°†ç»“æœè¿”å›ç»™Clientï¼Œç„¶åé€šçŸ¥å…¶ä»–èŠ‚ç‚¹Commitã€‚ å½“è¿½åŠ çš„æ¡ç›®ä¸ºç©ºæ—¶ï¼Œä»£è¡¨è¿™æ˜¯ä¸ªå¿ƒè·³åŒ… å¦‚æœå½“å‰ä»»æœŸå¤§äºè¯·æ±‚ä»»æœŸï¼Œè¿”å›false å¦‚æœå½“å‰æ—¥å¿—æ¡ç›®æ²¡æœ‰èƒ½å¤Ÿä¸preLogIndexå’ŒpreLogTermåŒ¹é…çš„ï¼Œè¿”å›false é‡ç½®ç­‰å¾…è®¡æ—¶å™¨ç­‰å¾…æ—¶é—´ å¦‚æœå‘ç”Ÿæ¡ç›®å†²çªï¼ˆç´¢å¼•ç›¸åŒï¼Œä»»æœŸä¸åŒï¼‰ï¼Œåˆ é™¤å†²çªç´¢å¼•ä»¥åçš„æ‰€æœ‰æ—¥å¿— è¿½åŠ æ—¥å¿—æ¡ç›® å¦‚æœLeaderçš„commitIndexå¤§äºæœ¬åœ°çš„ï¼Œå°†æœ¬åœ°çš„è®¾ç½®ä¸ºmin(commitIndex. logIndex) 123456789101112131415161718192021222324252627282930313233public AppendResponse appendEntries(AppendRequest appendRequest) { // å¦‚æœå½“å‰ä»»æœŸå¤§äºè¯·æ±‚ä»»æœŸï¼Œè¿”å›false // å¦‚æœå½“å‰æ—¥å¿—æ¡ç›®æ²¡æœ‰èƒ½å¤Ÿä¸preLogIndexå’ŒpreLogTermåŒ¹é…çš„ï¼Œè¿”å›false // é‡ç½®ç­‰å¾…è®¡æ—¶å™¨ç­‰å¾…æ—¶é—´ // å¦‚æœå‘ç”Ÿæ¡ç›®å†²çªï¼ˆç´¢å¼•ç›¸åŒï¼Œä»»æœŸä¸åŒï¼‰ï¼Œåˆ é™¤å†²çªç´¢å¼•ä»¥åçš„æ‰€æœ‰æ—¥å¿— // è¿½åŠ æ—¥å¿—æ¡ç›® // å¦‚æœLeaderçš„commitIndexå¤§äºæœ¬åœ°çš„ï¼Œå°†æœ¬åœ°çš„è®¾ç½®ä¸ºmin(commitIndex. logIndex)}class AppendRequest { /** Leaderçš„ä»»æœŸå· */ long term; /** LeaderId */ long leaderId; /** æ–°æ—¥å¿—çš„å‰ä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ç´¢å¼• */ long preLogIndex; /** æ–°æ—¥å¿—çš„å‰ä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ä»»æœŸå· */ long preLogTerm; /** éœ€è¦æ·»åŠ çš„æ¡ç›®ä¿¡æ¯ */ List&lt;Entry&gt; entries; /** Leaderçš„æäº¤ç´¢å¼• */ long leaderCommit;}class Entry { long term; /** å‘½ä»¤ */ String command;}class AppendResponse { /** å½“å‰èŠ‚ç‚¹çš„ä»»æœŸå· */ long term; /** Followerçš„æ¡ç›®æ˜¯å¦ä¸Leaderçš„åŒ¹é…ä¸Šäº† */ boolean success;} Leaderå¯¹äºæ¯ä¸ªFolloweréƒ½ç»´æŠ¤ ä¸€ä¸ªnextIndexï¼Œè®°å½•éœ€è¦ç»™è¯¥Followerå‘é€çš„ä¸‹ä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ç´¢å¼•ã€‚å½“æŸä¸€ä¸ªèŠ‚ç‚¹åˆšæˆä¸ºLeaderæ—¶ï¼Œå®ƒä¼šå°†æ‰€æœ‰nextIndexè®¾ç½®ä¸ºè‡ªå·±çš„æœ€åä¸€ä¸ªæ—¥å¿—çš„index + 1ã€‚å¦‚æœä¸€ä¸ªFollowerçš„æ—¥å¿—å’ŒLeaderä¸ä¸€è‡´ï¼Œé‚£ä¹ˆåœ¨ä¸‹ä¸€æ¬¡çš„AppendEntries() RPC æ—¶çš„ä¸€è‡´æ€§æ£€æŸ¥å°±ä¼šå¤±è´¥ã€‚åœ¨è¢«Followeræ‹’ç»ä¹‹åï¼ŒLeaderå°±ä¼šå‡å° nextIndex å€¼å¹¶è¿›è¡Œé‡è¯•ã€‚æœ€ç»ˆ nextIndex ä¼šåœ¨æŸä¸ªä½ç½®ä½¿å¾—Leaderå’ŒFollowerçš„æ—¥å¿—è¾¾æˆä¸€è‡´ã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œé™„åŠ æ—¥å¿— RPC å°±ä¼šæˆåŠŸï¼Œè¿™æ—¶å°±ä¼šæŠŠFollowerå†²çªçš„æ—¥å¿—æ¡ç›®å…¨éƒ¨åˆ é™¤å¹¶ä¸”åŠ ä¸ŠLeaderçš„æ—¥å¿—ã€‚ä¸€æ—¦é™„åŠ æ—¥å¿— RPC æˆåŠŸï¼Œé‚£ä¹ˆFollowerçš„æ—¥å¿—å°±ä¼šå’ŒLeaderä¿æŒä¸€è‡´ï¼Œå¹¶ä¸”åœ¨æ¥ä¸‹æ¥çš„ä»»æœŸé‡Œä¸€ç›´ç»§ç»­ä¿æŒã€‚ å®ç°æ ¸å¿ƒç±»å›¾ æ ¸å¿ƒæ–¹æ³•requestVote() å¦‚æœå€™é€‰äººçš„term &lt; currentTermï¼Œä¸ç»™è¯¥å€™é€‰äººæŠ•ç¥¨ å¦‚æœå½“å‰èŠ‚ç‚¹æ²¡æœ‰æŠ•ç¥¨æˆ–è€…æŠ•ç»™äº†å€™é€‰äººå¹¶ä¸”å€™é€‰äººæ—¥å¿—å’Œå½“å‰èŠ‚ç‚¹ä¸€æ ·æ–°ï¼Œå°±ç»™è¯¥å€™é€‰äººæŠ•ç¥¨ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071/** * èŠ‚ç‚¹é€‰ä¸¾ * é€‰ä¸¾è¶…æ—¶ï¼šFollowerç­‰å¾…æˆä¸ºLeaderçš„æ—¶é—´ï¼Œéšæœºè®¾ç½®åœ¨150ms ~ 300ms * @param request { * term: å€™é€‰äººä»»æœŸå· * candidateId: å€™é€‰äººId * lastLogIndex: å€™é€‰äººæœ€å¥½çš„æ—¥å¿—æ¡ç›®ç´¢å¼•å€¼ * lastLogTerm: å€™é€‰äººæœ€åæ—¥å¿—æ¡ç›®çš„ä»»æœŸå· * } * ZRaftResponse { * &quot;term&quot;: å½“å‰ä»»æœŸå· * &quot;voteGranted&quot;: true / false * æ˜¯å¦è¢«æŠ•ç¥¨ * } */public void requestVote(VoteRequest request, StreamObserver&lt;ZRaftResponse&gt; responseObserver) { // å½“èŠ‚ç‚¹æ”¶åˆ°æ¯”è‡ªå·±å¤§çš„ä»»æœŸï¼Œä¼šå°†è‡ªå·±çš„ä»»æœŸè®¾ç½®ä¸ºç›¸åŒçš„ï¼Œç„¶åç›´æ¥æŠ•ç¥¨ // å½“èŠ‚ç‚¹æ”¶åˆ°å’Œè‡ªå·±ä¸€æ ·å¤§çš„ä»»æœŸï¼Œä¼šçœ‹è‡ªå·±æ˜¯å¦å·²ç»æŠ•ç¥¨æ¥åˆ¤æ–­ ZRaftResponse response = ZRaftResponse.newBuilder() .setTerm(NodeManager.node.getCurrentTerm()) .setSuccess(vote(request)) .build(); responseObserver.onNext(response); responseObserver.onCompleted();}/** * åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦æŠ•ç¥¨ç»™å€™é€‰äºº * å¦‚æœå€™é€‰äººçš„term &lt; currentTermï¼Œä¸ç»™è¯¥å€™é€‰äººæŠ•ç¥¨ * å¦‚æœå½“å‰èŠ‚ç‚¹æ²¡æœ‰æŠ•ç¥¨æˆ–è€…æŠ•ç»™äº†å€™é€‰äººå¹¶ä¸”å€™é€‰äººæ—¥å¿—å’Œå½“å‰èŠ‚ç‚¹ä¸€æ ·æ–°ï¼Œå°±ç»™è¯¥å€™é€‰äººæŠ•ç¥¨ * @param request å€™é€‰äººid * @return true / false */private synchronized boolean vote(VoteRequest request) { long term = request.getTerm(); long currentTerm = NodeManager.node.getCurrentTerm(); if (term &lt; currentTerm) { // å¦‚æœè¯·æ±‚è€…ä»»æœŸå°äºå½“å‰èŠ‚ç‚¹ä»»æœŸ return false; } if (term &gt; currentTerm) { // æ›´æ–°ç­‰å¾…å®šæ—¶å™¨çš„æ—¶é—´ NodeManager.electionListener .updatePreHeartTime(System.currentTimeMillis()); // ä¿®æ”¹èŠ‚ç‚¹ä»»æœŸä¿¡æ¯ zRaftService.updateNodeTermInfo(request); return true; } long votedFor = NodeManager.node.getVotedFor(); long candidateId = request.getCandidateId(); if (votedFor == 0 || (votedFor == candidateId &amp;&amp; NodeManager.node.getLogIndex() == request.getLastLogIndex() &amp;&amp; NodeManager.node.getLastLogTerm() == request.getLastLogTerm())) { // å¦‚æœå½“å‰èŠ‚ç‚¹æ²¡æœ‰æŠ•ç¥¨æˆ–è€… // ç»™è¯·æ±‚è€…æŠ•ç¥¨äº†å¹¶ä¸”æ—¥å¿—ç´¢å¼•ä¸ä»»æœŸèƒ½å¯¹åº” // æ›´æ–°ç­‰å¾…å®šæ—¶å™¨çš„æ—¶é—´ NodeManager.electionListener .updatePreHeartTime(System.currentTimeMillis()); NodeManager.node.setLeaderId(0); NodeManager.node.setVotedFor(candidateId); NodeManager.printNodeInfo(); return true; } return false;} appendEntries() Leaderæ¥æ”¶åˆ°æ•°æ®æ›´æ”¹ï¼Œå°†æ›´æ”¹æ·»åŠ åˆ°èŠ‚ç‚¹æ—¥å¿—ä¸­ï¼ˆä¸æäº¤ï¼‰ å°†è¯¥æ¡ç›®å¤åˆ¶åˆ°Followerï¼Œç­‰å¾…å›å¤ï¼Œç›´åˆ°å¤§å¤šæ•°ï¼ˆn / 2 + 1ï¼‰èŠ‚ç‚¹å“åº”æˆåŠŸã€‚å¦‚æœæ²¡æœ‰è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹å“åº”æˆåŠŸï¼Œéš”æ®µè¶…æ—¶æ—¶é—´åé‡æ–°å‘é€ã€‚ Leaderæäº¤æ•°æ®ï¼Œç„¶åå°†ç»“æœè¿”å›ç»™å¹¶é€šçŸ¥Followerè¿›è¡Œæäº¤ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495/** * è¿½åŠ æ¡ç›®ï¼Œå¿ƒè·³ï¼ŒèŠ‚ç‚¹é—´æ•°æ®çš„åŒæ­¥ï¼Œæ—¥å¿—å¤åˆ¶ * 1. Leaderæ¥æ”¶åˆ°æ•°æ®æ›´æ”¹ï¼Œå°†æ›´æ”¹æ·»åŠ åˆ°èŠ‚ç‚¹æ—¥å¿—ä¸­ï¼ˆä¸æäº¤ï¼‰ * 2. å°†è¯¥æ¡ç›®å¤åˆ¶åˆ°Followerï¼Œç­‰å¾…å›å¤ï¼Œç›´åˆ°å¤§å¤šæ•°ï¼ˆn / 2 + 1ï¼‰ * èŠ‚ç‚¹å“åº”æˆåŠŸã€‚å¦‚æœæ²¡æœ‰è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹å“åº”æˆåŠŸï¼Œéš”æ®µè¶…æ—¶æ—¶é—´åé‡æ–°å‘é€ * 3. Leaderæäº¤æ•°æ®ï¼Œç„¶åå°†ç»“æœè¿”å›ç»™å¹¶é€šçŸ¥Followerè¿›è¡Œæäº¤ * @param request { * term: Leaderä»»æœŸ * leaderId: æœ‰æ—¶å€™å¯èƒ½æ˜¯Candidateæ”¶åˆ°è¯·æ±‚ï¼Œ * éœ€è¦å°†è¯·æ±‚é‡å®šå‘åˆ°Leaderå» * preLogIndex: å‰ä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ç´¢å¼• * preLogTerm: å‰ä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ä»»æœŸ * entries: éœ€è¦è¢«ä¿å­˜çš„æ—¥å¿—æ¡ç›®ï¼ˆå¦‚æœä¸ºç©ºï¼Œä»£è¡¨æ˜¯å¿ƒè·³ï¼‰ * leaderCommit: Leaderå·²æäº¤çš„æœ€é«˜æ—¥å¿—æ¡ç›®çš„ç´¢å¼• * } * ZRaftResponse { * &quot;term&quot;: å½“å‰ä»»æœŸ * &quot;success&quot;: true / falseã€‚å¦‚æœCandidate * æ‰€å«æœ‰çš„æ¡ç›®å’ŒprevLogIndexä»¥åŠpreLogTerm * åŒ¹é…ä¸Šï¼Œåˆ™ä¸ºtrueã€‚ * } */@Overridepublic void appendEntries(AppendRequest request, StreamObserver&lt;ZRaftResponse&gt; responseObserver) { NodeManager.printLog(&quot;appendEntries...&quot;); ZRaftResponse.Builder builder = ZRaftResponse.newBuilder() .setTerm(NodeManager.node.getCurrentTerm()); // å¦‚æœcurrentTerm &gt; term long term = request.getTerm(); long currentTerm = NodeManager.node.getCurrentTerm(); if (term &lt; currentTerm) { // è¿”å›false builder.setSuccess(false); responseObserver.onNext(builder.build()); responseObserver.onCompleted(); return; } // æ›´æ–°ç­‰å¾…è®¡æ—¶å™¨ NodeManager.electionListener .updatePreHeartTime(System.currentTimeMillis()); // å¦‚æœterm &gt; currentTerm æˆ–è€…å½“å‰èŠ‚ç‚¹çŠ¶æ€æ˜¯Candidate Node.NodeState state = NodeManager.node.getNodeState(); if (term &gt; currentTerm || state == Node.NodeState.CANDIDATE) { // ä¿®æ”¹ä»»æœŸçŠ¶æ€å¹¶åˆ‡æ¢ä¸ºFollower zRaftService.levelDown(request); } else { // è®¾ç½®LeaderId long leaderId = NodeManager.node.getLeaderId(); if (leaderId == 0) { NodeManager.node.setLeaderId(request.getLeaderId()); NodeManager.node.setNodeState(Node.NodeState.FOLLOWER); NodeManager.printNodeInfo(); } } long preLogTerm = request.getPreLogTerm(); long preLogIndex = request.getPreLogIndex(); // å¦‚æœLeaderæ—¥å¿—ç´¢å¼•ä¸èƒ½åœ¨å½“å‰èŠ‚ç‚¹çš„ç´¢å¼•ä¸Šæ‰¾åˆ° if (!NodeManager.node.entryIsExist(preLogTerm, preLogIndex)) { // è¿”å›false builder.setSuccess(false); responseObserver.onNext(builder.build()); responseObserver.onCompleted(); return; } boolean b = true; // å¦‚æœä¸æ˜¯å¿ƒè·³åŒ… List&lt;Entry&gt; entries = request.getEntriesList(); if (entries.size() != 0) { // æ·»åŠ æ—¥å¿—æ¡ç›® b = NodeManager.node.addLogEntries(preLogIndex, entries); NodeManager.printLog(NodeManager.node.toString()); } // åˆ¤æ–­æ˜¯å¦è¦æäº¤æ¡ç›® long leaderCommit = request.getLeaderCommit(); long commitIndex = NodeManager.node.getCommitIndex(); if (leaderCommit &gt; commitIndex) { // å°†æäº¤ b = NodeManager.node.commitLog(leaderCommit) &amp;&amp; b; } builder.setSuccess(b); responseObserver.onNext(builder.build()); responseObserver.onCompleted();} sendCommand()å®¢æˆ·ç«¯è°ƒç”¨çš„RPCæ–¹æ³•ã€‚ å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯Leader: ç¬¬ä¸€é˜¶æ®µï¼Œå°†æŒ‡ä»¤ä¿å­˜åœ¨logæ¡ç›®ä¸­ï¼Œç»™å…¶ä»–èŠ‚ç‚¹å‘é€AppendEntriesï¼Œå¼‚æ­¥ç­‰å¾…æ¶ˆæ¯ã€‚ ç¬¬äºŒé˜¶æ®µï¼Œå½“å¤§å¤šæ•°èŠ‚ç‚¹è¿”å›trueï¼Œåœ¨æœ¬åœ°è¿›è¡Œæäº¤å¹¶å°†ç»“æœè¿”å›ç»™ç”¨æˆ·ï¼ŒåŒæ—¶å‘å…¶ä»–èŠ‚ç‚¹å‘é€æäº¤å‘½ä»¤. å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯Follower: å°†è¯¥è¯·æ±‚é‡å®šå‘åˆ°Leaderå»ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849/** * å®¢æˆ·ç«¯è°ƒç”¨çš„RPCæ–¹æ³•ã€‚ * å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯Leader: * ç¬¬ä¸€é˜¶æ®µï¼Œå°†æŒ‡ä»¤ä¿å­˜åœ¨logæ¡ç›®ä¸­ï¼Œç»™å…¶ä»–èŠ‚ç‚¹å‘é€AppendEntriesï¼Œå¼‚æ­¥ç­‰å¾…æ¶ˆæ¯ã€‚ * ç¬¬äºŒé˜¶æ®µï¼Œå½“å¤§å¤šæ•°èŠ‚ç‚¹è¿”å›trueï¼Œåœ¨æœ¬åœ°è¿›è¡Œæäº¤å¹¶å°†ç»“æœè¿”å›ç»™ç”¨æˆ·ï¼ŒåŒæ—¶å‘å…¶ä»–èŠ‚ç‚¹ * å‘é€æäº¤å‘½ä»¤. * å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯Follower: * å°†è¯¥è¯·æ±‚é‡å®šå‘åˆ°Leaderå»ã€‚ * @param request æŒ‡ä»¤é›†ï¼ˆå­—ç¬¦ä¸²listï¼‰ */@Overridepublic void sendCommand(Command request, StreamObserver&lt;ClientResponse&gt; responseObserver) { ProtocolStringList commandList = request.getCommandList(); ClientResponse.Builder builder = ClientResponse.newBuilder(); boolean b = false; int size = commandList.size(); Node.NodeState state = NodeManager.node.getNodeState(); long leaderId = NodeManager.node.getLeaderId(); if (size == 0 || state != Node.NodeState.LEADER) { // å¦‚æœç”¨æˆ·æ²¡æœ‰å‘é€æ¡ç›®æˆ–è€…å½“å‰èŠ‚ç‚¹ä¸æ˜¯Leaderï¼Œç›´æ¥è¿”å›falseå¹¶æ·»åŠ LeaderId responseObserver.onNext(builder.setSuccess(b).setLeaderId(leaderId).build()); responseObserver.onCompleted(); return; } // å¤„ç†è¯¥è¯·æ±‚ // ç¬¬ä¸€é˜¶æ®µï¼Œä¿å­˜æŒ‡ä»¤åˆ°æœ¬åœ°å¹¶ç»™å…¶ä»–èŠ‚ç‚¹å‘é€æ¶ˆæ¯ long currentTerm = NodeManager.node.getCurrentTerm(); List&lt;Entry&gt; entries = new ArrayList&lt;&gt;(); for (String command : commandList) { Entry entry = Entry.newBuilder() .setTerm(currentTerm) .setCommand(command) .build(); entries.add(entry); } if (!NodeManager.node.addLogEntries(entries)) { // å¦‚æœæœ¬åœ°æ·»åŠ æ¡ç›®å¤±è´¥ï¼Œè¿”å›false responseObserver.onNext(builder.setSuccess(b).setLeaderId(leaderId).build()); responseObserver.onCompleted(); return; } // å°†è¿”å›äº¤ç»™AppendFutureListener AppendFutureListener.responseObserver = responseObserver; // å‘é€RPCè¯·æ±‚ zRaftService.sendAppendEntries(1);} å‚è€ƒèµ„æ–™Raftè®ºæ–‡ RaftåŠ¨æ€å±•ç¤º MIT6.824","link":"/2021/11/03/%E9%80%9A%E8%BF%87Java%E5%AE%9E%E7%8E%B0Raft%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"Java","slug":"Java","link":"/tags/Java/"},{"name":"æºç ","slug":"æºç ","link":"/tags/%E6%BA%90%E7%A0%81/"},{"name":"Collection","slug":"Collection","link":"/tags/Collection/"},{"name":"Hexo","slug":"Hexo","link":"/tags/Hexo/"},{"name":"icarus","slug":"icarus","link":"/tags/icarus/"},{"name":"é…ç½®","slug":"é…ç½®","link":"/tags/%E9%85%8D%E7%BD%AE/"},{"name":"çº¿ç¨‹","slug":"çº¿ç¨‹","link":"/tags/%E7%BA%BF%E7%A8%8B/"},{"name":"Linux","slug":"Linux","link":"/tags/Linux/"},{"name":"TCP","slug":"TCP","link":"/tags/TCP/"},{"name":"Linuxç½‘ç»œ","slug":"Linuxç½‘ç»œ","link":"/tags/Linux%E7%BD%91%E7%BB%9C/"},{"name":"Spring","slug":"Spring","link":"/tags/Spring/"},{"name":"æ¯”èµ›","slug":"æ¯”èµ›","link":"/tags/%E6%AF%94%E8%B5%9B/"},{"name":"å¤ç›˜","slug":"å¤ç›˜","link":"/tags/%E5%A4%8D%E7%9B%98/"},{"name":"å¤©æ± ","slug":"å¤©æ± ","link":"/tags/%E5%A4%A9%E6%B1%A0/"},{"name":"åˆ·é¢˜","slug":"åˆ·é¢˜","link":"/tags/%E5%88%B7%E9%A2%98/"},{"name":"ç®—æ³•","slug":"ç®—æ³•","link":"/tags/%E7%AE%97%E6%B3%95/"},{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","link":"/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"},{"name":"ä¸€è‡´æ€§åè®®","slug":"ä¸€è‡´æ€§åè®®","link":"/tags/%E4%B8%80%E8%87%B4%E6%80%A7%E5%8D%8F%E8%AE%AE/"},{"name":"å®ç°","slug":"å®ç°","link":"/tags/%E5%AE%9E%E7%8E%B0/"}],"categories":[{"name":"Code","slug":"Code","link":"/categories/Code/"},{"name":"Java","slug":"Code/Java","link":"/categories/Code/Java/"},{"name":"Linux","slug":"Code/Linux","link":"/categories/Code/Linux/"},{"name":"å…¶ä»–","slug":"Code/å…¶ä»–","link":"/categories/Code/%E5%85%B6%E4%BB%96/"},{"name":"Spring","slug":"Code/Spring","link":"/categories/Code/Spring/"},{"name":"å¤ç›˜","slug":"Code/å¤ç›˜","link":"/categories/Code/%E5%A4%8D%E7%9B%98/"},{"name":"Thread","slug":"Code/Java/Thread","link":"/categories/Code/Java/Thread/"},{"name":"åˆ·é¢˜","slug":"Code/åˆ·é¢˜","link":"/categories/Code/%E5%88%B7%E9%A2%98/"},{"name":"Collection","slug":"Code/Java/Collection","link":"/categories/Code/Java/Collection/"},{"name":"åˆ†å¸ƒå¼","slug":"Code/åˆ†å¸ƒå¼","link":"/categories/Code/%E5%88%86%E5%B8%83%E5%BC%8F/"},{"name":"ç½‘ç»œ","slug":"Code/Linux/ç½‘ç»œ","link":"/categories/Code/Linux/%E7%BD%91%E7%BB%9C/"},{"name":"æ¯”èµ›","slug":"Code/å¤ç›˜/æ¯”èµ›","link":"/categories/Code/%E5%A4%8D%E7%9B%98/%E6%AF%94%E8%B5%9B/"},{"name":"åè®®","slug":"Code/åˆ†å¸ƒå¼/åè®®","link":"/categories/Code/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%8D%8F%E8%AE%AE/"},{"name":"å®ç°","slug":"Code/å®ç°","link":"/categories/Code/%E5%AE%9E%E7%8E%B0/"},{"name":"ç®—æ³•","slug":"Code/å®ç°/ç®—æ³•","link":"/categories/Code/%E5%AE%9E%E7%8E%B0/%E7%AE%97%E6%B3%95/"}]}