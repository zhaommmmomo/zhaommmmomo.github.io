<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>é€šè¿‡Javaå®ç°Raftç®—æ³• - zmm&#039;s blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="zhaommmmomo"><meta name="msapplication-TileImage" content="/img/logo.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="zhaommmmomo"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="å‰è¨€7æœˆä»½çš„æ—¶å€™å‚åŠ äº†ä¸€ä¸ªé˜¿é‡Œå¤©æ± çš„æ€§èƒ½ä¼˜åŒ–æ¯”èµ›ï¼Œåé¢åœ¨å¤èµ›çš„æ—¶å€™å› ä¸ºæ˜¯é›†ç¾¤åœºæ™¯ï¼Œéœ€è¦è€ƒè™‘å„ä¸ªèŠ‚ç‚¹ä¹‹é—´æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæœ¬æ¥æƒ³è‡ªå·±å®ç°çš„ï¼Œä½†å¥ˆä½•æ—¶é—´å¤ªçŸ­ï¼ˆps: å¤ªèœäº†ğŸ˜­ï¼‰ï¼Œæœ€ç»ˆè¿˜æ˜¯æ‰¾äº†å¸‚é¢ä¸Šæˆç†Ÿçš„ä¸­é—´ä»¶æ¥å®ç°ï¼ˆIgniteï¼‰ã€‚è¿™ä¸ï¼Œè¿˜æ˜¯æ‰‹ç—’ï¼Œè‡ªå·±å®ç°ä¸€ä¸ªåŸºäºRaftçš„ä¸€è‡´æ€§æœåŠ¡ã€‚ Githubï¼šzraft ä¸ªäººåšå®¢ï¼šzhaommmmomo"><meta property="og:type" content="blog"><meta property="og:title" content="é€šè¿‡Javaå®ç°Raftç®—æ³•"><meta property="og:url" content="http://zhaommmmomo.cn/2021/11/03/%E9%80%9A%E8%BF%87Java%E5%AE%9E%E7%8E%B0Raft%E7%AE%97%E6%B3%95/"><meta property="og:site_name" content="zmm&#039;s blog"><meta property="og:description" content="å‰è¨€7æœˆä»½çš„æ—¶å€™å‚åŠ äº†ä¸€ä¸ªé˜¿é‡Œå¤©æ± çš„æ€§èƒ½ä¼˜åŒ–æ¯”èµ›ï¼Œåé¢åœ¨å¤èµ›çš„æ—¶å€™å› ä¸ºæ˜¯é›†ç¾¤åœºæ™¯ï¼Œéœ€è¦è€ƒè™‘å„ä¸ªèŠ‚ç‚¹ä¹‹é—´æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæœ¬æ¥æƒ³è‡ªå·±å®ç°çš„ï¼Œä½†å¥ˆä½•æ—¶é—´å¤ªçŸ­ï¼ˆps: å¤ªèœäº†ğŸ˜­ï¼‰ï¼Œæœ€ç»ˆè¿˜æ˜¯æ‰¾äº†å¸‚é¢ä¸Šæˆç†Ÿçš„ä¸­é—´ä»¶æ¥å®ç°ï¼ˆIgniteï¼‰ã€‚è¿™ä¸ï¼Œè¿˜æ˜¯æ‰‹ç—’ï¼Œè‡ªå·±å®ç°ä¸€ä¸ªåŸºäºRaftçš„ä¸€è‡´æ€§æœåŠ¡ã€‚ Githubï¼šzraft ä¸ªäººåšå®¢ï¼šzhaommmmomo"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://img-blog.csdnimg.cn/83bcda9283f1406da02a959fd41513b8.png#pic_center"><meta property="og:image" content="https://img-blog.csdnimg.cn/2cf5f095532b468eaac9745277b3a2b1.png#pic_center"><meta property="og:image" content="https://img-blog.csdnimg.cn/26d66796538449c79def94b178f38008.png#pic_center"><meta property="og:image" content="https://img-blog.csdnimg.cn/1c3ecc44b48e4c98ba95afb371da216d.png#pic_center"><meta property="og:image" content="https://img-blog.csdnimg.cn/1b78a00d87e44195a208197bd16d63ce.png#pic_center"><meta property="og:image" content="https://img-blog.csdnimg.cn/bc6bc9a94adc44e9b7ededac6c8d4b43.png#pic_center"><meta property="article:published_time" content="2021-11-03T02:24:23.000Z"><meta property="article:modified_time" content="2021-11-25T14:03:47.147Z"><meta property="article:author" content="zhaommmmomo"><meta property="article:tag" content="Java"><meta property="article:tag" content="ç®—æ³•"><meta property="article:tag" content="åˆ†å¸ƒå¼"><meta property="article:tag" content="ä¸€è‡´æ€§åè®®"><meta property="article:tag" content="å®ç°"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://img-blog.csdnimg.cn/83bcda9283f1406da02a959fd41513b8.png#pic_center"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://zhaommmmomo.cn/2021/11/03/%E9%80%9A%E8%BF%87Java%E5%AE%9E%E7%8E%B0Raft%E7%AE%97%E6%B3%95/"},"headline":"é€šè¿‡Javaå®ç°Raftç®—æ³•","image":[],"datePublished":"2021-11-03T02:24:23.000Z","dateModified":"2021-11-25T14:03:47.147Z","author":{"@type":"Person","name":"zhaommmmomo"},"publisher":{"@type":"Organization","name":"zmm's blog","logo":{"@type":"ImageObject","url":"http://zhaommmmomo.cn/img/logo.jpg"}},"description":"å‰è¨€7æœˆä»½çš„æ—¶å€™å‚åŠ äº†ä¸€ä¸ªé˜¿é‡Œå¤©æ± çš„æ€§èƒ½ä¼˜åŒ–æ¯”èµ›ï¼Œåé¢åœ¨å¤èµ›çš„æ—¶å€™å› ä¸ºæ˜¯é›†ç¾¤åœºæ™¯ï¼Œéœ€è¦è€ƒè™‘å„ä¸ªèŠ‚ç‚¹ä¹‹é—´æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæœ¬æ¥æƒ³è‡ªå·±å®ç°çš„ï¼Œä½†å¥ˆä½•æ—¶é—´å¤ªçŸ­ï¼ˆps: å¤ªèœäº†ğŸ˜­ï¼‰ï¼Œæœ€ç»ˆè¿˜æ˜¯æ‰¾äº†å¸‚é¢ä¸Šæˆç†Ÿçš„ä¸­é—´ä»¶æ¥å®ç°ï¼ˆIgniteï¼‰ã€‚è¿™ä¸ï¼Œè¿˜æ˜¯æ‰‹ç—’ï¼Œè‡ªå·±å®ç°ä¸€ä¸ªåŸºäºRaftçš„ä¸€è‡´æ€§æœåŠ¡ã€‚ Githubï¼šzraft ä¸ªäººåšå®¢ï¼šzhaommmmomo"}</script><link rel="canonical" href="http://zhaommmmomo.cn/2021/11/03/%E9%80%9A%E8%BF%87Java%E5%AE%9E%E7%8E%B0Raft%E7%AE%97%E6%B3%95/"><link rel="alternate" href="/atom.xml" title="zmm&#039;s blog" type="application/atom+xml"><link rel="icon" href="/img/logo.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/androidstudio.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.jpg" alt="zmm&#039;s blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">é¦–é¡µ</a><a class="navbar-item" href="/archives">æ–‡ç« </a><a class="navbar-item" href="/categories">åˆ†ç±»</a><a class="navbar-item" href="/tags">æ ‡ç­¾</a><a class="navbar-item" href="/books">ä¹¦æ¶</a><a class="navbar-item" href="/paper">è®ºæ–‡</a><a class="navbar-item" href="/resume">ä¸ªäººç®€å†</a><a class="navbar-item" href="/about">å…³äºæˆ‘</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://www.github.com/zhaommmmomo"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="ç›®å½•" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="æœç´¢" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-11-03T02:24:23.000Z" title="11/3/2021, 10:24:23 AM">2021-11-03</time>å‘è¡¨</span><span class="level-item"> zhaommmmomo </span><span class="level-item"><a class="link-muted" href="/categories/Code/">Code</a><span>Â /Â </span><a class="link-muted" href="/categories/Code/%E5%88%86%E5%B8%83%E5%BC%8F/">åˆ†å¸ƒå¼</a><span>Â /Â </span><a class="link-muted" href="/categories/Code/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%8D%8F%E8%AE%AE/">åè®®</a><span>Â /Â </span><a class="link-muted" href="/categories/Code/%E5%AE%9E%E7%8E%B0/">å®ç°</a><span>Â /Â </span><a class="link-muted" href="/categories/Code/%E5%AE%9E%E7%8E%B0/%E7%AE%97%E6%B3%95/">ç®—æ³•</a></span><span class="level-item">26 åˆ†é’Ÿè¯»å®Œ (å¤§çº¦3929ä¸ªå­—)</span></div></div><h1 class="title is-3 is-size-4-mobile">é€šè¿‡Javaå®ç°Raftç®—æ³•</h1><div class="content"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>7æœˆä»½çš„æ—¶å€™å‚åŠ äº†ä¸€ä¸ªé˜¿é‡Œå¤©æ± çš„æ€§èƒ½ä¼˜åŒ–æ¯”èµ›ï¼Œåé¢åœ¨å¤èµ›çš„æ—¶å€™å› ä¸ºæ˜¯é›†ç¾¤åœºæ™¯ï¼Œéœ€è¦è€ƒè™‘å„ä¸ªèŠ‚ç‚¹ä¹‹é—´æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæœ¬æ¥æƒ³è‡ªå·±å®ç°çš„ï¼Œä½†å¥ˆä½•æ—¶é—´å¤ªçŸ­ï¼ˆps: å¤ªèœäº†ğŸ˜­ï¼‰ï¼Œæœ€ç»ˆè¿˜æ˜¯æ‰¾äº†å¸‚é¢ä¸Šæˆç†Ÿçš„ä¸­é—´ä»¶æ¥å®ç°ï¼ˆIgniteï¼‰ã€‚è¿™ä¸ï¼Œè¿˜æ˜¯æ‰‹ç—’ï¼Œè‡ªå·±å®ç°ä¸€ä¸ªåŸºäºRaftçš„ä¸€è‡´æ€§æœåŠ¡ã€‚</p>
<p>Githubï¼š<a target="_blank" rel="noopener" href="https://github.com/zhaommmmomo/zraft">zraft</a></p>
<p>ä¸ªäººåšå®¢ï¼š<a href="http://zhaommmmomo.cn/">zhaommmmomo</a></p>
<span id="more"></span>

<br>

<br>

<h2 id="Raft"><a href="#Raft" class="headerlink" title="Raft"></a>Raft</h2><h3 id="æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æ˜¯ä»€ä¹ˆï¼Ÿ"></a>æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p><strong>Raftæ˜¯ä¸€ä¸ªä¸ºäº†ç®¡ç†å¤åˆ¶æ—¥å¿—çš„ä¸€è‡´æ€§ç®—æ³•</strong>ã€‚å®ƒæä¾›å’ŒPaxosç®—æ³•ç›¸åŒçš„åŠŸèƒ½å’Œæ€§èƒ½ï¼Œä½†æ˜¯å®ƒçš„ç®—æ³•ç»“æ„ä¸Paxosä¸åŒå¹¶ä¸”æ›´åŠ æ˜“äºç†è§£</p>
<p>Raft é€šè¿‡é€‰ä¸¾ä¸€ä¸ªLeaderï¼Œç„¶åç»™äºˆä»–å…¨éƒ¨çš„ç®¡ç†å¤åˆ¶æ—¥å¿—çš„è´£ä»»æ¥å®ç°ä¸€è‡´æ€§ã€‚é¢†å¯¼äººä»å®¢æˆ·ç«¯æ¥æ”¶æ—¥å¿—æ¡ç›®ï¼ˆlog entriesï¼‰ï¼ŒæŠŠæ—¥å¿—æ¡ç›®å¤åˆ¶åˆ°å…¶ä»–æœåŠ¡å™¨ä¸Šï¼Œå¹¶å‘Šè¯‰å…¶ä»–çš„æœåŠ¡å™¨ä»€ä¹ˆæ—¶å€™å¯ä»¥å®‰å…¨åœ°å°†æ—¥å¿—æ¡ç›®åº”ç”¨åˆ°ä»–ä»¬çš„çŠ¶æ€æœºä¸­ã€‚<strong>æ•°æ®çš„æµå‘åªèƒ½æ˜¯Leader -&gt; otherNode</strong>ã€‚</p>
<br>

<h3 id="çŠ¶æ€æœº"><a href="#çŠ¶æ€æœº" class="headerlink" title="çŠ¶æ€æœº"></a>çŠ¶æ€æœº</h3><p><img src="https://img-blog.csdnimg.cn/83bcda9283f1406da02a959fd41513b8.png#pic_center"></p>
<p>å¤åˆ¶çŠ¶æ€æœºé€šå¸¸éƒ½æ˜¯åŸºäºå¤åˆ¶æ—¥å¿—å®ç°çš„ï¼Œå¦‚å›¾ 1ã€‚æ¯ä¸€ä¸ªæœåŠ¡å™¨å­˜å‚¨ä¸€ä¸ªåŒ…å«ä¸€ç³»åˆ—æŒ‡ä»¤çš„æ—¥å¿—ï¼Œå¹¶ä¸”æŒ‰ç…§æ—¥å¿—çš„é¡ºåºè¿›è¡Œæ‰§è¡Œã€‚æ¯ä¸€ä¸ªæ—¥å¿—éƒ½æŒ‰ç…§ç›¸åŒçš„é¡ºåºåŒ…å«ç›¸åŒçš„æŒ‡ä»¤ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªæœåŠ¡å™¨éƒ½æ‰§è¡Œç›¸åŒçš„æŒ‡ä»¤åºåˆ—ã€‚å› ä¸ºæ¯ä¸ªçŠ¶æ€æœºéƒ½æ˜¯ç¡®å®šçš„ï¼Œæ¯ä¸€æ¬¡æ‰§è¡Œæ“ä½œéƒ½äº§ç”Ÿç›¸åŒçš„çŠ¶æ€å’ŒåŒæ ·çš„åºåˆ—ã€‚</p>
<p>ä¸€è‡´æ€§ç®—æ³•çš„ä»»åŠ¡æ˜¯ä¿è¯å¤åˆ¶æ—¥å¿—çš„ä¸€è‡´æ€§ã€‚æœåŠ¡å™¨ä¸Šçš„ä¸€è‡´æ€§æ¨¡å—æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æŒ‡ä»¤ç„¶åæ·»åŠ åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­ã€‚å®ƒå’Œå…¶ä»–æœåŠ¡å™¨ä¸Šçš„ä¸€è‡´æ€§æ¨¡å—è¿›è¡Œé€šä¿¡æ¥ä¿è¯æ¯ä¸€ä¸ªæœåŠ¡å™¨ä¸Šçš„æ—¥å¿—æœ€ç»ˆéƒ½ä»¥ç›¸åŒçš„é¡ºåºåŒ…å«ç›¸åŒçš„è¯·æ±‚ï¼Œå³ä½¿æœ‰äº›æœåŠ¡å™¨å‘ç”Ÿæ•…éšœã€‚ä¸€æ—¦æŒ‡ä»¤è¢«æ­£ç¡®çš„å¤åˆ¶ï¼Œæ¯ä¸€ä¸ªæœåŠ¡å™¨çš„çŠ¶æ€æœºæŒ‰ç…§æ—¥å¿—é¡ºåºå¤„ç†ä»–ä»¬ï¼Œç„¶åè¾“å‡ºç»“æœè¢«è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å› æ­¤ï¼ŒæœåŠ¡å™¨é›†ç¾¤çœ‹èµ·æ¥å½¢æˆäº†ä¸€ä¸ªé«˜å¯é çš„çŠ¶æ€æœºã€‚</p>
<p>å®é™…ç³»ç»Ÿä¸­ä½¿ç”¨çš„ä¸€è‡´æ€§ç®—æ³•é€šå¸¸å«æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li>å®‰å…¨æ€§ä¿è¯ï¼ˆç»å¯¹ä¸ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯çš„ç»“æœï¼‰ï¼šåœ¨éæ‹œå åº­é”™è¯¯æƒ…å†µä¸‹ï¼ŒåŒ…æ‹¬ç½‘ç»œå»¶è¿Ÿã€åˆ†åŒºã€ä¸¢åŒ…ã€é‡å¤å’Œä¹±åºç­‰é”™è¯¯éƒ½å¯ä»¥ä¿è¯æ­£ç¡®ã€‚</li>
<li>å¯ç”¨æ€§ï¼šé›†ç¾¤ä¸­åªè¦æœ‰å¤§å¤šæ•°çš„æœºå™¨å¯è¿è¡Œå¹¶ä¸”èƒ½å¤Ÿç›¸äº’é€šä¿¡ã€å’Œå®¢æˆ·ç«¯é€šä¿¡ï¼Œå°±å¯ä»¥ä¿è¯å¯ç”¨ã€‚å› æ­¤ï¼Œä¸€ä¸ªå…¸å‹çš„åŒ…å« 5 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤å¯ä»¥å®¹å¿ä¸¤ä¸ªèŠ‚ç‚¹çš„å¤±è´¥ã€‚æœåŠ¡å™¨è¢«åœæ­¢å°±è®¤ä¸ºæ˜¯å¤±è´¥ã€‚å®ƒä»¬ç¨åå¯èƒ½ä¼šä»å¯é å­˜å‚¨çš„çŠ¶æ€ä¸­æ¢å¤å¹¶é‡æ–°åŠ å…¥é›†ç¾¤ã€‚</li>
<li>ä¸ä¾èµ–æ—¶åºæ¥ä¿è¯ä¸€è‡´æ€§ï¼šç‰©ç†æ—¶é’Ÿé”™è¯¯æˆ–è€…æç«¯çš„æ¶ˆæ¯å»¶è¿Ÿåªæœ‰åœ¨æœ€åæƒ…å†µä¸‹æ‰ä¼šå¯¼è‡´å¯ç”¨æ€§é—®é¢˜ã€‚</li>
<li>é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€æ¡æŒ‡ä»¤å¯ä»¥å°½å¯èƒ½å¿«çš„åœ¨é›†ç¾¤ä¸­å¤§å¤šæ•°èŠ‚ç‚¹å“åº”ä¸€è½®è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æ—¶å®Œæˆã€‚å°éƒ¨åˆ†æ¯”è¾ƒæ…¢çš„èŠ‚ç‚¹ä¸ä¼šå½±å“ç³»ç»Ÿæ•´ä½“çš„æ€§èƒ½ã€‚</li>
</ul>
<br>

<h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><h4 id="èŠ‚ç‚¹çŠ¶æ€"><a href="#èŠ‚ç‚¹çŠ¶æ€" class="headerlink" title="èŠ‚ç‚¹çŠ¶æ€"></a>èŠ‚ç‚¹çŠ¶æ€</h4><p><img src="https://img-blog.csdnimg.cn/2cf5f095532b468eaac9745277b3a2b1.png#pic_center"></p>
<ul>
<li><strong>Leader</strong>ï¼šè´Ÿè´£å¤„ç†æ‰€æœ‰Clientè¯·æ±‚ï¼Œå¹¶å°†entriesé€šè¿‡AppendEntries()RPCæ–¹æ³•æ·»åŠ åˆ°å…¶ä»–èŠ‚ç‚¹å»ã€‚</li>
<li><strong>Candidate</strong>ï¼šå¯ä»¥å˜ä¸ºLeaderçš„èŠ‚ç‚¹ã€‚å½“æŸä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°å¿ƒè·³æˆ–è€…æ”¶åˆ°çš„å¤§å¤šæ•°ç¥¨æ•°æ—¶ï¼Œå°±ä¼šå˜ä¸ºLeaderï¼Œç»™å…¶ä»–èŠ‚ç‚¹å‘é€å¿ƒè·³ã€‚å¦åˆ™å˜ä¸ºFollower</li>
<li><strong>Follower</strong>ï¼šåªå“åº”æ¥è‡ªå…¶ä»–æœåŠ¡å™¨çš„è¯·æ±‚ã€‚é›†ç¾¤åˆšå¯åŠ¨æ—¶ï¼Œæ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€éƒ½æ˜¯Followerï¼Œå½“æŸä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°å…¶ä»–èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œå°±ä¼šå˜ä¸ºCandidateå¹¶å‘å…¶ä»–èŠ‚ç‚¹è¯·æ±‚æŠ•ç¥¨ã€‚</li>
</ul>
<br>

<h4 id="ä»»æœŸï¼ˆtermï¼‰"><a href="#ä»»æœŸï¼ˆtermï¼‰" class="headerlink" title="ä»»æœŸï¼ˆtermï¼‰"></a>ä»»æœŸï¼ˆtermï¼‰</h4><p><img src="https://img-blog.csdnimg.cn/26d66796538449c79def94b178f38008.png#pic_center"></p>
<p>Raftå°†<strong>ä»»æœŸï¼ˆtermï¼‰</strong>ä½œä¸ºé€»è¾‘æ—¶é—´ã€‚ä»»æœŸè‡ªå¢çš„æ•´æ•°è¡¨ç¤ºï¼ˆåˆå§‹ä¸º0ï¼‰ã€‚æ¯ä¸€æ®µä»»æœŸä»ä¸€æ¬¡<strong>é€‰ä¸¾</strong>å¼€å§‹ï¼Œå¦‚æœä¸€ä¸ªå€™é€‰äººèµ¢å¾—é€‰ä¸¾ï¼Œç„¶åä»–å°±åœ¨æ¥ä¸‹æ¥çš„ä»»æœŸå†…å……å½“é¢†å¯¼äººçš„èŒè´£ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸€æ¬¡é€‰ä¸¾è¿‡ç¨‹ä¼šé€ æˆé€‰ç¥¨çš„ç“œåˆ†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<strong>è¿™ä¸€ä»»æœŸä¼šä»¥æ²¡æœ‰é¢†å¯¼äººç»“æŸ</strong>ï¼›ä¸€ä¸ªæ–°çš„ä»»æœŸï¼ˆå’Œä¸€æ¬¡æ–°çš„é€‰ä¸¾ï¼‰ä¼šå¾ˆå¿«é‡æ–°å¼€å§‹ã€‚Raft ä¿è¯äº†åœ¨ä¸€ä¸ªç»™å®šçš„ä»»æœŸå†…ï¼Œæœ€å¤šåªæœ‰ä¸€ä¸ªé¢†å¯¼äººã€‚</p>
<br>

<h4 id="é€‰ä¸¾æ–¹æ³•ï¼ˆRequestVote-ï¼‰"><a href="#é€‰ä¸¾æ–¹æ³•ï¼ˆRequestVote-ï¼‰" class="headerlink" title="é€‰ä¸¾æ–¹æ³•ï¼ˆRequestVote()ï¼‰"></a>é€‰ä¸¾æ–¹æ³•ï¼ˆRequestVote()ï¼‰</h4><ul>
<li>å¦‚æœterm &lt; currentTermè¿”å› false</li>
<li>å¦‚æœ votedFor ä¸ºç©ºæˆ–è€…ä¸º candidateIdï¼Œå¹¶ä¸”å€™é€‰äººçš„æ—¥å¿—è‡³å°‘å’Œè‡ªå·±ä¸€æ ·æ–°ï¼Œé‚£ä¹ˆå°±æŠ•ç¥¨ç»™ä»–</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> VoteResponse <span class="title">requestVote</span><span class="params">(VoteRequest voteRequest)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœterm &lt; currentTermè¿”å› false</span></span><br><span class="line">    <span class="comment">// å¦‚æœ votedFor ä¸ºç©ºæˆ–è€…ä¸º candidateIdï¼Œå¹¶ä¸”å€™é€‰äººçš„æ—¥å¿—è‡³å°‘å’Œè‡ªå·±ä¸€æ ·æ–°ï¼Œé‚£ä¹ˆå°±æŠ•ç¥¨ç»™ä»–</span></span><br><span class="line">&#125;</span><br><span class="line">Class VoteRequest &#123;</span><br><span class="line">    <span class="comment">/** å€™é€‰äººçš„ä»»æœŸå· */</span></span><br><span class="line">    <span class="keyword">long</span> term;</span><br><span class="line">    <span class="comment">/** å€™é€‰äººId */</span></span><br><span class="line">    <span class="keyword">long</span> candidateId;</span><br><span class="line">    <span class="comment">/** å€™é€‰äººçš„æœ€åæ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼ */</span></span><br><span class="line">    <span class="keyword">long</span> lastLogIndex;</span><br><span class="line">    <span class="comment">/** å€™é€‰äººæœ€åæ—¥å¿—æ¡ç›®çš„ä»»æœŸå· */</span></span><br><span class="line">	<span class="keyword">long</span> lastLogTerm</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VoteResponse</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** å½“å‰èŠ‚ç‚¹çš„ä»»æœŸå· */</span></span><br><span class="line">    <span class="keyword">long</span> term;</span><br><span class="line">    <span class="comment">/** æ˜¯å¦æŠ•ç¥¨ */</span></span><br><span class="line">    <span class="keyword">boolean</span> voteGranted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é›†ç¾¤åˆšå¯åŠ¨çš„æ—¶å€™ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯FollowerçŠ¶æ€ã€‚å¦‚æœFolloweråœ¨é€‰ä¸¾è¶…æ—¶å†…æ¯æ”¶åˆ°å¿ƒè·³æˆ–è€…æŠ•ç¥¨è¯·æ±‚ï¼Œå®ƒå°±ä¼šè¿›è¡Œé€‰ä¸¾æŠ•ç¥¨ï¼Œå…ˆå¢åŠ è‡ªå·±çš„ä»»æœŸå·å¹¶è½¬æ¢ä¸ºCandidateï¼Œç„¶åå‘å…¶ä»–èŠ‚ç‚¹å‘é€RPCæŠ•ç¥¨è¯·æ±‚ã€‚</p>
<ol>
<li>è·å¾—äº†å¤§å¤šæ•°çš„é€‰ç¥¨ã€‚ä¿®æ”¹çŠ¶æ€ä¸ºLeaderï¼Œä¿®æ”¹ç»´æŠ¤çš„<code>nextIndex[]</code>æ•°ç»„ä¸ºå½“å‰æ—¥å¿—æ¡ç›®çš„ç´¢å¼•ï¼Œå…³é—­ç­‰å¾…è¶…æ—¶è®¡æ—¶å™¨ï¼Œå¼€å¯å¿ƒè·³è®¡æ—¶å™¨å¹¶å‘é€å¿ƒè·³åŒ…ã€‚</li>
<li>å…¶ä»–èŠ‚ç‚¹æˆä¸ºLeaderã€‚å¦‚æœLeaderçš„ä»»æœŸå·ä¸å°äºå½“å‰ä»»æœŸå·ï¼Œä¿®æ”¹çŠ¶æ€ä¸ºFollowerã€‚</li>
<li>å‡ºç°åŒç¥¨æƒ…å†µã€‚<strong>éšæœºç”Ÿæˆè¶…æ—¶æ—¶é—´</strong>åé‡æ–°å¼€å§‹æ–°ä¸€è½®çš„é€‰ä¸¾ã€‚</li>
</ol>
<br>

<h4 id="è¿½åŠ æ¡ç›®ï¼ˆAppendEntries-ï¼‰"><a href="#è¿½åŠ æ¡ç›®ï¼ˆAppendEntries-ï¼‰" class="headerlink" title="è¿½åŠ æ¡ç›®ï¼ˆAppendEntries()ï¼‰"></a>è¿½åŠ æ¡ç›®ï¼ˆAppendEntries()ï¼‰</h4><p>åªèƒ½ç”±Leader -&gt; å…¶ä»–èŠ‚ç‚¹ï¼Œä¸èƒ½åˆ°Leaderï¼Œæ˜¯å•å‘çš„ã€‚</p>
<p>Clientå‘é€RPCè¯·æ±‚ï¼ŒLeaderé¦–å…ˆä¼šå°†æ—¥å¿—è¿½åŠ åˆ°æœ¬åœ°ï¼Œè¿½åŠ å¤±è´¥åˆ™è¿”å›falseã€‚ç„¶åé€šè¿‡AppendEntries()æ–¹æ³•åŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šå»ï¼Œå½“Leaderæ”¶åˆ°å¤§å¤šæ•°èŠ‚ç‚¹å“åº”trueæ—¶ï¼Œä¼šå°†è¯¥æ—¥å¿—æ¡ç›®Commitï¼Œç„¶åå°†ç»“æœè¿”å›ç»™Clientï¼Œç„¶åé€šçŸ¥å…¶ä»–èŠ‚ç‚¹Commitã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/1c3ecc44b48e4c98ba95afb371da216d.png#pic_center"></p>
<p>å½“è¿½åŠ çš„æ¡ç›®ä¸ºç©ºæ—¶ï¼Œä»£è¡¨è¿™æ˜¯ä¸ªå¿ƒè·³åŒ…</p>
<ul>
<li>å¦‚æœå½“å‰ä»»æœŸå¤§äºè¯·æ±‚ä»»æœŸï¼Œè¿”å›false</li>
<li>å¦‚æœå½“å‰æ—¥å¿—æ¡ç›®æ²¡æœ‰èƒ½å¤Ÿä¸preLogIndexå’ŒpreLogTermåŒ¹é…çš„ï¼Œè¿”å›false</li>
<li>é‡ç½®ç­‰å¾…è®¡æ—¶å™¨ç­‰å¾…æ—¶é—´</li>
<li>å¦‚æœå‘ç”Ÿæ¡ç›®å†²çªï¼ˆç´¢å¼•ç›¸åŒï¼Œä»»æœŸä¸åŒï¼‰ï¼Œåˆ é™¤å†²çªç´¢å¼•ä»¥åçš„æ‰€æœ‰æ—¥å¿—</li>
<li>è¿½åŠ æ—¥å¿—æ¡ç›®</li>
<li>å¦‚æœLeaderçš„commitIndexå¤§äºæœ¬åœ°çš„ï¼Œå°†æœ¬åœ°çš„è®¾ç½®ä¸ºmin(commitIndex. logIndex) </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AppendResponse <span class="title">appendEntries</span><span class="params">(AppendRequest appendRequest)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰ä»»æœŸå¤§äºè¯·æ±‚ä»»æœŸï¼Œè¿”å›false</span></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰æ—¥å¿—æ¡ç›®æ²¡æœ‰èƒ½å¤Ÿä¸preLogIndexå’ŒpreLogTermåŒ¹é…çš„ï¼Œè¿”å›false</span></span><br><span class="line">    <span class="comment">// é‡ç½®ç­‰å¾…è®¡æ—¶å™¨ç­‰å¾…æ—¶é—´</span></span><br><span class="line">    <span class="comment">// å¦‚æœå‘ç”Ÿæ¡ç›®å†²çªï¼ˆç´¢å¼•ç›¸åŒï¼Œä»»æœŸä¸åŒï¼‰ï¼Œåˆ é™¤å†²çªç´¢å¼•ä»¥åçš„æ‰€æœ‰æ—¥å¿—</span></span><br><span class="line">	<span class="comment">// è¿½åŠ æ—¥å¿—æ¡ç›®</span></span><br><span class="line">    <span class="comment">// å¦‚æœLeaderçš„commitIndexå¤§äºæœ¬åœ°çš„ï¼Œå°†æœ¬åœ°çš„è®¾ç½®ä¸ºmin(commitIndex. logIndex)</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppendRequest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** Leaderçš„ä»»æœŸå· */</span></span><br><span class="line">    <span class="keyword">long</span> term;</span><br><span class="line">    <span class="comment">/** LeaderId */</span></span><br><span class="line">    <span class="keyword">long</span> leaderId;</span><br><span class="line">    <span class="comment">/** æ–°æ—¥å¿—çš„å‰ä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ç´¢å¼• */</span></span><br><span class="line">    <span class="keyword">long</span> preLogIndex;</span><br><span class="line">    <span class="comment">/** æ–°æ—¥å¿—çš„å‰ä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ä»»æœŸå· */</span></span><br><span class="line">	<span class="keyword">long</span> preLogTerm;</span><br><span class="line">    <span class="comment">/** éœ€è¦æ·»åŠ çš„æ¡ç›®ä¿¡æ¯ */</span></span><br><span class="line">    List&lt;Entry&gt; entries;</span><br><span class="line">    <span class="comment">/** Leaderçš„æäº¤ç´¢å¼• */</span></span><br><span class="line">	<span class="keyword">long</span> leaderCommit;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Entry</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> term;</span><br><span class="line">    <span class="comment">/** å‘½ä»¤ */</span></span><br><span class="line">    String command;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppendResponse</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** å½“å‰èŠ‚ç‚¹çš„ä»»æœŸå· */</span></span><br><span class="line">    <span class="keyword">long</span> term;</span><br><span class="line">    <span class="comment">/** Followerçš„æ¡ç›®æ˜¯å¦ä¸Leaderçš„åŒ¹é…ä¸Šäº† */</span></span><br><span class="line">    <span class="keyword">boolean</span> success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Leaderå¯¹äºæ¯ä¸ªFolloweréƒ½ç»´æŠ¤ ä¸€ä¸ª<code>nextIndex</code>ï¼Œè®°å½•éœ€è¦ç»™è¯¥Followerå‘é€çš„ä¸‹ä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ç´¢å¼•ã€‚å½“æŸä¸€ä¸ªèŠ‚ç‚¹åˆšæˆä¸ºLeaderæ—¶ï¼Œå®ƒä¼šå°†æ‰€æœ‰<code>nextIndex</code>è®¾ç½®ä¸ºè‡ªå·±çš„æœ€åä¸€ä¸ªæ—¥å¿—çš„<code>index + 1</code>ã€‚å¦‚æœä¸€ä¸ªFollowerçš„æ—¥å¿—å’ŒLeaderä¸ä¸€è‡´ï¼Œé‚£ä¹ˆåœ¨ä¸‹ä¸€æ¬¡çš„<code>AppendEntries()</code> RPC æ—¶çš„ä¸€è‡´æ€§æ£€æŸ¥å°±ä¼šå¤±è´¥ã€‚åœ¨è¢«Followeræ‹’ç»ä¹‹åï¼ŒLeaderå°±ä¼šå‡å° nextIndex å€¼å¹¶è¿›è¡Œé‡è¯•ã€‚æœ€ç»ˆ nextIndex ä¼šåœ¨æŸä¸ªä½ç½®ä½¿å¾—Leaderå’ŒFollowerçš„æ—¥å¿—è¾¾æˆä¸€è‡´ã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œé™„åŠ æ—¥å¿— RPC å°±ä¼šæˆåŠŸï¼Œè¿™æ—¶å°±ä¼šæŠŠFollowerå†²çªçš„æ—¥å¿—æ¡ç›®å…¨éƒ¨åˆ é™¤å¹¶ä¸”åŠ ä¸ŠLeaderçš„æ—¥å¿—ã€‚ä¸€æ—¦é™„åŠ æ—¥å¿— RPC æˆåŠŸï¼Œé‚£ä¹ˆFollowerçš„æ—¥å¿—å°±ä¼šå’ŒLeaderä¿æŒä¸€è‡´ï¼Œå¹¶ä¸”åœ¨æ¥ä¸‹æ¥çš„ä»»æœŸé‡Œä¸€ç›´ç»§ç»­ä¿æŒã€‚</p>
<br>

<br>

<h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="æ ¸å¿ƒç±»å›¾"><a href="#æ ¸å¿ƒç±»å›¾" class="headerlink" title="æ ¸å¿ƒç±»å›¾"></a>æ ¸å¿ƒç±»å›¾</h3><p><img src="https://img-blog.csdnimg.cn/1b78a00d87e44195a208197bd16d63ce.png#pic_center"></p>
<br>

<h3 id="æ ¸å¿ƒæ–¹æ³•"><a href="#æ ¸å¿ƒæ–¹æ³•" class="headerlink" title="æ ¸å¿ƒæ–¹æ³•"></a>æ ¸å¿ƒæ–¹æ³•</h3><h4 id="requestVote"><a href="#requestVote" class="headerlink" title="requestVote()"></a>requestVote()</h4><ul>
<li>å¦‚æœå€™é€‰äººçš„term &lt; currentTermï¼Œä¸ç»™è¯¥å€™é€‰äººæŠ•ç¥¨</li>
<li>å¦‚æœå½“å‰èŠ‚ç‚¹æ²¡æœ‰æŠ•ç¥¨æˆ–è€…æŠ•ç»™äº†å€™é€‰äººå¹¶ä¸”å€™é€‰äººæ—¥å¿—å’Œå½“å‰èŠ‚ç‚¹ä¸€æ ·æ–°ï¼Œå°±ç»™è¯¥å€™é€‰äººæŠ•ç¥¨</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/bc6bc9a94adc44e9b7ededac6c8d4b43.png#pic_center"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * èŠ‚ç‚¹é€‰ä¸¾</span></span><br><span class="line"><span class="comment"> * é€‰ä¸¾è¶…æ—¶ï¼šFollowerç­‰å¾…æˆä¸ºLeaderçš„æ—¶é—´ï¼Œéšæœºè®¾ç½®åœ¨150ms ~ 300ms</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request           &#123;</span></span><br><span class="line"><span class="comment"> *                              term:           å€™é€‰äººä»»æœŸå·</span></span><br><span class="line"><span class="comment"> *                              candidateId:    å€™é€‰äººId</span></span><br><span class="line"><span class="comment"> *                              lastLogIndex:   å€™é€‰äººæœ€å¥½çš„æ—¥å¿—æ¡ç›®ç´¢å¼•å€¼</span></span><br><span class="line"><span class="comment"> *                              lastLogTerm:    å€™é€‰äººæœ€åæ—¥å¿—æ¡ç›®çš„ä»»æœŸå·</span></span><br><span class="line"><span class="comment"> *                          &#125;</span></span><br><span class="line"><span class="comment"> * ZRaftResponse            &#123;</span></span><br><span class="line"><span class="comment"> *                              &quot;term&quot;:         å½“å‰ä»»æœŸå·</span></span><br><span class="line"><span class="comment"> *                              &quot;voteGranted&quot;:  true / false</span></span><br><span class="line"><span class="comment"> *                                              æ˜¯å¦è¢«æŠ•ç¥¨</span></span><br><span class="line"><span class="comment"> *                          &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestVote</span><span class="params">(VoteRequest request,</span></span></span><br><span class="line"><span class="params"><span class="function">                        StreamObserver&lt;ZRaftResponse&gt; responseObserver)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å½“èŠ‚ç‚¹æ”¶åˆ°æ¯”è‡ªå·±å¤§çš„ä»»æœŸï¼Œä¼šå°†è‡ªå·±çš„ä»»æœŸè®¾ç½®ä¸ºç›¸åŒçš„ï¼Œç„¶åç›´æ¥æŠ•ç¥¨</span></span><br><span class="line">    <span class="comment">// å½“èŠ‚ç‚¹æ”¶åˆ°å’Œè‡ªå·±ä¸€æ ·å¤§çš„ä»»æœŸï¼Œä¼šçœ‹è‡ªå·±æ˜¯å¦å·²ç»æŠ•ç¥¨æ¥åˆ¤æ–­</span></span><br><span class="line">    ZRaftResponse response = ZRaftResponse.newBuilder()</span><br><span class="line">                                    .setTerm(NodeManager.node.getCurrentTerm())</span><br><span class="line">                                    .setSuccess(vote(request))</span><br><span class="line">                                    .build();</span><br><span class="line"></span><br><span class="line">    responseObserver.onNext(response);</span><br><span class="line">    responseObserver.onCompleted();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦æŠ•ç¥¨ç»™å€™é€‰äºº</span></span><br><span class="line"><span class="comment"> * å¦‚æœå€™é€‰äººçš„term &lt; currentTermï¼Œä¸ç»™è¯¥å€™é€‰äººæŠ•ç¥¨</span></span><br><span class="line"><span class="comment"> * å¦‚æœå½“å‰èŠ‚ç‚¹æ²¡æœ‰æŠ•ç¥¨æˆ–è€…æŠ•ç»™äº†å€™é€‰äººå¹¶ä¸”å€™é€‰äººæ—¥å¿—å’Œå½“å‰èŠ‚ç‚¹ä¸€æ ·æ–°ï¼Œå°±ç»™è¯¥å€™é€‰äººæŠ•ç¥¨</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request           å€™é€‰äººid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>                  true / false</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">vote</span><span class="params">(VoteRequest request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> term = request.getTerm();</span><br><span class="line">    <span class="keyword">long</span> currentTerm = NodeManager.node.getCurrentTerm();</span><br><span class="line">    <span class="keyword">if</span> (term &lt; currentTerm) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœè¯·æ±‚è€…ä»»æœŸå°äºå½“å‰èŠ‚ç‚¹ä»»æœŸ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (term &gt; currentTerm) &#123;</span><br><span class="line">        <span class="comment">// æ›´æ–°ç­‰å¾…å®šæ—¶å™¨çš„æ—¶é—´</span></span><br><span class="line">        NodeManager.electionListener</span><br><span class="line">            .updatePreHeartTime(System.currentTimeMillis());</span><br><span class="line">        <span class="comment">// ä¿®æ”¹èŠ‚ç‚¹ä»»æœŸä¿¡æ¯</span></span><br><span class="line">        zRaftService.updateNodeTermInfo(request);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> votedFor = NodeManager.node.getVotedFor();</span><br><span class="line">    <span class="keyword">long</span> candidateId = request.getCandidateId();</span><br><span class="line">    <span class="keyword">if</span> (votedFor == <span class="number">0</span> ||</span><br><span class="line">        (votedFor == candidateId &amp;&amp;</span><br><span class="line">         NodeManager.node.getLogIndex() == request.getLastLogIndex() &amp;&amp;</span><br><span class="line">         NodeManager.node.getLastLogTerm() == request.getLastLogTerm())) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰èŠ‚ç‚¹æ²¡æœ‰æŠ•ç¥¨æˆ–è€…</span></span><br><span class="line">        <span class="comment">// ç»™è¯·æ±‚è€…æŠ•ç¥¨äº†å¹¶ä¸”æ—¥å¿—ç´¢å¼•ä¸ä»»æœŸèƒ½å¯¹åº”</span></span><br><span class="line">        <span class="comment">// æ›´æ–°ç­‰å¾…å®šæ—¶å™¨çš„æ—¶é—´</span></span><br><span class="line">        NodeManager.electionListener</span><br><span class="line">            .updatePreHeartTime(System.currentTimeMillis());</span><br><span class="line">        NodeManager.node.setLeaderId(<span class="number">0</span>);</span><br><span class="line">        NodeManager.node.setVotedFor(candidateId);</span><br><span class="line">        NodeManager.printNodeInfo();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>  <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h4 id="appendEntries"><a href="#appendEntries" class="headerlink" title="appendEntries()"></a>appendEntries()</h4><ol>
<li>Leaderæ¥æ”¶åˆ°æ•°æ®æ›´æ”¹ï¼Œå°†æ›´æ”¹æ·»åŠ åˆ°èŠ‚ç‚¹æ—¥å¿—ä¸­ï¼ˆä¸æäº¤ï¼‰</li>
<li>å°†è¯¥æ¡ç›®å¤åˆ¶åˆ°Followerï¼Œç­‰å¾…å›å¤ï¼Œç›´åˆ°å¤§å¤šæ•°ï¼ˆn / 2 + 1ï¼‰èŠ‚ç‚¹å“åº”æˆåŠŸã€‚å¦‚æœæ²¡æœ‰è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹å“åº”æˆåŠŸï¼Œéš”æ®µè¶…æ—¶æ—¶é—´åé‡æ–°å‘é€ã€‚</li>
<li>Leaderæäº¤æ•°æ®ï¼Œç„¶åå°†ç»“æœè¿”å›ç»™å¹¶é€šçŸ¥Followerè¿›è¡Œæäº¤</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿½åŠ æ¡ç›®ï¼Œå¿ƒè·³ï¼ŒèŠ‚ç‚¹é—´æ•°æ®çš„åŒæ­¥ï¼Œæ—¥å¿—å¤åˆ¶</span></span><br><span class="line"><span class="comment"> * 1. Leaderæ¥æ”¶åˆ°æ•°æ®æ›´æ”¹ï¼Œå°†æ›´æ”¹æ·»åŠ åˆ°èŠ‚ç‚¹æ—¥å¿—ä¸­ï¼ˆä¸æäº¤ï¼‰</span></span><br><span class="line"><span class="comment"> * 2. å°†è¯¥æ¡ç›®å¤åˆ¶åˆ°Followerï¼Œç­‰å¾…å›å¤ï¼Œç›´åˆ°å¤§å¤šæ•°ï¼ˆn / 2 + 1ï¼‰</span></span><br><span class="line"><span class="comment"> *    èŠ‚ç‚¹å“åº”æˆåŠŸã€‚å¦‚æœæ²¡æœ‰è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹å“åº”æˆåŠŸï¼Œéš”æ®µè¶…æ—¶æ—¶é—´åé‡æ–°å‘é€</span></span><br><span class="line"><span class="comment"> * 3. Leaderæäº¤æ•°æ®ï¼Œç„¶åå°†ç»“æœè¿”å›ç»™å¹¶é€šçŸ¥Followerè¿›è¡Œæäº¤</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request           &#123;</span></span><br><span class="line"><span class="comment"> *                              term:           Leaderä»»æœŸ</span></span><br><span class="line"><span class="comment"> *                              leaderId:       æœ‰æ—¶å€™å¯èƒ½æ˜¯Candidateæ”¶åˆ°è¯·æ±‚ï¼Œ</span></span><br><span class="line"><span class="comment"> *                                              éœ€è¦å°†è¯·æ±‚é‡å®šå‘åˆ°Leaderå»</span></span><br><span class="line"><span class="comment"> *                              preLogIndex:    å‰ä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ç´¢å¼•</span></span><br><span class="line"><span class="comment"> *                              preLogTerm:     å‰ä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ä»»æœŸ</span></span><br><span class="line"><span class="comment"> *                              entries:        éœ€è¦è¢«ä¿å­˜çš„æ—¥å¿—æ¡ç›®ï¼ˆå¦‚æœä¸ºç©ºï¼Œä»£è¡¨æ˜¯å¿ƒè·³ï¼‰</span></span><br><span class="line"><span class="comment"> *                              leaderCommit:   Leaderå·²æäº¤çš„æœ€é«˜æ—¥å¿—æ¡ç›®çš„ç´¢å¼•</span></span><br><span class="line"><span class="comment"> *                          &#125;</span></span><br><span class="line"><span class="comment"> * ZRaftResponse            &#123;</span></span><br><span class="line"><span class="comment"> *                              &quot;term&quot;:         å½“å‰ä»»æœŸ</span></span><br><span class="line"><span class="comment"> *                              &quot;success&quot;:      true / falseã€‚å¦‚æœCandidate</span></span><br><span class="line"><span class="comment"> *                                              æ‰€å«æœ‰çš„æ¡ç›®å’ŒprevLogIndexä»¥åŠpreLogTerm</span></span><br><span class="line"><span class="comment"> *                                              åŒ¹é…ä¸Šï¼Œåˆ™ä¸ºtrueã€‚</span></span><br><span class="line"><span class="comment"> *                          &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendEntries</span><span class="params">(AppendRequest request,</span></span></span><br><span class="line"><span class="params"><span class="function">                          StreamObserver&lt;ZRaftResponse&gt; responseObserver)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    NodeManager.printLog(<span class="string">&quot;appendEntries...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ZRaftResponse.Builder builder = ZRaftResponse.newBuilder()</span><br><span class="line">            .setTerm(NodeManager.node.getCurrentTerm());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœcurrentTerm &gt; term</span></span><br><span class="line">    <span class="keyword">long</span> term = request.getTerm();</span><br><span class="line">    <span class="keyword">long</span> currentTerm = NodeManager.node.getCurrentTerm();</span><br><span class="line">    <span class="keyword">if</span> (term &lt; currentTerm) &#123;</span><br><span class="line">        <span class="comment">// è¿”å›false</span></span><br><span class="line">        builder.setSuccess(<span class="keyword">false</span>);</span><br><span class="line">        responseObserver.onNext(builder.build());</span><br><span class="line">        responseObserver.onCompleted();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ–°ç­‰å¾…è®¡æ—¶å™¨</span></span><br><span class="line">    NodeManager.electionListener</span><br><span class="line">            .updatePreHeartTime(System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœterm &gt; currentTerm æˆ–è€…å½“å‰èŠ‚ç‚¹çŠ¶æ€æ˜¯Candidate</span></span><br><span class="line">    Node.NodeState state = NodeManager.node.getNodeState();</span><br><span class="line">    <span class="keyword">if</span> (term &gt; currentTerm || state == Node.NodeState.CANDIDATE) &#123;</span><br><span class="line">        <span class="comment">// ä¿®æ”¹ä»»æœŸçŠ¶æ€å¹¶åˆ‡æ¢ä¸ºFollower</span></span><br><span class="line">        zRaftService.levelDown(request);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®LeaderId</span></span><br><span class="line">        <span class="keyword">long</span> leaderId = NodeManager.node.getLeaderId();</span><br><span class="line">        <span class="keyword">if</span> (leaderId == <span class="number">0</span>) &#123;</span><br><span class="line">            NodeManager.node.setLeaderId(request.getLeaderId());</span><br><span class="line">            NodeManager.node.setNodeState(Node.NodeState.FOLLOWER);</span><br><span class="line">            NodeManager.printNodeInfo();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> preLogTerm = request.getPreLogTerm();</span><br><span class="line">    <span class="keyword">long</span> preLogIndex = request.getPreLogIndex();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœLeaderæ—¥å¿—ç´¢å¼•ä¸èƒ½åœ¨å½“å‰èŠ‚ç‚¹çš„ç´¢å¼•ä¸Šæ‰¾åˆ°</span></span><br><span class="line">    <span class="keyword">if</span> (!NodeManager.node.entryIsExist(preLogTerm, preLogIndex)) &#123;</span><br><span class="line">        <span class="comment">// è¿”å›false</span></span><br><span class="line">        builder.setSuccess(<span class="keyword">false</span>);</span><br><span class="line">        responseObserver.onNext(builder.build());</span><br><span class="line">        responseObserver.onCompleted();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> b = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœä¸æ˜¯å¿ƒè·³åŒ…</span></span><br><span class="line">    List&lt;Entry&gt; entries = request.getEntriesList();</span><br><span class="line">    <span class="keyword">if</span> (entries.size() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// æ·»åŠ æ—¥å¿—æ¡ç›®</span></span><br><span class="line">        b = NodeManager.node.addLogEntries(preLogIndex, entries);</span><br><span class="line">        NodeManager.printLog(NodeManager.node.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦è¦æäº¤æ¡ç›®</span></span><br><span class="line">    <span class="keyword">long</span> leaderCommit = request.getLeaderCommit();</span><br><span class="line">    <span class="keyword">long</span> commitIndex = NodeManager.node.getCommitIndex();</span><br><span class="line">    <span class="keyword">if</span> (leaderCommit &gt; commitIndex) &#123;</span><br><span class="line">        <span class="comment">// å°†æäº¤</span></span><br><span class="line">        b = NodeManager.node.commitLog(leaderCommit) &amp;&amp; b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    builder.setSuccess(b);</span><br><span class="line">    responseObserver.onNext(builder.build());</span><br><span class="line">    responseObserver.onCompleted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h4 id="sendCommand"><a href="#sendCommand" class="headerlink" title="sendCommand()"></a>sendCommand()</h4><p>å®¢æˆ·ç«¯è°ƒç”¨çš„RPCæ–¹æ³•ã€‚</p>
<p>å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯Leader:</p>
<ul>
<li>ç¬¬ä¸€é˜¶æ®µï¼Œå°†æŒ‡ä»¤ä¿å­˜åœ¨logæ¡ç›®ä¸­ï¼Œç»™å…¶ä»–èŠ‚ç‚¹å‘é€AppendEntriesï¼Œå¼‚æ­¥ç­‰å¾…æ¶ˆæ¯ã€‚</li>
<li>ç¬¬äºŒé˜¶æ®µï¼Œå½“å¤§å¤šæ•°èŠ‚ç‚¹è¿”å›trueï¼Œåœ¨æœ¬åœ°è¿›è¡Œæäº¤å¹¶å°†ç»“æœè¿”å›ç»™ç”¨æˆ·ï¼ŒåŒæ—¶å‘å…¶ä»–èŠ‚ç‚¹å‘é€æäº¤å‘½ä»¤.</li>
</ul>
<p>å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯Follower:</p>
<ul>
<li>å°†è¯¥è¯·æ±‚é‡å®šå‘åˆ°Leaderå»ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®¢æˆ·ç«¯è°ƒç”¨çš„RPCæ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment"> * å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯Leader:</span></span><br><span class="line"><span class="comment"> *    ç¬¬ä¸€é˜¶æ®µï¼Œå°†æŒ‡ä»¤ä¿å­˜åœ¨logæ¡ç›®ä¸­ï¼Œç»™å…¶ä»–èŠ‚ç‚¹å‘é€AppendEntriesï¼Œå¼‚æ­¥ç­‰å¾…æ¶ˆæ¯ã€‚</span></span><br><span class="line"><span class="comment"> *    ç¬¬äºŒé˜¶æ®µï¼Œå½“å¤§å¤šæ•°èŠ‚ç‚¹è¿”å›trueï¼Œåœ¨æœ¬åœ°è¿›è¡Œæäº¤å¹¶å°†ç»“æœè¿”å›ç»™ç”¨æˆ·ï¼ŒåŒæ—¶å‘å…¶ä»–èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> *    å‘é€æäº¤å‘½ä»¤.</span></span><br><span class="line"><span class="comment"> * å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯Follower:</span></span><br><span class="line"><span class="comment"> *    å°†è¯¥è¯·æ±‚é‡å®šå‘åˆ°Leaderå»ã€‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request           æŒ‡ä»¤é›†ï¼ˆå­—ç¬¦ä¸²listï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendCommand</span><span class="params">(Command request, StreamObserver&lt;ClientResponse&gt; responseObserver)</span> </span>&#123;</span><br><span class="line">    ProtocolStringList commandList = request.getCommandList();</span><br><span class="line">    ClientResponse.Builder builder = ClientResponse.newBuilder();</span><br><span class="line">    <span class="keyword">boolean</span> b = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span> size = commandList.size();</span><br><span class="line">    Node.NodeState state = NodeManager.node.getNodeState();</span><br><span class="line">    <span class="keyword">long</span> leaderId = NodeManager.node.getLeaderId();</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span> || state != Node.NodeState.LEADER) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœç”¨æˆ·æ²¡æœ‰å‘é€æ¡ç›®æˆ–è€…å½“å‰èŠ‚ç‚¹ä¸æ˜¯Leaderï¼Œç›´æ¥è¿”å›falseå¹¶æ·»åŠ LeaderId</span></span><br><span class="line">        responseObserver.onNext(builder.setSuccess(b).setLeaderId(leaderId).build());</span><br><span class="line">        responseObserver.onCompleted();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†è¯¥è¯·æ±‚</span></span><br><span class="line">    <span class="comment">// ç¬¬ä¸€é˜¶æ®µï¼Œä¿å­˜æŒ‡ä»¤åˆ°æœ¬åœ°å¹¶ç»™å…¶ä»–èŠ‚ç‚¹å‘é€æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">long</span> currentTerm = NodeManager.node.getCurrentTerm();</span><br><span class="line">    List&lt;Entry&gt; entries = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String command : commandList) &#123;</span><br><span class="line">        Entry entry = Entry.newBuilder()</span><br><span class="line">                           .setTerm(currentTerm)</span><br><span class="line">                           .setCommand(command)</span><br><span class="line">                           .build();</span><br><span class="line">        entries.add(entry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!NodeManager.node.addLogEntries(entries)) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæœ¬åœ°æ·»åŠ æ¡ç›®å¤±è´¥ï¼Œè¿”å›false</span></span><br><span class="line">        responseObserver.onNext(builder.setSuccess(b).setLeaderId(leaderId).build());</span><br><span class="line">        responseObserver.onCompleted();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†è¿”å›äº¤ç»™AppendFutureListener</span></span><br><span class="line">    AppendFutureListener.responseObserver = responseObserver;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘é€RPCè¯·æ±‚</span></span><br><span class="line">    zRaftService.sendAppendEntries(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<br>

<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a target="_blank" rel="noopener" href="https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md">Raftè®ºæ–‡</a></p>
<p><a target="_blank" rel="noopener" href="http://thesecretlivesofdata.com/raft">RaftåŠ¨æ€å±•ç¤º</a></p>
<p><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/schedule.html">MIT6.824</a></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>é€šè¿‡Javaå®ç°Raftç®—æ³•</p><p><a href="http://zhaommmmomo.cn/2021/11/03/é€šè¿‡Javaå®ç°Raftç®—æ³•/">http://zhaommmmomo.cn/2021/11/03/é€šè¿‡Javaå®ç°Raftç®—æ³•/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>ä½œè€…</h6><p>zhaommmmomo</p></div></div><div class="level-item is-narrow"><div><h6>å‘å¸ƒäº</h6><p>2021-11-03</p></div></div><div class="level-item is-narrow"><div><h6>æ›´æ–°äº</h6><p>2021-11-25</p></div></div><div class="level-item is-narrow"><div><h6>è®¸å¯åè®®</h6><p><a class="icons" rel="noopener" target="_blank" title="Attribution" href="http://zhaommmmomo.cn"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Download on GitHub" href="https://github.com/zhaommmmomo/blog"><i class="icon fab fa-github"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Java/">Java</a><a class="link-muted mr-2" rel="tag" href="/tags/%E7%AE%97%E6%B3%95/">ç®—æ³•</a><a class="link-muted mr-2" rel="tag" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">åˆ†å¸ƒå¼</a><a class="link-muted mr-2" rel="tag" href="/tags/%E4%B8%80%E8%87%B4%E6%80%A7%E5%8D%8F%E8%AE%AE/">ä¸€è‡´æ€§åè®®</a><a class="link-muted mr-2" rel="tag" href="/tags/%E5%AE%9E%E7%8E%B0/">å®ç°</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/11/07/%E3%80%90%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%9B%98%E3%80%91%E4%BA%91%E4%B8%8A%E5%BC%80%E5%8F%91%EF%BC%8C%E9%AB%98%E6%95%88%E6%99%BA%E8%83%BD%E2%80%93%E9%98%BF%E9%87%8C%E4%BA%91ECS%20Cloudbuild%E5%BC%80%E5%8F%91%E8%80%85%E5%A4%A7%E8%B5%9B%E6%80%A7%E8%83%BD%E6%8C%91%E6%88%98%E8%B5%9B%E9%81%93/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">ã€æ¯”èµ›å¤ç›˜ã€‘äº‘ä¸Šå¼€å‘ï¼Œé«˜æ•ˆæ™ºèƒ½â€“é˜¿é‡Œäº‘ECS Cloudbuildå¼€å‘è€…å¤§èµ›æ€§èƒ½æŒ‘æˆ˜èµ›é“</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/09/14/Icarus%E4%B8%BB%E9%A2%98%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/"><span class="level-item">Icarusä¸»é¢˜çš„ä¸€äº›å¸¸ç”¨é…ç½®</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/logo.jpg" alt="zhaommmmomo"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">zhaommmmomo</p><p class="is-size-6 is-block">fahaxiki!</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Yantai,China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">æ–‡ç« </p><a href="/archives"><p class="title">14</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">åˆ†ç±»</p><a href="/categories"><p class="title">18</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">æ ‡ç­¾</p><a href="/tags"><p class="title">21</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://zhaommmmomo.cn" target="_blank" rel="noopener">å…³æ³¨æˆ‘</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/zhaommmmomo"><i class="fab fa-github"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">ç›®å½•</h3><ul class="menu-list"><li><a class="level is-mobile" href="#å‰è¨€"><span class="level-left"><span class="level-item">1</span><span class="level-item">å‰è¨€</span></span></a></li><li><a class="level is-mobile" href="#Raft"><span class="level-left"><span class="level-item">2</span><span class="level-item">Raft</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#æ˜¯ä»€ä¹ˆï¼Ÿ"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">æ˜¯ä»€ä¹ˆï¼Ÿ</span></span></a></li><li><a class="level is-mobile" href="#çŠ¶æ€æœº"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">çŠ¶æ€æœº</span></span></a></li><li><a class="level is-mobile" href="#æ¦‚å¿µ"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">æ¦‚å¿µ</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#èŠ‚ç‚¹çŠ¶æ€"><span class="level-left"><span class="level-item">2.3.1</span><span class="level-item">èŠ‚ç‚¹çŠ¶æ€</span></span></a></li><li><a class="level is-mobile" href="#ä»»æœŸï¼ˆtermï¼‰"><span class="level-left"><span class="level-item">2.3.2</span><span class="level-item">ä»»æœŸï¼ˆtermï¼‰</span></span></a></li><li><a class="level is-mobile" href="#é€‰ä¸¾æ–¹æ³•ï¼ˆRequestVote-ï¼‰"><span class="level-left"><span class="level-item">2.3.3</span><span class="level-item">é€‰ä¸¾æ–¹æ³•ï¼ˆRequestVote()ï¼‰</span></span></a></li><li><a class="level is-mobile" href="#è¿½åŠ æ¡ç›®ï¼ˆAppendEntries-ï¼‰"><span class="level-left"><span class="level-item">2.3.4</span><span class="level-item">è¿½åŠ æ¡ç›®ï¼ˆAppendEntries()ï¼‰</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#å®ç°"><span class="level-left"><span class="level-item">3</span><span class="level-item">å®ç°</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#æ ¸å¿ƒç±»å›¾"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">æ ¸å¿ƒç±»å›¾</span></span></a></li><li><a class="level is-mobile" href="#æ ¸å¿ƒæ–¹æ³•"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">æ ¸å¿ƒæ–¹æ³•</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#requestVote"><span class="level-left"><span class="level-item">3.2.1</span><span class="level-item">requestVote()</span></span></a></li><li><a class="level is-mobile" href="#appendEntries"><span class="level-left"><span class="level-item">3.2.2</span><span class="level-item">appendEntries()</span></span></a></li><li><a class="level is-mobile" href="#sendCommand"><span class="level-left"><span class="level-item">3.2.3</span><span class="level-item">sendCommand()</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#å‚è€ƒèµ„æ–™"><span class="level-left"><span class="level-item">4</span><span class="level-item">å‚è€ƒèµ„æ–™</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.jpg" alt="zmm&#039;s blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 zhaommmmomo</span>Â Â <a target="_blank" rel="noopener" href="https://beian.miit.gov.cn">æ¹˜ICPå¤‡æ¡ˆ2021018362å·</a> Â Â  <a target="_blank" rel="noopener" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=43062302000147">æ¹˜å…¬ç½‘å®‰å¤‡43062302000147å·</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="GitHub" href="https://github.com/zhaommmmomo"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="å›åˆ°é¡¶ç«¯" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "æ­¤ç½‘ç«™ä½¿ç”¨Cookieæ¥æ”¹å–„æ‚¨çš„ä½“éªŒã€‚",
          dismiss: "çŸ¥é“äº†ï¼",
          allow: "å…è®¸ä½¿ç”¨Cookie",
          deny: "æ‹’ç»",
          link: "äº†è§£æ›´å¤š",
          policy: "Cookieæ”¿ç­–",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ..."></div><a class="searchbox-close" href="javascript:;">Ã—</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ...","untitled":"(æ— æ ‡é¢˜)","posts":"æ–‡ç« ","pages":"é¡µé¢","categories":"åˆ†ç±»","tags":"æ ‡ç­¾"});
        });</script></body></html>